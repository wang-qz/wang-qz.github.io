<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Redis"><meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="baidu-site-verification" content="code-Fqqme2bKQz"><title>Redis学习笔记2 | Crysw&#39;s Blog</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="/libs/artitalk/artitalk.min.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="Crysw's Blog" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><style>body{background-image:url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);background-repeat:no-repeat;background-size:cover;background-attachment:fixed}</style><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo" style="margin-left:-50px"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/guixinchn/image/blog/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">Crysw&#39;s Blog</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu" style="margin-left:100px"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-list" style="zoom:.6"></i> <span>清单</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/musics"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> <span>音乐</span></a></li><li><a href="/movies"><i class="fas fa-film" style="margin-top:-20px;zoom:.6"></i> <span>影集</span></a></li><li><a href="/wallpaper"><i class="fas fa-image" style="margin-top:-20px;zoom:.6"></i> <span>壁纸</span></a></li><li><a href="/galleries"><i class="fas fa-camera" style="margin-top:-20px;zoom:.6"></i> <span>相册</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-rocket" style="zoom:.6"></i> <span>关于</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/about"><i class="fas fa-user-circle" style="margin-top:-20px;zoom:.6"></i> <span>关于我</span></a></li><li><a target="_blank" rel="noopener" href="http://www.itsoku.com/"><i class="fab fa-github-alt" style="margin-top:-20px;zoom:.6"></i> <span>充电社</span></a></li><li><a href="/artitalk"><i class="fas fa-pen-alt" style="margin-top:-20px;zoom:.6"></i> <span>artitalk</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/navigate" class="waves-effect waves-light"><i class="fas fa-location-arrow" style="zoom:.6"></i> <span>快捷导航</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/atom.xml" class="waves-effect waves-light"><i class="fas fa-rss" style="zoom:.6"></i> <span>RSS</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/guixinchn/image/blog/logo.png" class="logo-img circle responsive-img"><div class="logo-name">Crysw&#39;s Blog</div><div class="logo-desc">本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> 清单 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/musics" style="margin-left:50px"><i class="fa fas fa-music" style="position:absolute;left:28px"></i> <span>音乐</span></a></li><li><a href="/movies" style="margin-left:50px"><i class="fa fas fa-film" style="position:absolute;left:28px"></i> <span>影集</span></a></li><li><a href="/wallpaper" style="margin-left:50px"><i class="fa fas fa-image" style="position:absolute;left:28px"></i> <span>壁纸</span></a></li><li><a href="/galleries" style="margin-left:50px"><i class="fa fas fa-camera" style="position:absolute;left:28px"></i> <span>相册</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-rocket"></i> 关于 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/about" style="margin-left:50px"><i class="fa fas fa-user-circle" style="position:absolute;left:28px"></i> <span>关于我</span></a></li><li><a target="_blank" rel="noopener" href="http://www.itsoku.com/" style="margin-left:50px"><i class="fa fab fa-github-alt" style="position:absolute;left:28px"></i> <span>充电社</span></a></li><li><a href="/artitalk" style="margin-left:50px"><i class="fa fas fa-pen-alt" style="position:absolute;left:28px"></i> <span>artitalk</span></a></li></ul></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="/navigate" class="waves-effect waves-light"><i class="fa-fw fas fa-location-arrow"></i> 快捷导航</a></li><li class="m-nav-item"><a href="/atom.xml" class="waves-effect waves-light"><i class="fa-fw fas fa-rss"></i> RSS</a></li><li><div class="divider"></div></li><li><a href="https://gitee.com/wang-qz/hexo-blog-crystal" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://gitee.com/wang-qz/hexo-blog-crystal" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="/libs/cryptojs/crypto-js.min.js"></script><script></script><div class="bg-cover pd-header post-cover" style="background-image:url(https://cn.bing.com/th?id=OHR.PandaDay_ZH-CN6584061291_1920x1080.jpg&rf=LaDigue_1920x1080.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Redis学习笔记2</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Redis/"><span class="chip bg-color">Redis</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/NoSQL/" class="post-category">NoSQL</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2022-03-20</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2022-03-23</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 23.1k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 91 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="1-Redis入门"><a href="#1-Redis入门" class="headerlink" title="1. Redis入门"></a>1. Redis入门</h2><h3 id="1-1-Redis简介"><a href="#1-1-Redis简介" class="headerlink" title="1.1 Redis简介"></a>1.1 Redis简介</h3><p>B站视频: <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1CJ411m7Gc?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click">Redis入门到精通，深入剖析Redis缓存技术，Java企业级解决方案必看的redis教程</a></p><h4 id="1-1-1-Redis引入"><a href="#1-1-1-Redis引入" class="headerlink" title="1.1.1 Redis引入"></a>1.1.1 Redis引入</h4><p>2007年10月30日, 北京奥运会门票面向公众第二阶段预售启动. 上午官方网站1h内的浏览量达到了800万次, 票务中心呼入量超过了380万人次. 由于瞬间访问数量过大, 技术系统应对不畅, 造成很多申购者无法及时提交申请.</p><p><strong>问题现象</strong></p><ul><li>海量用户</li><li>高并发</li></ul><p>罪魁祸首-关系型数据库</p><ul><li>性能瓶颈: 磁盘IO性能低下</li><li>扩展瓶颈: 数据关系复杂, 扩展性差, 不便于大规模集群</li></ul><p><strong>解决思路</strong></p><ul><li>降低磁盘IO次数, 越低越好 . — 内存存储</li><li>去除数据间关系, 越简单越好 . — 不存储关系, 仅存储数据</li></ul><h4 id="1-1-2-NoSQL"><a href="#1-1-2-NoSQL" class="headerlink" title="1.1.2 NoSQL"></a>1.1.2 NoSQL</h4><p>NoSQL, 即not-only SQL(泛指非关系型数据库), 作为关系型数据库的补充.</p><p>作用: 应对基于海量用户和海量数据前提下的数据处理问题.</p><p><strong>特征:</strong></p><ul><li>可扩容, 可伸缩</li><li>大数据量下高性能</li><li>灵活的数据模型</li><li>高可用</li></ul><p>常见NoSQL数据库</p><ul><li>Redis</li><li>memcache</li><li>HBase</li><li>MongoDB</li></ul><p><strong>解决方案(电商场景)</strong><br><img src="https://img-blog.csdnimg.cn/767e08dd94574dbaaf0eb45f0a3e47bc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="1-1-3-Redis概念"><a href="#1-1-3-Redis概念" class="headerlink" title="1.1.3 Redis概念"></a>1.1.3 Redis概念</h4><p>Redis(<strong>Remote Dictionary Server</strong>), 是用C语言开发的一个开源的高性能键值对(<strong>key-value</strong>)数据库.</p><p>特征:</p><ul><li>数据间没有必然的关联关系.</li><li>内部采用单线程机制进行工作</li><li>高性能. 官方提供测试数据, 50个并发执行10万个请求, 读的速度是11万次/s, 写的速度是8.1万次/s.</li><li>多数据类型支持(字符串string, 列表list, 集合set, 有序集合sorted Set)</li><li>持久化支持. 可以进行数据灾难恢复.</li></ul><h4 id="1-1-4-Redis应用"><a href="#1-1-4-Redis应用" class="headerlink" title="1.1.4 Redis应用"></a>1.1.4 Redis应用</h4><ul><li>为热点数据加速查询, 如热点商品, 热点新闻, 热点资讯等高访问量信息等;</li><li>任务队列, 如秒杀, 抢购, 购票排队等;</li><li>即时信息查询, 如排行榜, 网站访问统计, 在线人数(聊天室)等;</li><li>时效性信息控制, 如验证码, 股票控制等;</li><li>分布式数据共享, 如分布式集群架构中的session分离</li><li>消息队列</li><li>分布式锁</li></ul><h3 id="1-2-Redis下载与安装"><a href="#1-2-Redis下载与安装" class="headerlink" title="1.2 Redis下载与安装"></a>1.2 Redis下载与安装</h3><p>Linux版本(适用于企业级开发)</p><ul><li>Redis高级使用</li><li>以4.0及以上版本为主</li><li>Linux系统安装Redis： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xsge/p/13841875.html">https://www.cnblogs.com/xsge/p/13841875.html</a></li></ul><p>Windows版本(适合零基础学习)</p><ul><li>Redis入门</li><li>以3.2版本为主</li><li>Windows系统安装Redis：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26373925/article/details/109269459">https://blog.csdn.net/qq_26373925/article/details/109269459</a><br><img src="https://img-blog.csdnimg.cn/409c9c90e8bc4ec7a2535971a41a5eb5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></li></ul><h3 id="1-3-Redis的基本操作"><a href="#1-3-Redis的基本操作" class="headerlink" title="1.3 Redis的基本操作"></a>1.3 Redis的基本操作</h3><p>添加: set key value</p><p>获取: get key</p><p>帮助: help 命令, 例如 help get<br><img src="https://img-blog.csdnimg.cn/7f96ed64bb65420b8cef4d3f59db4afa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p>退出客户端: quit/exit/&lt;ESC&gt;</p><h2 id="2-数据类型"><a href="#2-数据类型" class="headerlink" title="2. 数据类型"></a>2. 数据类型</h2><h3 id="2-1-数据使用场景"><a href="#2-1-数据使用场景" class="headerlink" title="2.1 数据使用场景"></a>2.1 数据使用场景</h3><p>业务数据的特殊性, 作为缓存使用</p><ul><li>原始业务功能设计 (秒杀, 618活动, 双11活动, 12360排队购票)</li><li>运营平台监控到的突发高频访问数据 (突发时政要闻)</li><li>高频, 复杂的统计数据 (在线人数)</li></ul><p>附加功能, 系统功能优化或升级</p><ul><li>单机服务升级集群</li><li>session管理</li><li>token管理</li></ul><h3 id="2-2-数据存储格式"><a href="#2-2-数据存储格式" class="headerlink" title="2.2 数据存储格式"></a>2.2 数据存储格式</h3><p>redis自身是一个Map, 其中所有的数据都是采用<strong>key:value</strong>的形式存储, 最大存储512M数据.<br><img src="https://img-blog.csdnimg.cn/60193dd7499f45c2a6e74b15e9745b04.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>数据类型</strong>指的是<strong>存储的数据</strong>的类型, 也就是<strong>value部分</strong>的类型, key部分永远都是字符串类型.</p><h3 id="2-3-string"><a href="#2-3-string" class="headerlink" title="2.3 string"></a>2.3 string</h3><p>存储的数据: 单个数据, 最简单的数据存储类型, 也是最常用的数据存储类型.</p><p>存储数据的格式: 一个存储空间保存一个数据.</p><p>存储的内容: 通常使用字符串, 如果字符串以整数的形式展示, 可以作为数字操作使用.</p><h4 id="2-3-1-基本操作"><a href="#2-3-1-基本操作" class="headerlink" title="2.3.1 基本操作"></a>2.3.1 基本操作</h4><p>添加/修改数据: <code>set key value</code></p><p>获取数据: <code>get key</code></p><p>删除数据: <code>del key</code></p><p>添加/修改多个数据: <code>mset key1 value1 key2 value2...</code></p><p>获取多个数据: <code>mget key1 key2 ...</code></p><p>获取数据字符个数(字符串长度) : <code>strlen key</code></p><p>追加信息到原始信息后面: <code>append key value</code> (如果key存在就追加, 不存在则创建)</p><p>设置数据指定的生命周期: <code>setex key seconds value</code> , <code>psetex key millseconds value</code></p><p>查看指定key的剩余有效期: <code>ttl key</code></p><h4 id="2-3-2-业务场景1"><a href="#2-3-2-业务场景1" class="headerlink" title="2.3.2 业务场景1"></a>2.3.2 业务场景1</h4><hr><p>大型企业级应用中, 分表操作是基本操作, 使用多张表存储同类型数据, 但是对应的主键id必须保证统一性, 不能重复. oracle数据库具有sequence设定, 可以解决该问题, 但是MySql数据库并没有类似的机制, 如何解决.</p><p><strong>解决方案</strong></p><ul><li><p>设置数值数据增加指定范围的值</p><blockquote><p>incr key</p><p>incrby key increment</p><p>incrbyfloat key increment</p></blockquote></li><li><p>设置数值数据减少指定范围的值</p><blockquote><p>decr key</p><p>decrby key decrement</p></blockquote></li></ul><p><strong>string 作为数值操作</strong></p><ul><li>string在redis内部存储默认就是一个字符串, 当遇到增减操作incr, decr时会转换成数值进行计算.</li><li>redis所有的操作都是原子性的, 采用单线程处理所有业务, 命令是一个一个执行的, 因此无需考虑并发带来的数据影响.</li><li>注意, 按数值进行操作的数据, 如果原始数据不能转换成数值, 或超越了redis数值的上限范围, 将会报错. (最大值, Long类型的上限值. Long.MAX_VALUE)</li></ul><p><strong>Tips</strong></p><ul><li>redis用于控制数据库表主键id, 为数据库表主键提供生成策略, 保障数据库表的主键唯一性.</li><li>此方案适用于所有数据库, 且支持数据库集群.</li></ul><h4 id="2-3-3-业务场景2"><a href="#2-3-3-业务场景2" class="headerlink" title="2.3.3 业务场景2"></a>2.3.3 业务场景2</h4><p>主页高频访问信息显示控制, 例如新浪微博大V主页显示关注数, 粉丝数与微博数量.<br><img src="https://img-blog.csdnimg.cn/871c23da57bb4367a3964b802277a5a1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>解决方案</strong></p><p>(1) 在redis中为大V用户设定用户信息, 以<code>用户主键和属性值</code>作为key, 后台设定定时刷新策略即可.</p><p>关注数量: <code>user:id:3506728370:focus</code> &gt;&gt; 83</p><p>粉丝数量: <code>user:id:3506728370:fans</code> &gt;&gt; 12210947</p><p>微博数量: <code>user:id:3506728370:blogs</code> &gt;&gt; 6164</p><p>(2) 在redis中以<code>json格式</code>存储大V用户信息, 定时刷新.</p><pre class="language-json"><code class="language-json">`user<span class="token operator">:</span>id<span class="token operator">:</span><span class="token number">3506728370</span>`  <span class="token punctuation">{</span>id<span class="token operator">:</span><span class="token number">3506728370</span>  <span class="token punctuation">,</span>fans<span class="token operator">:</span><span class="token number">12210947</span> <span class="token punctuation">,</span>blogs<span class="token operator">:</span> <span class="token number">6164</span><span class="token punctuation">,</span> focus<span class="token operator">:</span> <span class="token number">83</span><span class="token punctuation">}</span>
</code></pre><p><strong>Tips</strong></p><p>redis应用于各种结构型和非结构型高热度数据访问加速.</p><p>数据库中的热点数据key命名惯例: <code>表名:主键名:主键值:字段属性名</code></p><h3 id="2-4-hash"><a href="#2-4-hash" class="headerlink" title="2.4 hash"></a>2.4 hash</h3><p>对象数据的存储如果发生比较频繁的更新操作, 如果使用上面的<code>表名:主键名:主键值:字段属性名</code>存string类型会显得比较笨重. 可以使用hash存储.</p><p>hash类型, 底层使用哈希表结构实现数据存储. 结构如下:<br><img src="https://img-blog.csdnimg.cn/50cac2dee4854d589ecec67848426941.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="2-4-1-基本操作"><a href="#2-4-1-基本操作" class="headerlink" title="2.4.1 基本操作"></a>2.4.1 基本操作</h4><p>添加/修改数据: <code>hset key field value</code></p><p>获取数据: <code>hget key field</code> , <code>hgetall key</code></p><p>删除数据: <code>hdel key field [field2]...</code></p><p>添加/修改多个数据: <code>hmset key field1 value1 field2 value2...</code></p><p>获取多个数据: <code>hmget key field1 field2...</code></p><p>获取哈希表字段的数量: <code>hlen key</code></p><p>获取哈希表中是否存在指定的字段: <code>hexists key field</code></p><p>获取哈希表中所有字段名或字段名: <code>hkeys key</code> , <code>hvals key</code></p><p>设置指定字段的数值数据增加指定范围的值: <code>hincrby key field increment</code> , <code>hincrbyfloat key field increment</code></p><h4 id="2-4-2-注意事项"><a href="#2-4-2-注意事项" class="headerlink" title="2.4.2 注意事项"></a>2.4.2 注意事项</h4><ul><li>hash类型的value只能存储字符串, 不允许存储其他数据类型, 不存在嵌套. 如果数据没有获取到, 对应的值为<code>nil</code>.</li><li>每个hash可以存储(2^32-1)个键值对.</li><li>hash类型十分贴近对象的数据存储形式, 并且可以灵活添加删除对象属性, 但hash设计初衷不是为了存储大量对象而设计的, 切记不可滥用, 更不可以将hash作为对象列表使用.</li><li><code>hgetall</code>操作可以获取全部属性, 如果内部field字段过多, 遍历整体数据效率就会很低, 有可能造成数据访问瓶颈.</li></ul><h4 id="2-4-3-业务场景1"><a href="#2-4-3-业务场景1" class="headerlink" title="2.4.3 业务场景1"></a>2.4.3 业务场景1</h4><p>redis应用于电商网站购物车设计实现.<br><img src="https://img-blog.csdnimg.cn/2e3fb84364f744d2815137918f8d1aec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p>以上仅仅是将数据存储到了redis中, 并没有起到加速的作用, 商品信息还需要二次查询数据库.<br><img src="https://img-blog.csdnimg.cn/1acb77309dd448efb0baf20bb9a708d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 003 表示购物车</span>
127.0.0.1:6379<span class="token operator">></span> hmset 003 g01:nums 100 g01:info <span class="token punctuation">{</span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>
OK
127.0.0.1:6379<span class="token operator">></span> hgetall 003
1<span class="token punctuation">)</span> <span class="token string">"g01:nums"</span>
2<span class="token punctuation">)</span> <span class="token string">"100"</span>
3<span class="token punctuation">)</span> <span class="token string">"g01:info"</span>
4<span class="token punctuation">)</span> <span class="token string">"{...}"</span>
127.0.0.1:6379<span class="token operator">></span> hmset 003 g02:nums 200 g02:info <span class="token punctuation">{</span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>
OK
127.0.0.1:6379<span class="token operator">></span> hgetall 003
1<span class="token punctuation">)</span> <span class="token string">"g01:nums"</span>
2<span class="token punctuation">)</span> <span class="token string">"200"</span>
3<span class="token punctuation">)</span> <span class="token string">"g01:info"</span>
4<span class="token punctuation">)</span> <span class="token string">"{...}"</span>
5<span class="token punctuation">)</span> <span class="token string">"g02:nums"</span>
6<span class="token punctuation">)</span> <span class="token string">"200"</span>
7<span class="token punctuation">)</span> <span class="token string">"g02:info"</span>
8<span class="token punctuation">)</span> <span class="token string">"{...}"</span>
127.0.0.1:6379<span class="token operator">></span>
</code></pre><h4 id="2-4-4-业务场景2"><a href="#2-4-4-业务场景2" class="headerlink" title="2.4.4 业务场景2"></a>2.4.4 业务场景2</h4><p>双11活动日, 销售手机充值卡的商家对移动, 联通, 电信的30元, 50元, 100元商品推出抢购活动, 每种商品抢购上限1000张.</p><p><strong>解决方案:</strong></p><ul><li>以商家id作为key</li><li>将参与抢购的商品id作为field</li><li>将参与抢购的商品数量作为对应的value</li><li>抢购时使用降值的方式控制产品数量</li><li>实际业务中还有超卖等实际问题, 后续讨论.</li></ul><p>p01表示商家ID, c30, c50, c100表示商品ID</p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> hmset p01 c30 1000 c50 1000 c100 1000
OK
127.0.0.1:6379<span class="token operator">></span> hgetall p01
1<span class="token punctuation">)</span> <span class="token string">"c30"</span>
2<span class="token punctuation">)</span> <span class="token string">"1000"</span>
3<span class="token punctuation">)</span> <span class="token string">"c50"</span>
4<span class="token punctuation">)</span> <span class="token string">"1000"</span>
5<span class="token punctuation">)</span> <span class="token string">"c100"</span>
6<span class="token punctuation">)</span> <span class="token string">"1000"</span>
127.0.0.1:6379<span class="token operator">></span> hincrby p01 c50 -1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 999
127.0.0.1:6379<span class="token operator">></span> hincrby p01 c100 -20
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 980
127.0.0.1:6379<span class="token operator">></span> hgetall p01
1<span class="token punctuation">)</span> <span class="token string">"c30"</span>
2<span class="token punctuation">)</span> <span class="token string">"1000"</span>
3<span class="token punctuation">)</span> <span class="token string">"c50"</span>
4<span class="token punctuation">)</span> <span class="token string">"999"</span>
5<span class="token punctuation">)</span> <span class="token string">"c100"</span>
6<span class="token punctuation">)</span> <span class="token string">"980"</span>
127.0.0.1:6379<span class="token operator">></span>
</code></pre><h3 id="2-5-list"><a href="#2-5-list" class="headerlink" title="2.5 list"></a>2.5 list</h3><p>存储多个数据, 并对数据进行<strong>存储空间的顺序</strong>进行区分;</p><p>一个存储空间保存多个数据, 且通过数据可以体现进入属性;</p><p>list可以保存多个数据, 底层使用双向链表存储结构实现.<br><img src="https://img-blog.csdnimg.cn/b265bd1e02434d9b915d1da3189f1b34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="2-5-1-基本操作"><a href="#2-5-1-基本操作" class="headerlink" title="2.5.1 基本操作"></a>2.5.1 基本操作</h4><p>应用于具有操作先后顺序的数据控制.</p><p>添加/修改操作: <code>lpush key value1 [value2]...</code> , <code>rpush key value1 [value2]...</code></p><p>获取数据: <code>lrange key start stop</code> , <code>lindex key index</code> , <code>llen key</code></p><p>获取并移除数据: <code>lpop key</code> , <code>rpop key</code></p><p>规定时间内获取并移除数据 (阻塞): <code>blpop key1 [key2] timeout</code> , <code>brpop key1 [key2] timeout</code></p><p>移除指定数据: <code>lrem key count value</code></p><h4 id="2-5-2-注意事项"><a href="#2-5-2-注意事项" class="headerlink" title="2.5.2 注意事项"></a>2.5.2 注意事项</h4><ul><li>list中保存的数据都是string类型的, 数据总容量是有限的, 最多(2^32-1)个元素.</li><li>list具有索引的概念, 但是操作数据时通常以队列的形式进行入队出队操作, 或以栈的形式入栈出栈操作.</li><li>获取全部数据操作结束索引设置为 -1 . 比如: <code>lrange key 0 -1</code></li><li>list可以对数据进行分页操作, 通常第一页的信息来自于list, 第二页及更多的信息通过数据库的形式加载.</li></ul><h4 id="2-5-3-业务场景1"><a href="#2-5-3-业务场景1" class="headerlink" title="2.5.3 业务场景1"></a>2.5.3 业务场景1</h4><p>微信朋友圈点赞, 要求按照点赞顺序显示点赞好友信息.</p><p>如果取消点赞, 移除对应好友信息. (lrem )<br><img src="https://img-blog.csdnimg.cn/315609f19d564ccbb88d15eca0667222.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_17,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="2-5-4-业务场景2"><a href="#2-5-4-业务场景2" class="headerlink" title="2.5.4 业务场景2"></a>2.5.4 业务场景2</h4><ul><li>twitter, 新浪微博, 腾讯微博中个人用户的关注列表需要按照用户的关注顺序进行展示, 粉丝列表需要将最近关注的粉丝列在最前面.</li><li>新闻, 资讯类网站如何将最新的新闻或资讯按照发生的时间顺序展示?</li><li>企业运营过程中, 系统将产生出大量的运营数据, 如何保障多台服务器操作日志的统一顺序输出?</li></ul><p><strong>解决方案:</strong></p><ul><li>依赖<code>list</code>的数据具有顺序的特征对信息进行管理</li><li>使用队列模型解决多路信息汇总合并的问题</li><li>使用栈模型解决最新消息的问题</li></ul><h3 id="2-6-set"><a href="#2-6-set" class="headerlink" title="2.6 set"></a>2.6 set</h3><p>能够存储大量的数据, 高效的内部存储机制, 提供更高的查询效率.</p><p>与hash存储结构完全相同, 仅存储键, 不存储值(nil), 并且不允许键重复.<br><img src="https://img-blog.csdnimg.cn/528f914465194affb5b82afed3b2566f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="2-6-1-基本操作"><a href="#2-6-1-基本操作" class="headerlink" title="2.6.1 基本操作"></a>2.6.1 基本操作</h4><p>添加数据: <code>sadd key member1 [member2]</code></p><p>获取全部数据: <code>smembers key</code></p><p>删除数据: <code>srem key member1 [member2]</code></p><p>获取集合长度: <code>scard key</code></p><p>判断集合中是否包含指定数据: <code>sismember key member</code></p><p>随机获取集合中指定数量的数据: <code>srandmember key [count]</code></p><p>随机获取集合中的某个数据并将该数据移除集合: <code>spop key</code></p><p>求两个集合的交,并,差集:<br><code>sinter key1 [key2]</code><br><code>sunion key1 [key2]</code><br><code>sdiff key1 [key2]</code></p><p>求两个集合的交,并,差集并存储到指定集合中:<br><code>sinterstore destination key1 [key2]</code><br><code>sunionstore destination key1 [key2]</code><br><code>sdiffstore destination key1 [key2]</code></p><p>将指定数据从原始集合中移动到目标集合中: <code>smove source destination member</code></p><h4 id="2-6-2-注意事项"><a href="#2-6-2-注意事项" class="headerlink" title="2.6.2 注意事项"></a>2.6.2 注意事项</h4><ul><li>set类型不允许数据重复, 如果添加的数据在set中已经存在,将只保留一份;</li><li>set虽然与hash的存储结构相同, 但是无法启用hash中存储值的空间.</li></ul><h4 id="2-6-3-业务场景1"><a href="#2-6-3-业务场景1" class="headerlink" title="2.6.3 业务场景1"></a>2.6.3 业务场景1</h4><p>每位用户首次使用今日头条时会设置3项爱好的内容, 但是后期为了增加用户的活跃度, 兴趣点, 必须让用户对其他信息类别逐渐产生兴趣, 增加用户留存度, 如何实现?</p><p>业务分析:</p><ul><li>系统分析出各个分类的最新或最热点信息条目并组织成set集合</li><li>随机挑选其中部分信息( <strong>srandmember , spop</strong> )</li><li>配合用户关注信息分类中的热点信息组织成展示的全部信息集合</li></ul><p><strong>Tips:</strong></p><p>redis应用于随机推荐类信息检索, 例如热点歌单推荐, 热点新闻推荐, 应用app推荐, 大v推荐等.</p><h4 id="2-6-4-业务场景2"><a href="#2-6-4-业务场景2" class="headerlink" title="2.6.4 业务场景2"></a>2.6.4 业务场景2</h4><p><img src="https://img-blog.csdnimg.cn/7ed56f6e12934d5bb6976d4f3cbb987d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>分析:</strong></p><p>使用set的获取交集, 并集, 差集的方案实现.</p><p><strong>Tips:</strong></p><ul><li>redis应用于同类信息的关联搜索, 二度关联搜索, 深度关联搜索</li><li>显示共同关注(一度)</li><li>显示共同好友(一度)</li><li>由用户A出发, 获取到好友用户B的好友信息列表(一度)</li><li>由用户A出发, 获取到好友用户B的购物清单列表(二度)</li><li>由用户A出发, 获取到好友用户B的游戏充值列表(二度)</li></ul><h4 id="2-6-5-业务场景3"><a href="#2-6-5-业务场景3" class="headerlink" title="2.6.5 业务场景3"></a>2.6.5 业务场景3</h4><p>集团公司共有12000名员工, 内部OA系统中具有700多个角色, 3000多个业务操作, 23000多种数据, 每位员工具有<strong>一个或多个角色</strong>, 如何快速进行业务操作的权限校验?<br><img src="https://img-blog.csdnimg.cn/5f1cdf348e2947559e52a0d1dbcc3045.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>解决方案:</strong></p><ul><li>依赖set集合数据不重复的特征, 依赖set集合hash存储结构特征完成数据过滤与快速查询</li><li>根据用户id获取用户所有角色</li><li>根据用户所有角色获取用户所有操作权限放入set集合</li><li>根据用户所有角色获取用户所有数据全部放入set集合</li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> sadd rid:001 getall
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sadd rid:001 getById
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sadd rid:002 getall
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sadd rid:002 insert
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sunionstore uid:007 rid:001 rid:002
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> smembers uid:007  <span class="token comment" spellcheck="true"># redis提供基础数据</span>
1<span class="token punctuation">)</span> <span class="token string">"insert"</span>
2<span class="token punctuation">)</span> <span class="token string">"getById"</span>
3<span class="token punctuation">)</span> <span class="token string">"getall"</span>
127.0.0.1:6379<span class="token operator">></span> sismember uid:007 insert  <span class="token comment" spellcheck="true"># redis提供校验结果</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
</code></pre><p>校验工作: redis提供基础数据还是提供校验结果? 推荐使用redis提供基础数据, 因为校验使用redis会造成业务与redis耦合, 侵入性增强了.</p><p><strong>Tips:</strong></p><p>redis应用于同类型不重复数据的合并操作</p><h4 id="2-6-6-业务场景4"><a href="#2-6-6-业务场景4" class="headerlink" title="2.6.6 业务场景4"></a>2.6.6 业务场景4</h4><p>公司对旗下新的网站做推广, 统计网站的PV(访问量), UV(独立访客), IP(独立IP).</p><p>PV: 网站被访问次数, 可通过刷新页面提高访问量.</p><p>UV: 网站被不同用户访问的次数, 可通过cookie统计访问量, 相同用户切换IP地址, UV不变.</p><p>IP: 网站被不同IP地址访问的总次数, 可通过IP地址统计访问量, 相同IP不同用户访问, IP不变.</p><p><strong>解决方案:</strong></p><ul><li>利用set集合的数据不重复特征, 记录各种访问数据.</li><li>建立string类型数据, 利用incr统计日访问量(PV)</li><li>建立set模型, 记录不同cookie数量(UV)</li><li>建立set模型, 记录不同IP数量(IP)</li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> sadd ips 1.2.3.4
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sadd ips 2.3.4.5
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> sadd ips 2.3.4.5
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> scard ips
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
</code></pre><p><strong>Tips:</strong></p><p>redis应用于同类型数据的快速去重, 进行数据过滤.</p><h4 id="2-6-7-业务场景5"><a href="#2-6-7-业务场景5" class="headerlink" title="2.6.7 业务场景5"></a>2.6.7 业务场景5</h4><p>系统黑名单, 白名单.</p><p><strong>解决方案:</strong></p><ul><li>基于经营战略设定问题用户发现, 鉴别规则</li><li>周期性更新满足规则的用户黑名单, 加入set集合</li><li>用户行为信息到达后与黑名单进行比对, 确认行为去向</li><li>黑名单过滤IP地址, 应用于开放游客访问权限的信息源</li><li>黑名单过滤设备信息, 应用于限定访问设备的信息源</li><li>黑名单过滤用户, 应用于基于访问权限的信息源</li></ul><p><strong>Tips:</strong></p><p>redis应用于基于黑名单与白名单设定的服务控制.</p><h3 id="2-7-sorted-set"><a href="#2-7-sorted-set" class="headerlink" title="2.7 sorted set"></a>2.7 sorted set</h3><p>数据排序有利于数据的有效展示, 需要提供一种可以根据自身特征进行排序的方式.</p><p>新的存储模型, 在set的存储结构基础上添加可排序字段, 用来保存可排序的数据.</p><p>score不是真正的数据, 而是辅助排序的定义, 真正的业务数据在key中.<br><img src="https://img-blog.csdnimg.cn/e73cb876bfc44a0f8d05e9397100407e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="2-7-1-基本操作"><a href="#2-7-1-基本操作" class="headerlink" title="2.7.1 基本操作"></a>2.7.1 基本操作</h4><p>添加数据: <code>zadd key score1 member1 [score2 member2]</code></p><p>获取全部数据:<br><code>zrange key start stop [withscore]</code><br><code>zrevrange key start stop [withscore]</code></p><p>删除数据: <code>zrem key member [member2...]</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zadd scores 94 zhangsan 100 lisi 60 wangwu 47 zhaoliu
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 4
127.0.0.1:6379<span class="token operator">></span> zrange scores 0 -1
1<span class="token punctuation">)</span> <span class="token string">"zhaoliu"</span>
2<span class="token punctuation">)</span> <span class="token string">"wangwu"</span>
3<span class="token punctuation">)</span> <span class="token string">"zhangsan"</span>
4<span class="token punctuation">)</span> <span class="token string">"lisi"</span>
127.0.0.1:6379<span class="token operator">></span> zrange scores 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"zhaoliu"</span>
2<span class="token punctuation">)</span> <span class="token string">"47"</span>
3<span class="token punctuation">)</span> <span class="token string">"wangwu"</span>
4<span class="token punctuation">)</span> <span class="token string">"60"</span>
5<span class="token punctuation">)</span> <span class="token string">"zhangsan"</span>
6<span class="token punctuation">)</span> <span class="token string">"94"</span>
7<span class="token punctuation">)</span> <span class="token string">"lisi"</span>
8<span class="token punctuation">)</span> <span class="token string">"100"</span>
</code></pre><p>按条件获取数据:<br><code>zrangebyscore key min max [withscore] [limit]</code><br><code>zrevrangebyscore key max min [withscores]</code></p><p>按条件删除数据:<br><code>zremrangebyrank key start stop</code><br><code>zremrangebyscore key min max</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zrangebyscore scores 50 99  limit 0 3 withscores
1<span class="token punctuation">)</span> <span class="token string">"wangwu"</span>
2<span class="token punctuation">)</span> <span class="token string">"60"</span>
3<span class="token punctuation">)</span> <span class="token string">"zhangsan"</span>
4<span class="token punctuation">)</span> <span class="token string">"94"</span>
127.0.0.1:6379<span class="token operator">></span> zremrangebyrank scores 0 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127.0.0.1:6379<span class="token operator">></span> zrange scores 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"zhangsan"</span>
2<span class="token punctuation">)</span> <span class="token string">"94"</span>
3<span class="token punctuation">)</span> <span class="token string">"lisi"</span>
4<span class="token punctuation">)</span> <span class="token string">"100"</span>
</code></pre><p><strong>注意:</strong></p><ul><li>min与max用于限定搜索查询的条件</li><li>start与stop用于限定查询范围, 作用于索引, 表示开始和结束索引</li><li>offset与count用于限定查询范围, 作用于查询结果, 表示开始位置和数据总量</li></ul><p>获取集合数据总量:<br><code>zcard key</code><br><code>zcount key min max</code></p><p>集合交, 并集操作:<br><code>zinterstore destination numkeys key [key...]</code><br><code>zunionstore destination numkeys key [key...]</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zadd s1 50 aa 60 bb 70 cc
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> zadd s2 60 aa 40 bb 90 <span class="token function">dd</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> zadd s3 70 aa 20 bb 100 <span class="token function">dd</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> zinterstore ss 3 s1 s2 s3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127.0.0.1:6379<span class="token operator">></span> zrange ss 0 -1 withscores <span class="token comment" spellcheck="true">### 求交集后, 重复的member分数会求和</span>
1<span class="token punctuation">)</span> <span class="token string">"bb"</span>
2<span class="token punctuation">)</span> <span class="token string">"120"</span>
3<span class="token punctuation">)</span> <span class="token string">"aa"</span>
4<span class="token punctuation">)</span> <span class="token string">"180"</span>
</code></pre><h4 id="2-7-2-注意事项"><a href="#2-7-2-注意事项" class="headerlink" title="2.7.2 注意事项"></a>2.7.2 注意事项</h4><ul><li><p>score保存的数据存储空间是64位.</p></li><li><p>score保存的数据也可以是一个双精度的double值, 基于双精度浮点数的特征, 可能会丢失精度, 使用时要慎重.</p></li><li><p>zset底层存储还是基于set结构的, 因此数据不能重复, 如果重复添加相同的数据, score值将被反复覆盖, 保留最后一次修改的结果</p><blockquote><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zrange <span class="token function">test</span> 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"aa"</span>
2<span class="token punctuation">)</span> <span class="token string">"11"</span>
127.0.0.1:6379<span class="token operator">></span> zadd <span class="token function">test</span> 22 aa
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> zrange <span class="token function">test</span> 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"aa"</span>
2<span class="token punctuation">)</span> <span class="token string">"22"</span>
</code></pre></blockquote></li></ul><h4 id="2-7-3-业务场景1"><a href="#2-7-3-业务场景1" class="headerlink" title="2.7.3 业务场景1"></a>2.7.3 业务场景1</h4><p>票选广东十大杰出青年, 各类综艺选秀投票.</p><p>各类资源网站TOP10(电影, 歌曲,文档, 游戏等)</p><p>聊天室活跃度统计.</p><p>游戏好友亲密度.</p><p><strong>分析:</strong></p><ul><li>为所有参与排名的资源建立排序依据</li></ul><p><strong>解决方案:</strong></p><p>获取数据对应的索引(排名):<br><code>zrank key member</code><br><code>zrevrank key member</code></p><p>score值获取与修改:<br><code>zscore key member</code><br><code>zincrby key increment member</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zadd movies 143 aa 97 bb 201 cc
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> zrank movies bb
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> zrevrank movies bb
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127.0.0.1:6379<span class="token operator">></span> zscore movies bb
<span class="token string">"97"</span>
</code></pre><p><strong>Tips:</strong></p><p>redis应用于计数器组合排序功能对应的排名</p><h4 id="2-7-4-业务场景2"><a href="#2-7-4-业务场景2" class="headerlink" title="2.7.4 业务场景2"></a>2.7.4 业务场景2</h4><p>基础服务 + 增值服务类网站会设定各位会员的试用 , 让用户充分体验会员优势. 例如观影试用VIP, 游戏VIP体验, 云盘下载体验VIP, 数据查看体验VIP. 当VIP体验到期后, 如果有效管理此类信息, 即便对于正式VIP用户也存在对应的管理方式.</p><p>网站会定期开启投票, 讨论, 限时进行, 预期作废. 如何有效管理此类过期信息.</p><p><strong>解决方案:</strong></p><ul><li><p>对于基于时间线限定的任务处理, 将处理时间记录位score值, 利用排序功能区分处理的先后顺序.</p></li><li><p>记录下一个要处理的时间, 当到期后处理对应的任务, 移除redis中的记录, 并记录下一个要处理的时间.</p></li><li><p>当新任务加入时, 判定并更新当前下一个要处理的任务时间</p></li><li><p>为提升zset的性能, 通常将任务根据特征存储成若干个zset, 例如1小时内, 1天内, 周内, 月内, 季内, 年度等, 操作时逐级提升, 将即将操作的若干个任务纳入到1小时内处理的队列中.</p></li><li><p>获取当前系统时间 <code>time</code></p></li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zadd ts 1509802345 uid:001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> zadd ts 1509802390 uid:007
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> zadd ts 1509802365 uid:088
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> zrange ts 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"uid:001"</span>
2<span class="token punctuation">)</span> <span class="token string">"1509802345"</span>
3<span class="token punctuation">)</span> <span class="token string">"uid:088"</span>
4<span class="token punctuation">)</span> <span class="token string">"1509802365"</span>
5<span class="token punctuation">)</span> <span class="token string">"uid:007"</span>
6<span class="token punctuation">)</span> <span class="token string">"1509802390"</span>
127.0.0.1:6379<span class="token operator">></span> <span class="token function">time</span>
1<span class="token punctuation">)</span> <span class="token string">"1646835417"</span>
2<span class="token punctuation">)</span> <span class="token string">"261374"</span>
</code></pre><p><strong>Tips:</strong></p><p>redis应用于定时任务执行顺序管理或任务过期管理.</p><h4 id="2-7-5-业务场景3"><a href="#2-7-5-业务场景3" class="headerlink" title="2.7.5 业务场景3"></a>2.7.5 业务场景3</h4><p>任务/消息权重设定应用.</p><p>当任务或者消息待处理, 形成了任务队列或消息队列时, 对于高优先级的任务要保障对其优先处理, 如何实现任务权重管理呢?</p><p><strong>解决方案:</strong></p><ul><li><p>对于带有权重的任务, 优先处理权重高的任务, 采用score记录权重即可.</p><p>多条件任务权重设定. 如果权重条件过多时, 需要对排序score值进行处理, 保障score值能够兼容2条件或多条件, 例如外贸订单优先于国内订单, 总裁订单优先于员工订单, 经理订单优先于员工订单.</p></li><li><p>因score长度受限, 需要对数据进行截断处理, 尤其是时间设置为小时或分钟级即可.(折算后)</p></li><li><p>先设定订单类别, 后设定订单发起角色类别, 整体score长度必须是统一的, 不足位补0. 第一排序规则首位不得是0.</p><ul><li>例如外贸101, 国内102, 经理004, 员工008</li><li>员工下的外贸单score值为101008(优先)</li><li>经理下的国内单score值为102004</li></ul></li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> zadd tt 102004 order:id:1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> zadd tt 101008 order:id:2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> zrange tt 0 -1 withscores
1<span class="token punctuation">)</span> <span class="token string">"order:id:2"</span>
2<span class="token punctuation">)</span> <span class="token string">"101008"</span>
3<span class="token punctuation">)</span> <span class="token string">"order:id:1"</span>
4<span class="token punctuation">)</span> <span class="token string">"102004"</span>
</code></pre><p><strong>Tips:</strong></p><p>redis应用于即时任务/消息队列执行管理.</p><h3 id="2-8-实践案例"><a href="#2-8-实践案例" class="headerlink" title="2.8 实践案例"></a>2.8 实践案例</h3><h4 id="2-8-1-案例1"><a href="#2-8-1-案例1" class="headerlink" title="2.8.1 案例1"></a>2.8.1 案例1</h4><p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术, 百度自研用户评价语义识别服务, 免费开放企业试用, 同时训练百度自己的模型, 现对试用用户的使用行为进行限速, 限制每个用户每分钟最多发起10次调用.</p><p><strong>解决方案:</strong></p><ul><li>设计计数器, 记录调用次数, 用于控制业务执行次数, 以用户ID作为key, 使用次数作为value.</li><li>在调用前获取次数, 判断是否超过限定次数<ul><li>不超过次数的情况下, 每次调用计数 +1</li><li>业务调用失败, 计数 -1</li></ul></li><li>为计数器设置生命周期为指定周期, 例如 1秒/分钟, 自动清空周期内使用次数.</li></ul><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8x1zqxTO-1647738351020)(C:\Users\18482\AppData\Roaming\Typora\typora-user-images\image-20220310214111500.png)]</p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> get 415 <span class="token comment" spellcheck="true"># 415为用户ID</span>
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
127.0.0.1:6379<span class="token operator">></span> setex 415 60 1
OK
127.0.0.1:6379<span class="token operator">></span> get 415
<span class="token string">"1"</span>
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127.0.0.1:6379<span class="token operator">></span> get 415
<span class="token string">"2"</span>
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
</code></pre><p><strong>方案改进:</strong></p><ul><li>取消最大值的判断, 利用incr操作超过最大值抛出异常的形式替代每次判断是否大于最大值</li><li>判断是否为<code>nil</code><ul><li>如果是, 设置Max-次数</li><li>如果不是, 计数+1</li><li>业务调用失败, 计数-1</li></ul></li><li>遇到异常, 即操作(+)超过上限, 视为使用达到上限.</li></ul><p><img src="https://img-blog.csdnimg.cn/9b7bd4e13d694b13bafb6616dc859031.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"><br>操作实现</p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> get 415
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
127.0.0.1:6379<span class="token operator">></span> setex 415 60 9223372036854775797 <span class="token comment" spellcheck="true"># 设置上限-10</span>
OK
127.0.0.1:6379<span class="token operator">></span> get 415
<span class="token string">"9223372036854775797"</span>
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775798
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775799
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775800
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775801
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775802
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775803
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775804
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775805
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775806
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9223372036854775807
127.0.0.1:6379<span class="token operator">></span> incr 415
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR increment or decrement would overflow <span class="token comment" spellcheck="true"># 10次后, 超过上限, 抛出异常</span>
</code></pre><h4 id="2-8-2-案例2"><a href="#2-8-2-案例2" class="headerlink" title="2.8.2 案例2"></a>2.8.2 案例2</h4><p>使用微信的过程中, 当微信接收消息后, 会默认将最近接收的消息置顶, 当多个好友及关注的订阅号同时发送消息时, 该排序会不停的进行交替, 同时还可以将重要的会话设置为置顶. 一旦用户离线后, 再次打开微信时, 消息该按照什么顺序展示呢?</p><p><strong>业务分析</strong><br><img src="https://img-blog.csdnimg.cn/1a238ce8d20a4f7381b79fe3d623737e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>解决方案</strong></p><ul><li>依赖<code>list</code>的数据具有顺序的特征对消息进行管理, 将<code>list</code>结构作为栈使用.</li><li>对置顶与普通会话分别创建独立的 list 分别管理</li><li>当某个 list 中接收到用户消息后, 将消息发送方的ID从 list 的一侧加入(此处设定在左侧)</li><li>多个相同ID发出的消息反复入栈会出现问题, 在入栈前无论是否具有当前ID对应的消息, 先删除对应ID.</li><li>推送消息时先推送置顶会话 list, 再推送普通会话 list, 推送完成的 list 清除所有数据.</li><li>消息的数量, 也就是微信用户对话数量采用计数器的思想另行记录, 伴随 list 操作同步更新.</li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> lrem id:100 1 200
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> lpush id:100 200
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> lrem id:100 1 300
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> lpush id:100 300
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127.0.0.1:6379<span class="token operator">></span> lrem id:100 1 400
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> lpush id:100 400
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> lrem id:100 1 200
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> lpush id:100 200
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> lrem id:100 1 300
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> lpush id:100 300
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127.0.0.1:6379<span class="token operator">></span> lrange id:100 0 -1 <span class="token comment" spellcheck="true"># 最后消息展示顺序, 400 200 300</span>
1<span class="token punctuation">)</span> <span class="token string">"300"</span>
2<span class="token punctuation">)</span> <span class="token string">"200"</span>
3<span class="token punctuation">)</span> <span class="token string">"400"</span>
</code></pre><h3 id="2-9-key通用操作"><a href="#2-9-key通用操作" class="headerlink" title="2.9 key通用操作"></a>2.9 key通用操作</h3><p><strong>基本操作</strong></p><p>删除指定key : <code>del key</code></p><p>获取key是否存在: <code>exists key</code></p><p>获取key的类型: <code>type key</code></p><p>查询key : <code>keys pattern</code> ( * 匹配任意数量的任意符号, ? 匹配一个任意符号 []匹配一个指定符号)</p><p>为key改名: <code>rename key newkey</code> , <code>renamenx key newkey</code></p><p>对所有key排序(list列表): <code>sort [desc]</code></p><p>其他key通用操作: <code>help @generic</code></p><p><strong>扩展操作(时效性控制):</strong></p><p>为指定key设置有效期</p><pre class="language-bash"><code class="language-bash">expire key seconds
pexpire key millseconds
expireat key timestamp
pexpireat key millseconds-timestamp
</code></pre><p>获取key的有效时间</p><pre class="language-bash"><code class="language-bash">ttl key
pttl key
</code></pre><p>切换key从时效性转换为永久性</p><pre class="language-bash"><code class="language-bash">persist key
</code></pre><h3 id="2-10-数据库通用操作"><a href="#2-10-数据库通用操作" class="headerlink" title="2.10 数据库通用操作"></a>2.10 数据库通用操作</h3><p><img src="https://img-blog.csdnimg.cn/e5d2834ab89a4b12981806dc6e3d9976.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>db基本操作指令</strong></p><p>切换数据库: <code>select index</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">select</span> 1
OK
127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> 15
OK
</code></pre><p>其他操作</p><pre class="language-bash"><code class="language-bash">quit
<span class="token function">ping</span>
<span class="token keyword">echo</span> message
</code></pre><p>数据移动 : <code>move key db</code></p><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name crysw
OK
127.0.0.1:6379<span class="token operator">></span> get name
<span class="token string">"crysw"</span>
127.0.0.1:6379<span class="token operator">></span> move name 1  <span class="token comment" spellcheck="true"># 如果1库有name, 会移动失败</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> get name
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">select</span> 1
OK
127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> get name
<span class="token string">"crysw"</span>
127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> 0
OK
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name panda
OK
127.0.0.1:6379<span class="token operator">></span> move name 1 <span class="token comment" spellcheck="true"># 返回0,移动失败</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0 
</code></pre><p>数据清除(慎用)</p><pre class="language-bash"><code class="language-bash">dbsize <span class="token comment" spellcheck="true"># 当前db中的key数量</span>
flushdb
flushall
</code></pre><h2 id="3-Jedis"><a href="#3-Jedis" class="headerlink" title="3. Jedis"></a>3. Jedis</h2><h3 id="3-1-Jedis简介"><a href="#3-1-Jedis简介" class="headerlink" title="3.1 Jedis简介"></a>3.1 Jedis简介</h3><p>操作redis的java客户端, Jedis的api使用和redis的操作指令完全一样.</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre><h3 id="3-2-Jedis简单测试"><a href="#3-2-Jedis简单测试" class="headerlink" title="3.2 Jedis简单测试"></a>3.2 Jedis简单测试</h3><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1.连接redis</span>
    Jedis jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 2. 操作redis</span>
    jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">" crysw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name="</span> <span class="token operator">+</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ping="</span> <span class="token operator">+</span> jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 关闭连接</span>
    jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="3-3-Jedis简易工具类开发"><a href="#3-3-Jedis简易工具类开发" class="headerlink" title="3.3 Jedis简易工具类开发"></a>3.3 Jedis简易工具类开发</h3><p><strong>JedisConfig配置类</strong></p><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.host}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String host<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.password}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.timeout}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.jedis.pool.max-active}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxActive<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.jedis.pool.max-idle}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxIdle<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.jedis.pool.min-idle}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.jedis.pool.max-wait}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxWaitMillSeconds<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> JedisPool <span class="token function">jedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        JedisPoolConfig jedisPoolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span>minIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span>maxWaitMillSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        JedisPool jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>jedisPoolConfig<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"JedisPool连接成功: {}:{}"</span><span class="token punctuation">,</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> jedisPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Jedis工具类</strong></p><pre class="language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 类描述：Jedis工具类
 * @author crys
 * @date 2022/1/20 21:48
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisUtils</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> JedisPool jedisPool<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.redis.password}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 获取Jedis资源
     * @return
     */</span>
    <span class="token keyword">public</span> Jedis <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jedis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 关闭jedis连接
     * @param jedis
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span>Jedis jedis<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis<span class="token operator">!=</span>null<span class="token punctuation">)</span> jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 为什么要封装工具类? Redis有很多指令, Jedis操作它需要针对业务场景做方法封装</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calcTimeHour</span><span class="token punctuation">(</span><span class="token keyword">int</span> hours<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> seconds <span class="token operator">=</span> hours<span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  seconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="3-4-可视化客户端"><a href="#3-4-可视化客户端" class="headerlink" title="3.4 可视化客户端"></a>3.4 可视化客户端</h3><p>远程连接, 使用RedisDesktopManager, 目前已经收费.</p><p><a target="_blank" rel="noopener" href="https://quick123.net/">免费的redis可视化软件下载</a></p><p>推荐一款新的免费客户端: <a target="_blank" rel="noopener" href="https://gitee.com/qishibo/AnotherRedisDesktopManager">https://gitee.com/qishibo/AnotherRedisDesktopManager</a></p><p>默认不允许远程连接, 需要修改信息才允许进行连接.</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 注释掉, 允许本机以外的其他机器访问redis服务</span>
<span class="token comment" spellcheck="true">#bind 127.0.0.1 ::1</span>
<span class="token comment" spellcheck="true"># 设置数据库密码</span>
requirepass 123456 
</code></pre><h3 id="3-5-案例-服务调用次数控制"><a href="#3-5-案例-服务调用次数控制" class="headerlink" title="3.5 案例: 服务调用次数控制"></a>3.5 案例: 服务调用次数控制</h3><p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术, 百度自研用户评价语义识别服务, 免费开放企业试用, 同时训练百度自己的模型, 现对试用用户的使用行为进行限速, 限制每个用户每分钟最多发起10次调用.</p><p><strong>案例要求:</strong></p><p>(1) 设定A, B ,C 三个用户</p><p>(2) A用户限制10次/分调用, B用户限制30次/分调用, C用户不限制.</p><p><strong>需求分析:</strong></p><ul><li>设定一个服务方法, 用于模拟实际业务调用的服务, 内部采用打印模拟调用</li><li>在业务调用前服务调用控制单元, 内部使用redis进行控制, 参照之前的方案</li><li>对调用超限使用异常进行控制, 异常处理设定为打印提升信息</li><li>主程序启动3个线程, 分别表示3种不同用户的调用</li></ul><p><strong>代码实现</strong></p><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaiduServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BaiduService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> JedisUtils jedisUtils<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 业务操作</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business</span><span class="token punctuation">(</span>String level<span class="token punctuation">,</span><span class="token keyword">long</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户"</span><span class="token operator">+</span>level<span class="token operator">+</span><span class="token string">": 业务操作执行第"</span><span class="token operator">+</span>num<span class="token operator">+</span><span class="token string">"次"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 控制单元</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">control</span><span class="token punctuation">(</span>String level<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        Jedis jedis <span class="token operator">=</span> jedisUtils<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String key <span class="token operator">=</span> <span class="token string">"compid:"</span> <span class="token operator">+</span> level<span class="token punctuation">;</span>
        String value <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 判断该值是否存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token operator">==</span>null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 不存在, 创建该值</span>
                jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>MAX_VALUE<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 存在, 自增, 调用业务</span>
                Long incr <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">business</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span>num<span class="token operator">-</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span>MAX_VALUE<span class="token operator">-</span>incr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JedisDataException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户"</span><span class="token operator">+</span>level<span class="token operator">+</span><span class="token string">"使用已经达到次数上限,请升级会员级别"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>测试</strong></p><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBaiduService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>

    Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            baiduService<span class="token punctuation">.</span><span class="token function">control</span><span class="token punctuation">(</span><span class="token string">"level1"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            baiduService<span class="token punctuation">.</span><span class="token function">control</span><span class="token punctuation">(</span><span class="token string">"level2"</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="4-基于Linux环境安装Redis"><a href="#4-基于Linux环境安装Redis" class="headerlink" title="4. 基于Linux环境安装Redis"></a>4. 基于Linux环境安装Redis</h2><h3 id="4-1-下载安装"><a href="#4-1-下载安装" class="headerlink" title="4.1 下载安装"></a>4.1 下载安装</h3><p>下载安装包</p><p><code>wget http://download.redis.io/releases/redis-4.0.0.tar.gz</code></p><p>解压</p><p><code>tar -xvf redis-4.0.0.tar.gz</code></p><p>编译</p><p><code>make</code></p><p>安装</p><p><code>make install</code></p><h3 id="4-2-启动Redis"><a href="#4-2-启动Redis" class="headerlink" title="4.2 启动Redis"></a>4.2 启动Redis</h3><p>指定端口启动Redis</p><p><code>./bin/redis-server --port=6379</code></p><p>查看redis.conf , 过滤掉注释信息(#)和空行 , 并输出到redis-6379.conf</p><p><code>cat redis.conf | grep -v "#" | grep -v "^$" &gt; redis-6379.conf</code></p><p>指定配置文件启动Redis</p><p><code>./bin/redis-server redis-6379.conf</code></p><p>启动Redis客户端</p><p><code>./bin/redis-cli</code></p><h3 id="4-3-Redis服务配置"><a href="#4-3-Redis服务配置" class="headerlink" title="4.3 Redis服务配置"></a>4.3 Redis服务配置</h3><p><strong>基本配置</strong></p><p><code>daemonize yes</code> 以守护线程方式启动, 该方式下Redis将以服务的形式存在, 日志将不再打印到命令窗口中.</p><p><code>port 6379</code> 设置当前服务启动端口号</p><p><code>dir /usr/local/redis/data</code> 设定当前服务文件保存位置, 包含日志文件, 持久化文件等.</p><p><code>logfile "6379.log"</code> 设定日志文件名, 便于查阅.</p><p>完整的配置项, 请移步到redis.conf文件查看.</p><h2 id="5-持久化"><a href="#5-持久化" class="headerlink" title="5. 持久化"></a>5. 持久化</h2><h3 id="5-1-持久化简介"><a href="#5-1-持久化简介" class="headerlink" title="5.1 持久化简介"></a>5.1 持久化简介</h3><p><strong>什么是持久化</strong></p><p>利用永久性存储介质将数据进行保存, 在特定的时间将保存的数据进行恢复的工作机制称为<code>持久化</code>.</p><p><strong>为什么要进行持久化</strong></p><p>防止数据的意外丢失, 确保数据安全性.</p><p><strong>持久化过程保存什么</strong></p><ul><li>RDB, 数据(快照) 01011100100这样的二进制数据</li><li>AOF, 操作过程(日志)</li></ul><h3 id="5-2-RDB"><a href="#5-2-RDB" class="headerlink" title="5.2 RDB"></a>5.2 RDB</h3><h4 id="5-2-1-save指令"><a href="#5-2-1-save指令" class="headerlink" title="5.2.1 save指令"></a>5.2.1 save指令</h4><p><strong>RDB启动方式—-save指令相关配置</strong></p><p>即时保存数据, 使用<code>save</code>指令手动执行一次保存操作.</p><ul><li><p>dbfilename dump.rdb</p><p>说明: 设置本地数据库文件名, 默认值为 dump.rdb ; 通常设置为 dump-端口号.rdb</p></li><li><p>dir</p><p>说明: 设置存储<code>.rdb文件</code>的路径, 通常设置成存储空间较大的目录中, 目录名称为 data.</p></li><li><p>rdbcompression yes</p><p>说明: 设置存储至本地数据库时是否压缩数据, 默认为yes, 采用LZF压缩. 通常默认为开启状态, 如果设置为no, 可以节省CPU运行时间, 但会使存储的文件变大.</p></li><li><p>rdbchecksum yes</p><p>说明: 设置是否进行RDB文件格式校验, 校验过程在写文件和读文件过程均进行; 通常默认为开启状态, 如果设置为no, 可以节约读写过程约10%的时间消耗, 但是存在一定的数据损坏风险.</p></li></ul><p><strong>RDB启动方式—-save指令工作原理</strong><br><img src="https://img-blog.csdnimg.cn/d9d1c7e5c7e2441ea11f54157525512d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><blockquote><p><strong>注意: save指令的执行会阻塞当前redis服务器, 直到当前RDB过程完成为止, 有可能造成长时间阻塞, 线上环境不建议使用.</strong></p></blockquote><h4 id="5-2-2-bgsave指令"><a href="#5-2-2-bgsave指令" class="headerlink" title="5.2.2 bgsave指令"></a>5.2.2 bgsave指令</h4><p>数据量过大, 单线程执行方式造成效率过低, 选择后台执行的<code>bgsave</code>方式, 手动启动后台保存操作, 但不是立即执行.</p><p>redis操作者(用户)发起指令, redis服务器控制指令执行, 做到即时发起, 合理的时间执行, 达到保存数据的效果.</p><p><strong>RDB启动方式—-bgsave指令相关配置</strong></p><ul><li><p>dbfilename dump.rdb</p></li><li><p>dir</p></li><li><p>rdbcompression yes</p></li><li><p>rdbchecksum yes</p></li><li><p>stop-writes-on-bgsave-error yes</p><p>说明: 后台存储过程中如果出现错误现象, 是否停止保存操作, 通常默认为开启状态.</p></li></ul><p><strong>RDB启动方式—-bgsave指令工作原理</strong><br><img src="https://img-blog.csdnimg.cn/d6d0e11e49114368b2d480dfe9f5e203.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><blockquote><p>注意: bgsave命令是针对save阻塞问题做的优化, Redis内部所有涉及到RDB操作都采用bgsave的方式, save命令可以放弃使用.</p></blockquote><h4 id="5-2-3-RDB启动方式"><a href="#5-2-3-RDB启动方式" class="headerlink" title="5.2.3 RDB启动方式"></a>5.2.3 RDB启动方式</h4><p><strong>RDB相关配置</strong></p><p>反复执行保存指令, 忘记了怎么办? 不知道数据产生了多少变化, 如何保存? Redis配置文件可以配置自动执行.</p><p><code>save second changes</code> 满足限定时间范围内key的变化数量达到指定数量即进行持久化. second表示监控时间范围, changes表示监控key的变化量.</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># save 3600 1</span>
<span class="token comment" spellcheck="true"># save 300 100</span>
<span class="token comment" spellcheck="true"># save 60 10000</span>
</code></pre><p><strong>save配置原理</strong><br><img src="https://img-blog.csdnimg.cn/850353fadf5e4a5e8e18efbdc5aa0e9c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><blockquote><p>注意:</p><p>(1) save配置要根据实际业务情况进行设置, 频度过高或过低都会出现性能问题, 结果可能是灾难性的.</p><p>(2) save配置中对于second与changes设置通常具有互补对应关系, 尽量不要设置成包含性关系.</p><p>(3) save配置启动后执行的是bgsave操作</p></blockquote><h4 id="5-2-4-RDB三种启动方式对比"><a href="#5-2-4-RDB三种启动方式对比" class="headerlink" title="5.2.4 RDB三种启动方式对比"></a>5.2.4 RDB三种启动方式对比</h4><p><img src="https://img-blog.csdnimg.cn/00a5294f168e475f8b66611aabf64e02.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="5-2-5-RDB特殊启动形式"><a href="#5-2-5-RDB特殊启动形式" class="headerlink" title="5.2.5 RDB特殊启动形式"></a>5.2.5 RDB特殊启动形式</h4><ul><li><p>全量复制 , 在主从复制中详细介绍</p></li><li><p>服务器运行过程中重启</p><p><code>debug reload</code></p></li><li><p>关闭服务器时指定保存数据</p><p><code>shutdown save</code></p></li></ul><h4 id="5-2-6-RDB优缺点"><a href="#5-2-6-RDB优缺点" class="headerlink" title="5.2.6 RDB优缺点"></a>5.2.6 RDB优缺点</h4><p><strong>RDB优点</strong></p><ul><li>RDB是一个紧凑压缩的二进制文件, 存储效率较高.</li><li>RDB内部存储的是redis在某个时间点的数据快照, 非常适合用于数据备份, 全量复制等场景.</li><li>RDB恢复数据的速度要比AOF快很多</li><li>应用: 服务器中每X小时执行bgsave备份, 并将RDB文件拷贝到远程服务器中, 用于灾难备份.</li></ul><p><strong>RDB缺点</strong></p><ul><li>RDB方式无论是执行指令还是利用配置, 无法做到实时持久化, 具有较大的可能性丢失数据. (宕机带来的数据丢失风险)</li><li>bgsave指令每次运行要执行fork操作创建子进程, 要牺牲一些性能. (fork子进程带来的额外内存消耗)</li><li>Redis的众多版本中未进行RDB文件格式的版本统一, 有可能出现各版本之间数据格式无法兼容问题.</li><li>基于快照思想, 每次读写都是全部数据, 存储数据量较大时, 效率较低.</li></ul><h3 id="5-3-AOF"><a href="#5-3-AOF" class="headerlink" title="5.3 AOF"></a>5.3 AOF</h3><p>针对RDB存储的弊端, 可以从下面的思路解决:</p><ul><li>不写全量数据, 仅记录部分数据.</li><li>改记录数据为记录操作过程.</li></ul><h4 id="5-3-1-AOF概念"><a href="#5-3-1-AOF概念" class="headerlink" title="5.3.1 AOF概念"></a>5.3.1 AOF概念</h4><ul><li>AOF (append only file)持久化: 以独立日志的方式 记录每次写命令, 重启时再重新执行AOF文件中的命令, 达到恢复数据的目的. 与RDB相比可以简单描述为<code>改记录数据为记录数据产生的过程</code>.</li><li>AOF的主要作用是解决了数据持久化的实时性, 目前已经是Redis持久化的主流方式.</li></ul><h4 id="5-3-2-AOF写数据过程"><a href="#5-3-2-AOF写数据过程" class="headerlink" title="5.3.2 AOF写数据过程"></a>5.3.2 AOF写数据过程</h4><p><img src="https://img-blog.csdnimg.cn/6922b2fc29664bcfb2dfab98a80d9817.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="5-3-3-AOF写数据三种策略"><a href="#5-3-3-AOF写数据三种策略" class="headerlink" title="5.3.3 AOF写数据三种策略"></a>5.3.3 AOF写数据三种策略</h4><ul><li><p>always</p><p>每次写入操作均同步到AOF文件中, <code>数据零误差, 性能较低</code>, 不建议使用.</p></li><li><p>everysec</p><p>每秒缓冲区中的指令同步到AOF文件中, <code>数据准确性较高, 性能较高</code>. 建议使用, 也是默认配置.</p><p>在系统突然宕机的场景下会丢失<code>1s</code>内的数据.</p></li><li><p>no</p><p>由操作系统控制每次同步到AOF文件的周期, 整体过程不可控.</p></li></ul><h4 id="5-3-4-AOF功能开启"><a href="#5-3-4-AOF功能开启" class="headerlink" title="5.3.4 AOF功能开启"></a>5.3.4 AOF功能开启</h4><p>redis.conf配置文件中配置<code>appendonly yes|no</code>, 表示是否开启AOF持久化功能, 默认为不开启状态.</p><p>redis.conf配置文件中配置<code>appendfsync always|everysec|no</code>, AOF写数据策略.</p><p><code>appendfilename filename</code> 配置AOF持久化文件名, 默认为appendonly.aof , 建议配置为 appendonly-端口号.aof.</p><p><code>dir</code> 配置AOF持久化文件保存路径, 与RDB持久化文件保持一致即可.</p><h4 id="5-3-5-AOF重写"><a href="#5-3-5-AOF重写" class="headerlink" title="5.3.5 AOF重写"></a>5.3.5 AOF重写</h4><p><strong>AOF写数据遇到的问题</strong></p><p>如果连续执行如下指令该如何处理?<br><img src="https://img-blog.csdnimg.cn/2dcf00aa42e24806aedc60c26035daf2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p>随着命令不断写入AOF, 文件会越来越大, 为了解决这个问题, Redis引入了AOF重写机制压缩文件体积, AOF文件重写是将Redis进程内的数据转化为写命令同步到新AOF文件的过程. 简单说就是将对同一个数据的若干条命令执行结果转化成最终结果数据对应的指令进行记录.</p><p><strong>AOF重写作用</strong></p><ul><li>降低磁盘占用量, 提高磁盘利用率.</li><li>提高持久化效率, 降低持久化写时间, 提高IO性能.</li><li>降低数据恢复的耗时, 提高数据恢复效率.</li></ul><p><strong>AOF重写规则</strong></p><ul><li><p>进程内已超时的数据不再写入文件.</p></li><li><p>忽略无效指令, 重写时使用进程内数据直接生成, 这样新的AOF文件只保留最终数据的写入命令.</p><p>如: del key1, hdel key2 , srem key3, set key4 value4 等..</p></li><li><p>对同一数据的多条写命令合并为一条命令</p><p>如: lpush list1 a, lpush list1 b, lpush list1 c 可以转化为 lpush list1 a b c</p><p>为防止数据量过大造成客户端缓冲区溢出, 对list, set, hash, zset等类型, 每条指令最多写入64个元素.</p></li></ul><p><strong>AOF重写方式</strong></p><ul><li>手动重写 <code>bgrewriteaof</code></li><li>自动重写<ul><li><code>auto-aof-rewrite-percentage percentage</code></li><li><code>auto-aof-rewrite-min-size size</code></li></ul></li></ul><p><strong>AOF自动重写方式</strong><br><img src="https://img-blog.csdnimg.cn/cf8297578a50431c92724a70b4460159.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="5-3-6-AOF工作流程"><a href="#5-3-6-AOF工作流程" class="headerlink" title="5.3.6 AOF工作流程"></a>5.3.6 AOF工作流程</h4><p><img src="https://img-blog.csdnimg.cn/19f8f61b25f74382a134b9296abed65b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>AOF重写流程</strong><br><img src="https://img-blog.csdnimg.cn/a5707adcf3ee4342bbaabdb0f2b88ed5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="5-3-7-RDB与AOF对比"><a href="#5-3-7-RDB与AOF对比" class="headerlink" title="5.3.7 RDB与AOF对比"></a>5.3.7 RDB与AOF对比</h4><p><img src="https://img-blog.csdnimg.cn/0083e8b1872d465fac3b096e330195ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>RDB与AOF的选择</strong><br><img src="https://img-blog.csdnimg.cn/95ffba94a153404aac960f45e31c93f8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="5-3-8-持久化应用场景"><a href="#5-3-8-持久化应用场景" class="headerlink" title="5.3.8 持久化应用场景"></a>5.3.8 持久化应用场景</h4><p><img src="https://img-blog.csdnimg.cn/7e015da030f94a55af03050ea3820ac9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h2 id="6-Redis事务"><a href="#6-Redis事务" class="headerlink" title="6. Redis事务"></a>6. Redis事务</h2><h3 id="6-1-事务简介"><a href="#6-1-事务简介" class="headerlink" title="6.1 事务简介"></a>6.1 事务简介</h3><p>什么是事务?</p><p>Redis执行指令过程中, 多条连续执行的指令被干扰, 打断, 插队.<br><img src="https://img-blog.csdnimg.cn/c83fd0a898da42b7972258b56bfa0104.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p>Redis事务就是一个命令执行的队列, 将一系列预定义命令包装成一个整体(一个队列). 当执行时, 一次性按照添加顺序依次执行, 中间不会被打断或者干扰.</p><h3 id="6-2-事务的基本操作"><a href="#6-2-事务的基本操作" class="headerlink" title="6.2 事务的基本操作"></a>6.2 事务的基本操作</h3><ul><li><p>开启事务</p><p><code>multi</code> 设定事务的开始位置, 此指令执行后, 后续的所有指令均加入到事务中.</p></li><li><p>执行事务</p><p><code>exec</code> 设定事务的结束位置, 同时执行事务. 与<code>multi</code>成对出现, 成对使用.</p></li></ul><blockquote><p><strong>注意: 加入事务的命令暂时进入到任务队列中, 并没有立即执行, 只有执行exec命令才开始执行.</strong></p></blockquote><ul><li><p>取消事务</p><p><code>discard</code> 终止当前事务的定义, 发生在multi之后, exec之前.</p></li></ul><h3 id="6-3-事务的工作流程"><a href="#6-3-事务的工作流程" class="headerlink" title="6.3 事务的工作流程"></a>6.3 事务的工作流程</h3><p><img src="https://img-blog.csdnimg.cn/11f4ff704e78406ab77c082dc57b8b91.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h3 id="6-4-事务的注意事项"><a href="#6-4-事务的注意事项" class="headerlink" title="6.4 事务的注意事项"></a>6.4 事务的注意事项</h3><p><img src="https://img-blog.csdnimg.cn/1c3f7bc5b9ea4a898c5ab2667262bb63.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><blockquote><p><strong>注意: 已经执行完毕的命令对应的数据不会自动回滚, 需要程序员自己在代码中实现回滚.</strong></p></blockquote><p><strong>手动进行事务回滚:</strong><br><img src="https://img-blog.csdnimg.cn/0c443bb9e0e14c82a800bad81e8b39b8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h3 id="6-5-锁的应用"><a href="#6-5-锁的应用" class="headerlink" title="6.5 锁的应用"></a>6.5 锁的应用</h3><p><strong>基于特定条件的事务执行</strong></p><h4 id="6-5-1-业务场景1"><a href="#6-5-1-业务场景1" class="headerlink" title="6.5.1 业务场景1"></a>6.5.1 业务场景1</h4><p>天猫双11热卖过程中, 对已经售罄的货物追加补货, 4个业务员都有权限进行补货, 补货的操作可能是一系列的操作, 牵扯到多个连续操作, 如何保障不会重复操作?</p><p><strong>业务分析:</strong></p><ul><li>多个客户端有可能同时操作同一组数据, 并且该数据一旦被操作修改后 , 将不适用于继续操作</li><li>在操作之前锁定要操作的数据, 一旦发生变化, 终止当前操作</li></ul><p><strong>解决方案</strong></p><ul><li><p>对key添加监视锁, 在执行exec前如果key发生了变化, 终止事务执行.</p><p><code>watch key1 [key2...]</code></p></li><li><p>取消对所有key的监视</p><p><code>unwatch</code></p></li></ul><p><strong>Tips:</strong> redis应用基于状态控制的批量任务执行.</p><h4 id="6-5-2-业务场景2"><a href="#6-5-2-业务场景2" class="headerlink" title="6.5.2 业务场景2"></a>6.5.2 业务场景2</h4><p>天猫双11热卖过程中, 对已经售罄的货物追加补货, 且补货完成. 客户购买热情高涨, 3s内将所有商品购买完毕, 本次补货已经将全部库存清空, 如何避免最后一件商品不被多人同时购买? <strong>[超卖问题]</strong></p><p><strong>业务分析</strong></p><ul><li>使用watch监控一个key有没有改变已经不能解决问题, 此处要监控的是具体数据.</li><li>虽然redis是单线程的, 但是多个客户端对同一数据同时进行操作, 如何避免不被同时修改 ?</li></ul><p><strong>解决方案</strong></p><ul><li><p>使用setnx设置一个公共锁 (分布式锁的使用)</p><p><code>setnx lock-key value</code> 利用setnx命令的返回值特征, 返回0设置失败, 返回1则设置成功.<br>对于返回设置成功的, 拥有控制权, 进行下一步的具体业务操作.<br>对于返回设置失败的, 不具有控制权, 排队等待.</p></li><li><p>操作完毕通过del操作释放锁.</p></li></ul><pre class="language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> num 10 <span class="token comment" spellcheck="true"># 初始化数据</span>
OK
127.0.0.1:6379<span class="token operator">></span> setnx lock-num 1 <span class="token comment" spellcheck="true"># 当前用户获取锁</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> incrby num -1 <span class="token comment" spellcheck="true"># 当前用户操作数据</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9
127.0.0.1:6379<span class="token operator">></span> del dock-num <span class="token comment" spellcheck="true"># 当前用户释放锁</span>
</code></pre><blockquote><p><strong>注意: 上述方案是一种设计概念, 依赖规范保障, 具有风险性.</strong></p></blockquote><p><strong>Tips:</strong> redis应用基于分布式锁对应的场景控制.</p><h4 id="6-5-3-业务场景3"><a href="#6-5-3-业务场景3" class="headerlink" title="6.5.3 业务场景3"></a>6.5.3 业务场景3</h4><p>依赖分布式锁的机制, 某个用户操作时对应客户端宕机了, 并且此时已经获取到锁, 没有释放, 如何解决?</p><p><strong>业务分析</strong></p><ul><li>由于锁操作由用户控制加锁解锁, 必定会存在加锁后未解锁的风险.</li><li>需要解锁操作不能仅依赖用户控制, 系统级别要给出对应的兜底解决方案.</li></ul><p><strong>解决方案</strong></p><ul><li><p>使用 expire 为锁 key 添加时间限定, 超时没有释放, 就主动失效, 放弃锁. (<strong>分布式锁</strong>)</p><p><code>expire lock-key second</code></p><p><code>pexpire lock-key millseconds</code></p></li></ul><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">### 客户端1模拟获取锁, 然后宕机了, 锁没有释放</span>
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name crysw <span class="token comment" spellcheck="true"># 数据初始化</span>
OK
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> lock-name 1 <span class="token comment" spellcheck="true"># 设置锁</span>
OK 
127.0.0.1:6379<span class="token operator">></span> expire lock-name 30 <span class="token comment" spellcheck="true"># 设置锁的有效期</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name pathd
OK
127.0.0.1:6379<span class="token operator">></span> <span class="token comment" spellcheck="true">### 到这里宕机了!!!!! 锁还没有释放呢,咋办呢? 别急, 上面设置了锁的有效期.</span>
</code></pre><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">### 客户端2模拟获取上面的锁, 一直获取失败, 直到锁失效后, 才成功设置锁</span>
127.0.0.1:6379<span class="token operator">></span> setnx lock-name 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> setnx lock-name 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> setnx lock-name 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> setnx lock-name 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127.0.0.1:6379<span class="token operator">></span> ttl lock-name <span class="token comment" spellcheck="true">### 查看锁的剩余时间, 已经失效, 下面重新设置锁</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -2
127.0.0.1:6379<span class="token operator">></span> setnx lock-name 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127.0.0.1:6379<span class="token operator">></span>
</code></pre><p>由于操作通常都是微妙或毫秒级, 因此该锁定时间不宜设置过大. 具体时间需要根据业务逻辑测试后确认.</p><ul><li>例如: 持有锁的操作最长执行时间127ms, 最短执行时间7ms.</li><li>测试百万次最长时间对应命令的最大耗时, 测试百万次网络延迟平均耗时.</li><li>锁时间设定推荐: 最大耗时*120% + 平均网络延迟*110%</li><li>如果业务最大耗时<code>&lt;&lt;</code>网络平均延迟, 通常为2个数量级, 取其中单个耗时较长即可.</li></ul><h2 id="7-删除策略"><a href="#7-删除策略" class="headerlink" title="7. 删除策略"></a>7. 删除策略</h2><h3 id="7-1-过期数据"><a href="#7-1-过期数据" class="headerlink" title="7.1 过期数据"></a>7.1 过期数据</h3><p>Redis是一种内存级数据库, 所有数据均存放在内存中, 内存中的数据可以通过<code>TTL</code>指令获取其状态.</p><ul><li>XX: 具有时效性的数据</li><li>-1: 永久有效的数据</li><li>-2: 已经过期的数据或被删除的数据, 或未定义的数据.</li></ul><h3 id="7-2-数据删除策略"><a href="#7-2-数据删除策略" class="headerlink" title="7.2 数据删除策略"></a>7.2 数据删除策略</h3><h4 id="7-2-1-时效性数据的存储结构"><a href="#7-2-1-时效性数据的存储结构" class="headerlink" title="7.2.1 时效性数据的存储结构"></a>7.2.1 时效性数据的存储结构</h4><p><img src="https://img-blog.csdnimg.cn/cd80e0b28f1e4983981e4b9106c40e41.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>数据删除策略的目标</strong></p><p>在内存占用与CPU占用之间寻找一种平衡, 顾此失彼都会造成整体Redis性能的下降, 甚至引发服务器宕机或内存泄漏.</p><h4 id="7-2-2-定时删除"><a href="#7-2-2-定时删除" class="headerlink" title="7.2.2 定时删除"></a>7.2.2 定时删除</h4><ul><li>创建一个定时器, 当key设置有过期时间, 且过期时间到达时, 由定时器任务立即执行对键的删除操作.</li><li>优点: 节约内存, 到时间就删除, 快速释放掉不必要的内存占用.</li><li>缺点: CPU压力很大, 无论CPU此时负载量多高, 均占用CPU, 会影响redis服务器响应时间和指令吞吐量.</li><li>总结: 用处理器性能换取存储空间( <strong>拿时间换空间</strong> ).</li></ul><h4 id="7-2-3-惰性删除"><a href="#7-2-3-惰性删除" class="headerlink" title="7.2.3 惰性删除"></a>7.2.3 惰性删除</h4><ul><li>数据到达过期时间, 不做处理, 等下次访问该数据时:<ul><li>如果未过期, 返回数据</li><li>发现已过期, 删除key , 返回不存在</li></ul></li><li>优点: 节约CPU性能, 发现必须删除的时候才删除</li><li>缺点: 内存压力很大, 出现长期占用内存的数据</li><li>总结: 用存储空间换取处理器 ( <strong>拿空间换时间</strong> )</li></ul><h4 id="7-2-4-定期删除"><a href="#7-2-4-定期删除" class="headerlink" title="7.2.4 定期删除"></a>7.2.4 定期删除</h4><p>以上两种方案都走极端, 有没有折中方案呢? 那就是<code>定期删除</code></p><ul><li>当Redis启动服务器初始化时, 读取配置server.hz的值, 默认为 10 .</li><li>每秒执行server.hz次<code>serverCron()</code> -&gt; <code>databasesCron()</code> -&gt; <code>activeExpireCycle()</code></li><li><code>activeExpireCycle()</code> 对每个expire[*]逐一进行检测, 每次执行 250ms/server.hz</li><li>对某个expires[*]检测时, 随机挑选W个key检测:<ul><li>如果key超时, 删除key.</li><li>如果一轮中删除的key的数量 大于 W*25%, 循环该过程.</li><li>如果一轮中删除的key的数量小于等于 W*25%, 检查下一个expires[*], 0-15循环.</li><li>W取值 = ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP属性值.</li></ul></li><li>参数current_db用于记录<code>activeExpireCycle()</code>进入expires[*]执行.</li><li>如果<code>activeExpireCycle()</code>执行时间到期, 下次从current_db继续向下执行.</li></ul><p><strong>定期删除</strong></p><ul><li>周期性轮询redis库中的时效性数据, 采取随机抽取的策略, 利用过期数据占比的方式控制删除频度.</li><li>特点1: CPU性能占用设置有峰值, 检测频度可自定义设置.</li><li>特点2: 内存压力不是很大, 长期占用内存的冷数据会被持续清理.</li><li>总结: 周期性抽查存储空间 (随机抽查, 重点抽查).</li></ul><h4 id="7-2-5-删除策略比对"><a href="#7-2-5-删除策略比对" class="headerlink" title="7.2.5 删除策略比对"></a>7.2.5 删除策略比对</h4><p><img src="https://img-blog.csdnimg.cn/0a48efa37f894c9b9018674d92b63799.png#pic_center" alt="在这里插入图片描述"></p><h3 id="7-3-逐出算法"><a href="#7-3-逐出算法" class="headerlink" title="7.3 逐出算法"></a>7.3 逐出算法</h3><p><strong>当新数据进入redis时, 如果内存不足怎么办 ?</strong></p><p>Redis使用内存存储数据, 在执行每一个命令前, 会调用<code>freeMemoryIfNeeded()</code>检测内存是否充足. 如果内存不满足新加入数据的最低存储要求, redis要临时删除一些数据为当前指令清理存储空间. 清理数据的策略称为<code>逐出算法</code>.</p><p>注意: 逐出数据的过程不是100%能够清理出可使用的内存空间, 如果不成功则反复执行, 当对所有数据尝试完毕后, 如果不能达到内存清理的要求, 将出现错误信息.</p><p><code>(error)OOM command not allowed when used memory &gt; 'maxmamory'</code></p><p><strong>影响数据逐出的相关配置</strong></p><ul><li><p>最大可使用内存 <code>maxmemory</code>, 占用物理内存的比例, 默认值为0 , 表示不限制. 生产环境中根据需求设定, 通常设置在50%以上.</p></li><li><p>每次选取待删除数据的个数 <code>maxmemory-samples</code> , 选取数据时并不会全库扫描, 导致严重的性能消耗, 降低读写性能. 因此采用随机获取数据的方式作为检测删除数据.</p></li><li><p>删除策略 <code>maxmemory-policy</code> , 达到最大内存后, 对被挑选出来的数据进行删除的策略.</p></li><li><p>检测易失数据(可能会过期的数据集 server.db[i].expires)</p><ul><li>volatile-lru 挑选最近最少使用的数据淘汰</li><li>volatile-lfu 挑选最近使用次数最少的数据淘汰</li><li>volatile-ttl 挑选将要过期的数据淘汰</li><li>volatile-random 任意选择数据淘汰</li></ul></li></ul><p><img src="https://img-blog.csdnimg.cn/8b05c8919378467ba0ce6cfe42476768.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><ul><li><p>检测全库数据( 所有数据集 server.db[i].dict )</p><ul><li>allkeys-lru 挑选最近最少使用的数据淘汰</li><li>allkeys-lfu 挑选最近使用次数最少的数据淘汰</li><li>allkeys-random 任意选择数据淘汰</li></ul></li><li><p>放弃数据驱逐</p><ul><li>no-enviction (驱逐) : 禁止驱逐数据 (redis4.0中默认策略), 会引发错误OOM.</li></ul></li></ul><pre class="language-bash"><code class="language-bash">maxmemory-policy volatile-lru
</code></pre><p><strong>数据逐出策略配置依据</strong></p><p>使用info命令输出监控信息, 查询缓存hit和miss的次数, 根据业务需求调优redis配置.</p><h2 id="8-redis-conf"><a href="#8-redis-conf" class="headerlink" title="8. redis.conf"></a>8. redis.conf</h2><h3 id="8-1-服务器基础配置"><a href="#8-1-服务器基础配置" class="headerlink" title="8.1 服务器基础配置"></a>8.1 服务器基础配置</h3><p><strong>服务器端设定</strong></p><ul><li><p>设置服务器以守护进程的方式运行</p><p><code>daemonize yes|no</code></p></li><li><p>绑定主机地址, 如果绑定了, 其他客户端只能通过绑定的ip访问服务.</p><p><code>bind 127.0.0.1</code></p></li><li><p>设置服务器端口号</p><p><code>port 6379</code></p></li><li><p>设置数据库数量</p><p><code>databases 16</code></p></li></ul><p><strong>日志配置</strong></p><ul><li><p>设置服务器以指定日志记录级别</p><p><code>loglevel debug | verbose | notice | warning</code></p></li><li><p>日志记录文件名</p><p><code>logfile 端口号.log</code></p></li></ul><blockquote><p>注意: 日志级别开发中设置为verbose, 生产环境设置为notice, 简化日志输出量, 降低日志IO的频度.</p></blockquote><p><strong>客户端配置</strong></p><ul><li><p>设置同一时间最大客户端连接数, 默认无限制. 当客户端连接到达上限, Redis会关闭新的连接.</p><p><code>maxclients 0</code></p></li><li><p>客户端闲置等待最大时长, 达到最大值后关闭连接, 如需关闭该功能, 设置为0.</p><p><code>timeout 300</code></p></li></ul><p><strong>多服务器快捷配置</strong></p><ul><li><p>导入并加载指定配置文件信息, 用于快速创建redis公共配置较多的redis实例配置文件, 便于维护.</p><p><code>include /path/server-端口号.conf</code></p></li></ul><h2 id="9-高级数据类型"><a href="#9-高级数据类型" class="headerlink" title="9. 高级数据类型"></a>9. 高级数据类型</h2><h3 id="9-1-Bitmaps"><a href="#9-1-Bitmaps" class="headerlink" title="9.1 Bitmaps"></a>9.1 Bitmaps</h3><p><strong>基础操作</strong></p><ul><li><p>获取指定key对应偏移量上的bit值</p><p><code>getbit key offset</code></p></li><li><p>设置指定key对应偏移量上的bit值, value只能是1或0.</p><p><code>setbit key offset value</code></p></li></ul><p><strong>扩展操作</strong></p><ul><li><p>对指定key按位进行交, 并, 非, 异或操作, 并将结果保存到destKey中. and, or, not , xor</p><p><code>bitop or destkey key1 [key2...]</code></p></li><li><p>统计指定key中1的数量</p><p><code>bitcount key [start end]</code></p></li></ul><p><strong>业务场景</strong></p><p>电影网站</p><ul><li>统计每天某一部电影是否被点播</li><li>统计每天有多少部电影被点播</li><li>统计每周/月/年有多少部电影被点播</li><li>统计年度哪部电影没有被点播</li></ul><p><strong>业务分析</strong></p><p>维护bit位…..</p><h3 id="9-2-HyperLogLog"><a href="#9-2-HyperLogLog" class="headerlink" title="9.2 HyperLogLog"></a>9.2 HyperLogLog</h3><p>统计独立UV</p><ul><li>原始方案: set, 存储每个用户的id (字符串)</li><li>改进方案: Bitmaps, 存储每个用户状态 (bit)</li><li>全新的方案: Hyperloglog</li></ul><p><strong>Hyperloglog 用于做基数统计</strong></p><p>{1, 3, 5, 7, 5, 7, 8} &gt; 基数集: {1,3,5,7,8} 基数: 5</p><p>{1, 1, 1, 1, 1, 1, 7, 1} &gt; 基数集: {1,7} 基数: 2</p><p><strong>HyperLogLog的基本操作</strong></p><ul><li><p>添加数据</p><p><code>pfadd key element [element...]</code></p></li><li><p>统计数据</p><p><code>pfcount key [key...]</code></p></li><li><p>合并数据</p><p><code>pfmerge destkey sourcekey [sourcekey...]</code></p></li></ul><p><strong>相关说明</strong></p><ul><li>用于进行基数统计, 不是集合, 不保存数据, 只记录数量而不是具体数据</li><li>核心是基数估算算法, 最终数值存在一定误差</li><li>误差范围: 基数估计的结果是一个带有 0.81% 标准错误的近似值.</li><li>耗空间极小 , 每个<strong>HyperLogLog key</strong>占用了12k的内存用于标记基数</li><li>pfadd命令不是一次性分配12k内存使用, 会随着基数的增加内存逐渐增大</li><li>pfmerge命令合并后占用的存储空间为12k, 无论合并之前数据量有多大.</li></ul><h3 id="9-3-GEO"><a href="#9-3-GEO" class="headerlink" title="9.3 GEO"></a>9.3 GEO</h3><p>用于地理位置计算.</p><p><strong>基本操作</strong></p><ul><li><p>添加坐标点</p><p><code>geoadd key longitude latitude member [longitude latitude member...]</code></p></li><li><p>获取坐标点</p><p><code>geopos key member [member...]</code></p></li><li><p>计算坐标点距离</p><p><code>geodist key member1 member2 [unit]</code><br><img src="https://img-blog.csdnimg.cn/cf10df1e872d49f0ad2378535439398c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p></li></ul><h2 id="10-主从复制"><a href="#10-主从复制" class="headerlink" title="10. 主从复制"></a>10. 主从复制</h2><p>互联网<code>三高</code>架构: 高并发, 高性能, 高可用.</p><p>业务可用性目标5个9, 即 99.999%, 服务器年宕机时长低于315s, 约5.25分钟. 如何计算可用性比例呢? 比如:</p><p>服务宕机实际年宕机时长866467s , 可用性=(1*365*24*60*60 - 866467) * 100% / 1*365*24*60*60 = 97.252%</p><h3 id="10-1-简介"><a href="#10-1-简介" class="headerlink" title="10.1 简介"></a>10.1 简介</h3><p><img src="https://img-blog.csdnimg.cn/56fe68098824454fb191dc878d9ad574.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h3 id="10-2-多台服务器连接方案"><a href="#10-2-多台服务器连接方案" class="headerlink" title="10.2 多台服务器连接方案"></a>10.2 多台服务器连接方案</h3><p><img src="https://img-blog.csdnimg.cn/e1badb24075a40fdaf35f660a47a4a91.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>主从复制</strong></p><p>主从复制, 即将master中的数据即时, 有效的复制到slave中.</p><p>特征: 一个master可以拥有多个slave, 一个slave只对应一个master.</p><p>职责:</p><ul><li>master , 写数据; 执行写操作时, 将出现变化的数据自动同步到slave; 读数据(可忽略).</li><li>slave, 读数据, 禁止写数据.</li></ul><p>作用:</p><ul><li>读写分离, master写, slave度, 提高服务器的读写负载能力.</li><li>负载均衡, 基于主从结构, 配合读写分离, 由slave分担master负载, 并根据需求的变化, 改变slave的数量, 通过多个从节点分担数据读取负载, 大大提高Redis服务器并发量与数据吞吐量.</li><li>故障恢复, 当master出现问题时, 由slave提供服务, 实现快速的故障恢复.</li><li>数据冗余, 实现数据热备份, 是持久化之外的一种如今冗余方式.</li><li>高可用, 基于主从复制, 构建哨兵模式与集群, 实现Redis的高可用方案.</li></ul><h3 id="10-3-主从复制工作流程"><a href="#10-3-主从复制工作流程" class="headerlink" title="10.3 主从复制工作流程"></a>10.3 主从复制工作流程</h3><p>主从复制的过程大体可以分为三个阶段:</p><ul><li>建立连接阶段(准备阶段)</li><li>数据同步阶段</li><li>命令传播阶段</li></ul><p><img src="https://img-blog.csdnimg.cn/2bf60a78f8b14ed091d00c5bbeb21a4d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="10-3-1-阶段一-建立连接阶段工作流程"><a href="#10-3-1-阶段一-建立连接阶段工作流程" class="headerlink" title="10.3.1 阶段一: 建立连接阶段工作流程"></a>10.3.1 阶段一: 建立连接阶段工作流程</h4><p><img src="https://img-blog.csdnimg.cn/e266c4edd25c40b1a3b64fc634e0f838.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>主从连接(slave 连接 master)</strong></p><ul><li><p>方式一: 客户端发送命令 <code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></p></li><li><p>方式二: 启动服务器参数 <code>./redis-server --slaveof &lt;masterip&gt; &lt;masterport&gt;</code></p></li><li><p>方式三: 服务器配置 <code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></p></li><li><p>方式四: 集群配置</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 三主三从</span>
./src/redis-cli --cluster create -a 123456 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
</code></pre></li></ul><p><strong>主从断开连接</strong></p><ul><li>客户端发送命令 <code>slaveof no one</code></li></ul><p><strong>授权访问</strong></p><ul><li><p>master配置文件设置密码 <code>requirepass &lt;password&gt;</code></p></li><li><p>master客户端发送命令设置密码</p><p><code>config set requirepass &lt;password&gt;</code></p><p><code>config get requirepass</code></p></li><li><p>slave客户端发送命令设置密码 <code>auth &lt;password&gt;</code></p></li><li><p>slave配置文件设置密码 <code>masterauth &lt;password&gt;</code></p></li><li><p>启动客户端设置密码 <code>redis-cli -a &lt;password&gt;</code></p></li></ul><h4 id="10-3-2-阶段二-数据同步阶段工作流程"><a href="#10-3-2-阶段二-数据同步阶段工作流程" class="headerlink" title="10.3.2 阶段二: 数据同步阶段工作流程"></a>10.3.2 阶段二: 数据同步阶段工作流程</h4><ul><li>在slave初次连接master后, 复制master中的所有数据到slave.</li><li>将slave的数据库状态更新成master当前的数据库状态.</li></ul><p><img src="https://img-blog.csdnimg.cn/42e846d344284f99b1658c81ede6c503.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>数据同步阶段master说明</strong></p><ul><li><p>如果master数据量巨大, 数据同步阶段应该避开流量高峰期, 避免造成master阻塞, 影响业务正常执行.</p></li><li><p>复制缓冲区大小设定不合理, 会导致数据溢出. 如进行全量复制周期太长, 进行部分复制时发现数据已经存在丢失的情况, 必须进行第二次全量复制, 致使slave陷入死循环状态. 如何解决呢? 修改复制缓冲区大小.</p><p><code>repl-backlog-size 1mb</code></p></li></ul><p><strong>数据同步阶段slave说明</strong></p><ul><li><p>为避免slave进行全量复制, 部分复制时服务器响应阻塞或数据不同步, 建议关闭此期间的对外服务.</p><p><code>slave-serve-stale-data yes|no</code></p></li><li><p>数据同步阶段, master发送给slave信息可以理解master是slave的一个客户端, 主动向slave发送命令.</p></li><li><p>多个slave同时对master请求数据同步, master发送的RDB文件增多, 会对带宽造成巨大冲击, 以放master带宽不足, 数据同步需要根据业务需求, 适量错峰.</p></li><li><p>slave过多时, 建议调整拓扑结构, 由一主多从结构变为树状结构, 中间的节点既是master, 也是slave. 注意使用树状结构时, 由于层级深度, 导致深度越高的slave与最顶层master数据同步延迟较大, 数据一致性变差, 应谨慎选择.</p></li></ul><h4 id="10-3-3-阶段三-命令传播阶段"><a href="#10-3-3-阶段三-命令传播阶段" class="headerlink" title="10.3.3 阶段三:  命令传播阶段"></a>10.3.3 阶段三: 命令传播阶段</h4><ul><li>当master数据库被修改后, 导致主从服务器数据库状态不一致, 此时需要让主从数据同步到一致的状态, 同步的动作称为<code>命令传播</code>.</li><li>master将接收到的数据变更命令发送给slave, slave接收到命令后执行.</li></ul><p><strong>命令传播阶段的部分复制</strong></p><p>命令传播阶段出现了断网现象</p><ul><li>网络闪断闪连, 进行忽略</li><li>短时间网络中断, 部分复制</li><li>长时间网络中断, 全量复制</li></ul><p><strong>部分部分的三个核心要素</strong></p><ul><li>服务器的运行ID(run id)</li><li>主服务器的复制积压缓冲区</li><li>主从服务器的复制偏移量</li></ul><p><strong>服务器运行ID (runid)</strong></p><ul><li><p>概念: 服务器运行ID是每一台服务器每次运行的身份识别码, 一台服务器多次运行可以生成多个运行ID.</p></li><li><p>组成: 运行ID由40位字符组成, 是一个随机的十六进制字符.</p></li><li><p>作用: 运行ID被用于在服务器间进行传输, 识别身份; 如果想两次操作均对同一台服务器进行, 必须每次操作携带对应的运行ID , 用于识别对方.</p></li><li><p>实现方式: 运行ID在每台服务器启动时自动生成的, master在首次连接slave时, 会将自己的运行ID发给slave, slave保存运行ID, 通过info server命令可以查看.</p></li></ul><p><strong>复制缓冲区</strong></p><ul><li><p>概念: 复制积压缓冲区, 是一个先进先出(FIFO)的队列, 用于存储服务器执行过的命令, 每次传播命令, master都会将传播的命令记录下来, 并存储在复制缓冲区.</p><p>复制缓冲区默认数据存储空间大小是1M, 由于存储空间大小是固定的, 当入队元素的数量大于队列长度时, 最先入队的元素会被弹出, 而新元素会被放入队列.</p></li><li><p>由来: 每台服务器启动时, 如果开启有AOF或被连接成为master节点, 即创建复制缓冲区.</p></li><li><p>作用: 用于保存master收到的所有指令 (仅影响数据变更的指令, 例如set)</p></li><li><p>数据来源: 当master接收到主客户端的指令时, 除了将指令执行, 会将该指令存储到缓冲区中.</p></li></ul><p><img src="https://img-blog.csdnimg.cn/0d251e637ce94483914ad6e6158f13a3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>复制缓冲区内部工作原理</strong><br><img src="https://img-blog.csdnimg.cn/bbdd3642f9fd418fb2f0c08bd91628a1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>主从服务器复制偏移量 (offset)</strong></p><ul><li>概念: 一个数字, 描述复制缓冲区中的指令字节位置.</li><li>分类<ul><li>master复制偏移量: 记录发送给所有slave的指令字节对应的位置(多个)</li><li>slave复制偏移量: 记录slave接收master发送过来的指令字节对应的位置( 一个)</li></ul></li><li>数据来源<ul><li>master端: 发送一次记录一次</li><li>slave端: 接收一次记录一次</li></ul></li><li>作用: 同步信息, 比对master与slave的差异, 当slave断线后, 恢复数据使用.</li></ul><h4 id="10-3-4-工作流程"><a href="#10-3-4-工作流程" class="headerlink" title="10.3.4 工作流程"></a>10.3.4 工作流程</h4><p><img src="https://img-blog.csdnimg.cn/cc32ae26414941b5abfce0b377c102c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><hr><hr><p><img src="https://img-blog.csdnimg.cn/0962af320d424fdab879d1be9fef7110.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="10-3-5-心跳机制"><a href="#10-3-5-心跳机制" class="headerlink" title="10.3.5 心跳机制"></a>10.3.5 心跳机制</h4><ul><li>进入命令传播阶段后, master与slave之间需要进行信息交换, 使用心跳机制进行维护, 实现双方连接保持在线.</li><li>master心跳<ul><li>指令: ping</li><li>周期: 由repl-ping-slave-period决定, 默认10s</li><li>作用: 判断slave是否在线</li><li>查询: info replication , 获取slave最后一次连接时间间隔, lag项维持在0或1视为正常.</li></ul></li><li>slave心跳任务<ul><li>指令: replconf ack {offset}</li><li>周期: 1s</li><li>作用: 汇报slave字节的复制偏移量, 获取最新的数据变更指令; 并且可以判断master是否在线.</li></ul></li></ul><p><strong>心跳阶段注意事项:</strong></p><ul><li><p>当slave多数掉线, 或延迟过高时, master为保障数据稳定性, 将拒绝所有信息同步操作</p><p><code>min-slaves-to-write 2</code></p><p><code>min-slaves-max-lag 8</code></p><p>slave数量少于2个, 或者所有slave的延迟都大于等于10s时, 强制关闭master写功能, 停止数据同步.</p></li><li><p>slave数量由slave发送replconf ack命令做确认</p></li><li><p>slave延迟由slave发送replconf ack命令做确认</p></li></ul><h3 id="10-4-常见问题"><a href="#10-4-常见问题" class="headerlink" title="10.4 常见问题"></a>10.4 常见问题</h3><h4 id="10-4-1-频繁的全量复制-1"><a href="#10-4-1-频繁的全量复制-1" class="headerlink" title="10.4.1 频繁的全量复制(1)"></a>10.4.1 频繁的全量复制(1)</h4><p>伴随着系统的运行, master的数据量会越来越大, 一旦master重启, runid将发生变化, 会导致全部slave的全量复制操作.</p><p>内部优化调整方案</p><p>(1) master内部创建master_repid变量, 使用runid相同的策略生成, 长度41位, 并发送给所有slave.</p><p>(2) 在master关闭时执行命令 shutdown save, 进行RDB持久化, 将runid与offset保存到RDB文件中.</p><ul><li>repl-id repl-offset</li><li>通过redis-check-rdb命令可以查看该信息.</li></ul><p>(3) master重启后加载RDB文件, 恢复数据. 重启后, 将RDB文件中保存的repl-id 与 repl-offset加载到内存中.</p><ul><li>master_repl_id=repl master_repl_offset=repl-offset</li><li>通过info命令可以查看该信息</li></ul><p>作用: 本机保存上次runid, 重启后恢复该值, 使所有slave认为还是之前的master.</p><h4 id="10-4-2-频繁的全量复制-2"><a href="#10-4-2-频繁的全量复制-2" class="headerlink" title="10.4.2 频繁的全量复制(2)"></a>10.4.2 频繁的全量复制(2)</h4><p>问题现象: 网络环境不佳, 出现网络中断, slave不提供服务.</p><p>问题原因: 复制缓冲区大小, 断网后slave的offset越界, 触发全量复制.</p><p>最终结果: slave反复进行全量复制.</p><p>解决方案: 修改复制缓冲区大小. <code>repl-backlog-size</code></p><p>建议设置如下:</p><ul><li>测算从master到slave的重连平均时长second</li><li>获取master平均每秒产生写命令数据总量 write_size_per_second</li><li>最优复制缓冲区空间 = 2*second*write_size_second</li></ul><h4 id="10-4-3-频繁的网络中断-1"><a href="#10-4-3-频繁的网络中断-1" class="headerlink" title="10.4.3 频繁的网络中断(1)"></a>10.4.3 频繁的网络中断(1)</h4><p>问题现象: master的CPU占用过高或slave频繁断开连接.</p><p>问题原因:</p><ul><li>slave每1s发送replconf ack命令到master.</li><li>当slave接到了慢查询时 (keys *, hgetall等), 会大量占用CPU性能.</li><li>master每1s调用复制定时函数replicationCron(), 比对slave发现长时间没用进行响应.</li></ul><p>最终结果: master各种资源 (输出缓冲区, 带宽, 连接等) 被严重占用.</p><p>解决方案: 通过设置合理的超时时间, 确认是否被释放 slave.</p><p><code>repl-timeout</code> 该参数定义了超时时间的阈值 (默认60s), 超过该值, 释放slave.</p><h4 id="10-4-4-频繁的网络中断-2"><a href="#10-4-4-频繁的网络中断-2" class="headerlink" title="10.4.4 频繁的网络中断(2)"></a>10.4.4 频繁的网络中断(2)</h4><p>问题现象: slave与master连接断开</p><p>问题原因:</p><ul><li>master发送ping指令频度较低.</li><li>master设定超时时间较短</li><li>ping指令在网络中存在丢包</li></ul><p>解决方案: 提高ping指令发送的频度.</p><p><code>repl-ping-slave-period</code> 超时时间repl-time的时间至少是ping指令频度的5到10倍, 否则slave很容易判定超时.</p><h4 id="10-4-5-数据不一致"><a href="#10-4-5-数据不一致" class="headerlink" title="10.4.5 数据不一致"></a>10.4.5 数据不一致</h4><p>问题现象: 多个slave获取相同数据不同步</p><p>问题原因: 网络信息不同步, 数据发送有延迟</p><p>解决方案:</p><ul><li><p>优化主从间的网络环境, 通常放置在同一个机房部署, 如使用阿里云等云服务器时要注意此现象.</p></li><li><p>监控主从节点延迟(通过offset)判断, 如果slave延迟过大, 暂时屏蔽程序对该slave的数据访问.</p><p><code>slave-server-stale-data yes|no</code></p><p>开启后仅响应info, slaveof等少数命令 (慎用, 除非对数据一致性要求很高).</p></li></ul><h2 id="11-哨兵模式"><a href="#11-哨兵模式" class="headerlink" title="11. 哨兵模式"></a>11. 哨兵模式</h2><h3 id="11-1-哨兵简介"><a href="#11-1-哨兵简介" class="headerlink" title="11.1 哨兵简介"></a>11.1 哨兵简介</h3><p>发生场景: 将宕机的master下线, 找一个slave作为master, 通知所有的slave连接新的master, 启动新的master与slave, 可能触发全量复制*N + 部分复制*N .</p><p>哨兵(sentinel) 是一个分布式系统, 用于对主从结构中的每台服务器进行<code>监控</code>, 当出现故障时通过投票机制<code>选择</code>新的master, 并将所有slave连接到新的master.</p><p>哨兵的作用:</p><p>(1) 监控</p><ul><li>不断的检查master和slave是否正常运行</li><li>master存活检测, master与slave运行情况检测</li></ul><p>(2) 通知(提醒) , 当被监控的服务器出现问题时, 向其他 (哨兵间, 客户端) 发送通知.</p><p>(3) 自动故障转移, 断开master与slave连接, 选取一个slave作为master, 将其他slave连接到新的master, 并告知客户端新的服务器地址.</p><blockquote><p>注意: 哨兵也是一台redis服务器, 只是不提供数据服务, 通常哨兵配置数量为单数.</p></blockquote><h3 id="11-2-启用哨兵模式"><a href="#11-2-启用哨兵模式" class="headerlink" title="11.2 启用哨兵模式"></a>11.2 启用哨兵模式</h3><p><strong>配置哨兵</strong></p><ul><li>配置一拖二的主从结构</li><li>配置三个哨兵 (配置相同, 端口不同), 参看 sentinel.conf<pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat sentinel/sentinel-27000.conf</span>
port 27000
daemonize <span class="token function">yes</span>
pidfile <span class="token string">"/var/run/redis-sentinel.pid"</span>
logfile <span class="token string">"/usr/local/redis_cluster/data/sentinel-27000.log"</span>
<span class="token function">dir</span> <span class="token string">"/usr/local/redis_cluster/data"</span>
sentinel monitor mymaster 127.0.0.1 7000 2 <span class="token comment" spellcheck="true"># 监听的master主机, 达到2个哨兵认为master不行了,就重新选举</span>
</code></pre></li><li>启动哨兵 <code>redis-sentinel sentinel-端口号.conf</code><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-sentinel sentinel/sentinel-27000.conf</span>
<span class="token punctuation">[</span>root@centos7-01 redis_cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-sentinel sentinel/sentinel-27001.conf</span>
<span class="token punctuation">[</span>root@centos7-01 redis_cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-sentinel sentinel/sentinel-27002.conf</span>
<span class="token punctuation">[</span>root@centos7-01 redis_cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep redis-sentinel # 查看哨兵进程</span>
root       2799      1  0 08:41 ?        00:02:23 /usr/local/redis_cluster/src/redis-sentinel *:27000 <span class="token punctuation">[</span>sentinel<span class="token punctuation">]</span>
root       2805      1  0 08:41 ?        00:02:25 /usr/local/redis_cluster/src/redis-sentinel *:27001 <span class="token punctuation">[</span>sentinel<span class="token punctuation">]</span>
root       2811      1  0 08:41 ?        00:02:37 /usr/local/redis_cluster/src/redis-sentinel *:27002 <span class="token punctuation">[</span>sentinel<span class="token punctuation">]</span>
</code></pre>也可以将多个哨兵的启动命令写到一个shell脚本中, 比如: startSentinel.sh; 然后 sh startSentinel.sh就可以完成哨兵的启动.<pre class="language-bash"><code class="language-bash">/usr/local/redis_cluster/src/redis-sentinel sentinel/sentinel-27000.conf
/usr/local/redis_cluster/src/redis-sentinel sentinel/sentinel-27001.conf
/usr/local/redis_cluster/src/redis-sentinel sentinel/sentinel-27002.conf
</code></pre></li></ul><h3 id="11-3-哨兵工作原理"><a href="#11-3-哨兵工作原理" class="headerlink" title="11.3 哨兵工作原理"></a>11.3 哨兵工作原理</h3><p>哨兵进行<code>主从切换</code>过程中经历三个阶段</p><ul><li>监控</li><li>通知</li><li>故障转移</li></ul><h4 id="11-3-1-阶段一-监控"><a href="#11-3-1-阶段一-监控" class="headerlink" title="11.3.1 阶段一: 监控"></a>11.3.1 阶段一: 监控</h4><p>用于同步各个节点的状态信息.</p><ul><li>获取各个sentinel的状态(是否在线);</li><li>获取master的状态<ul><li>master属性runid和 master_role</li><li>各个slave的详细信息</li></ul></li><li>获取所有slave的状态 (根据master中的slave信息)<ul><li>slave属性 (runid, slave_role, master_host, master_port, offset….)</li></ul></li></ul><p><img src="https://img-blog.csdnimg.cn/6cdf96864ea340d9bd6fb15b018dbfc5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="11-3-2-阶段二-通知"><a href="#11-3-2-阶段二-通知" class="headerlink" title="11.3.2 阶段二: 通知"></a>11.3.2 阶段二: 通知</h4><p>保持联通.<br><img src="https://img-blog.csdnimg.cn/9061d1ad4e9644acb22cbebeb94d986e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h4 id="11-3-3-阶段三-故障转移"><a href="#11-3-3-阶段三-故障转移" class="headerlink" title="11.3.3 阶段三: 故障转移"></a>11.3.3 阶段三: 故障转移</h4><p>发现问题, 竞选负责人, 优选新master, 新master上任, 其他slave切换master, 原master作为slave故障恢复后连接.</p><p><strong>master发送故障</strong></p><p><img src="https://img-blog.csdnimg.cn/5cef744b278d44498207476ecfb10c4c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>哨兵选举主事人</strong><br><img src="https://img-blog.csdnimg.cn/8599271295bf46c49eefacaeae256aa4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><p><strong>主事人(哨兵)挑选新的master</strong></p><p>哨兵leader从服务器列表中挑选可用的master.</p><ul><li>在线的, 响应慢的, 与原来master断开时间久的</li><li>优先原则 (优先级, offset, runid)</li></ul><p>发送指令(sentinel)</p><ul><li>向新的master发送slaveof no one</li><li>向其他slave发送slaveof新的master IP,端口.</li></ul><p><img src="https://img-blog.csdnimg.cn/5f807b3aff6442b58f742b366d592fea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h2 id="12-集群"><a href="#12-集群" class="headerlink" title="12. 集群"></a>12. 集群</h2><h3 id="12-1-集群简介"><a href="#12-1-集群简介" class="headerlink" title="12.1 集群简介"></a>12.1 集群简介</h3><p>现状问题: 业务发展过程中遇到的峰值瓶颈</p><ul><li>redis提供的服务OPS可以达到10万/s, 当前业务OPS已经达到20万/s.</li><li>内存单机容量达到256G, 当前业务需求内存容量1T</li></ul><p>使用集群的方式可以快速解决上述问题..</p><p><strong>集群作用</strong></p><ul><li><p>分散单台服务器的访问压力, 实现负载均衡.</p></li><li><p>分散单台服务器的存储压力, 实现可扩展性.</p></li><li><p>降低单台服务器宕机带来的业务灾难.</p></li></ul><h3 id="12-2-Redis集群结构设计"><a href="#12-2-Redis集群结构设计" class="headerlink" title="12.2 Redis集群结构设计"></a>12.2 Redis集群结构设计</h3><p><strong>数据存储设计</strong></p><ul><li>通过算法设计, 计算出key应该保存的位置.</li><li>将所有的存储空间计划切割成16384份, 每台主机保存一部分, 每部分代表的是一个存储空间, 不是一个key的保存空间.</li><li>将key按照计算出的结果放到对应的存储空间.</li><li>增强可扩展性</li></ul><p><strong>集群内部通讯设计</strong></p><ul><li><p>各个数据库相互通信, 保存各个库中槽的编号数据.</p></li><li><p>一次命中, 直接返回.</p></li><li><p>一次未命中, 告知具体位置.</p></li></ul><p><img src="https://img-blog.csdnimg.cn/a5195c25279a484b8fe1c97bea38b33c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAY3J5c3c=,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p><h3 id="12-3-cluster集群结构搭建"><a href="#12-3-cluster集群结构搭建" class="headerlink" title="12.3 cluster集群结构搭建"></a>12.3 cluster集群结构搭建</h3><p>将解压包中的脚本<code>src</code>目录复制到指定集群目录</p><pre class="language-bash"><code class="language-bash"><span class="token function">cp</span> -r -p src /usr/local/redis_cluster2/
</code></pre><p>将解压包中的配置文件输出到指定目录</p><pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> redis.conf <span class="token operator">></span> /usr/local/redis_cluster2/redis-6379.conf
</code></pre><p>配置文件中开启集群模式</p><pre class="language-bash"><code class="language-bash">cluster-enabled <span class="token function">yes</span>
cluster-config-file nodes-6379.conf
cluster-node-timeout 5000
<span class="token function">dir</span> /usr/local/redis_cluster2/data
</code></pre><p>cluster配置涵义介绍</p><ul><li><code>cluster-enabled yes|no</code> 设置加入cluster, 成为其中的节点</li><li><code>cluster-config-file &lt;filename&gt;</code> cluster配置文件名, 该文件属于自动生成, 仅用于快速查找文件并查询文件内容</li><li><code>cluster-node-timeout &lt;millseconds&gt;</code>节点服务响应超时时间, 用于判断该节点是否下线或切换为从节点</li><li><code>cluster-migration-barrier &lt;count&gt;</code> master连接的slave最小数量.</li></ul><p>复制多份配置</p><pre class="language-bash"><code class="language-bash"><span class="token function">sed</span> <span class="token string">"s/6379/6380/g"</span> redis-6379.conf <span class="token operator">></span> redis-6380.conf
<span class="token function">sed</span> <span class="token string">"s/6379/6381/g"</span> redis-6379.conf <span class="token operator">></span> redis-6381.conf
<span class="token function">sed</span> <span class="token string">"s/6379/6382/g"</span> redis-6379.conf <span class="token operator">></span> redis-6382.conf
<span class="token function">sed</span> <span class="token string">"s/6379/6383/g"</span> redis-6379.conf <span class="token operator">></span> redis-6383.conf
<span class="token function">sed</span> <span class="token string">"s/6379/6384/g"</span> redis-6379.conf <span class="token operator">></span> redis-6384.conf
</code></pre><p>启动集群(6个节点)</p><pre class="language-bash"><code class="language-bash">./src/redis-server /usr/local/redis_cluster2/redis-6379.conf
./src/redis-server /usr/local/redis_cluster2/redis-6380.conf
./src/redis-server /usr/local/redis_cluster2/redis-6381.conf
./src/redis-server /usr/local/redis_cluster2/redis-6382.conf
./src/redis-server /usr/local/redis_cluster2/redis-6383.conf
./src/redis-server /usr/local/redis_cluster2/redis-6384.conf
</code></pre><p>查看集群进程</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep redis</span>
root       4234   3582  0 16:52 pts/0    00:00:03 ./src/redis-server *:6379 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4242   3655  0 16:52 pts/1    00:00:03 ./src/redis-server *:6380 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4248   3695  0 16:52 pts/2    00:00:03 ./src/redis-server *:6381 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4258   4071  0 16:53 pts/3    00:00:03 ./src/redis-server *:6382 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4432   4273  0 16:54 pts/4    00:00:02 ./src/redis-server *:6383 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4442   4358  0 16:55 pts/6    00:00:02 ./src/redis-server *:6384 <span class="token punctuation">[</span>cluster<span class="token punctuation">]</span>
root       4587   4318  0 17:10 pts/5    00:00:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto redis
</code></pre><p>通过redis-cli客户端命令来创建集群节点 (-a 是指定密码, requirepass没有配置,可以省略)</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1 表示 1个master连接一个slave</span>
./src/redis-cli --cluster create -a 123456 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 --cluster-replicas 1
</code></pre><p>或者通过redis-trib.rb创建集群节点( 需要具有ruby环境, ruby -v查看版本)</p><pre class="language-bash"><code class="language-bash">./src/redis-trib.rb create --replicas 1 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384
</code></pre><p>查看启动集群日志</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-cli --cluster create 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 --cluster-replicas 1</span>
<span class="token operator">>></span><span class="token operator">></span> Performing <span class="token function">hash</span> slots allocation on 6 nodes<span class="token punctuation">..</span>.
Master<span class="token punctuation">[</span>0<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 0 - 5460
Master<span class="token punctuation">[</span>1<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 5461 - 10922
Master<span class="token punctuation">[</span>2<span class="token punctuation">]</span> -<span class="token operator">></span> Slots 10923 - 16383
Adding replica 127.0.0.1:6383 to 127.0.0.1:6379
Adding replica 127.0.0.1:6384 to 127.0.0.1:6380
Adding replica 127.0.0.1:6382 to 127.0.0.1:6381
<span class="token operator">>></span><span class="token operator">></span> Trying to optimize slaves allocation <span class="token keyword">for</span> anti-affinity
<span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> Some slaves are <span class="token keyword">in</span> the same host as their master <span class="token comment" spellcheck="true"># 三主三从  M S</span>
M: ac5d557520b285ea526416b09a87f199cf9c134a 127.0.0.1:6379
   slots:<span class="token punctuation">[</span>0-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master
M: a8bf9e21ea60fdf318913c988bb2019ef0d07c37 127.0.0.1:6380
   slots:<span class="token punctuation">[</span>5461-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span>5462 slots<span class="token punctuation">)</span> master
M: 622ff152ca0d0786b09a82615cc8bfb92df8c2ad 127.0.0.1:6381
   slots:<span class="token punctuation">[</span>10923-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master
S: 20a55e126d518c828e502d0a85a6eceaa420e0b3 127.0.0.1:6382
   replicates 622ff152ca0d0786b09a82615cc8bfb92df8c2ad
S: 466bef9cb5cbbd04696fbc11eed96a1de1cc4c58 127.0.0.1:6383
   replicates ac5d557520b285ea526416b09a87f199cf9c134a
S: c40dd82542d3d0e1aa6c442f0055646f5deb8e14 127.0.0.1:6384
   replicates a8bf9e21ea60fdf318913c988bb2019ef0d07c37
Can I <span class="token keyword">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span> <span class="token comment" spellcheck="true"># 覆写配置文件内容</span>
<span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated
<span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each node
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster
Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span>
<span class="token keyword">.</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using node 127.0.0.1:6379<span class="token punctuation">)</span>
M: ac5d557520b285ea526416b09a87f199cf9c134a 127.0.0.1:6379 <span class="token comment" spellcheck="true"># master 6379</span>
   slots:<span class="token punctuation">[</span>0-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master
   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 466bef9cb5cbbd04696fbc11eed96a1de1cc4c58 127.0.0.1:6383 <span class="token comment" spellcheck="true"># slave 6383</span>
   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave
   replicates ac5d557520b285ea526416b09a87f199cf9c134a
S: 20a55e126d518c828e502d0a85a6eceaa420e0b3 127.0.0.1:6382 <span class="token comment" spellcheck="true"># slave 6382</span>
   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave
   replicates 622ff152ca0d0786b09a82615cc8bfb92df8c2ad
S: c40dd82542d3d0e1aa6c442f0055646f5deb8e14 127.0.0.1:6384 <span class="token comment" spellcheck="true"># slave 6384</span>
   slots: <span class="token punctuation">(</span>0 slots<span class="token punctuation">)</span> slave
   replicates a8bf9e21ea60fdf318913c988bb2019ef0d07c37
M: a8bf9e21ea60fdf318913c988bb2019ef0d07c37 127.0.0.1:6380  <span class="token comment" spellcheck="true"># master 6380</span>
   slots:<span class="token punctuation">[</span>5461-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span>5462 slots<span class="token punctuation">)</span> master
   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: 622ff152ca0d0786b09a82615cc8bfb92df8c2ad 127.0.0.1:6381  <span class="token comment" spellcheck="true"># master 6381</span>
   slots:<span class="token punctuation">[</span>10923-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span>5461 slots<span class="token punctuation">)</span> master
   1 additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All 16384 slots covered. <span class="token comment" spellcheck="true"># 16384个槽点全部分配</span>
<span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#</span>
</code></pre><p>进入data目录查看生成的集群节点文件</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd data</span>
<span class="token punctuation">[</span>root@centos7-01 data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>
total 28
-rw-r--r--. 1 root root 175 Mar 19 17:10 dump.rdb
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6379.conf
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6380.conf
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6381.conf
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6382.conf
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6383.conf
-rw-r--r--. 1 root root 781 Mar 19 17:10 nodes-6384.conf
</code></pre><p>例如, 查看节点 nodes-6379.conf 的内容</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">### 查看节点的槽点slots分配</span>
<span class="token punctuation">[</span>root@centos7-01 data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat nodes-6379.conf</span>
ac5d557520b285ea526416b09a87f199cf9c134a 127.0.0.1:6379@16379 myself,master - 0 1647681030000 1 connected 0-5460 <span class="token comment" spellcheck="true"># slots</span>
466bef9cb5cbbd04696fbc11eed96a1de1cc4c58 127.0.0.1:6383@16383 slave ac5d557520b285ea526416b09a87f199cf9c134a 0 1647681031000 1 connected
20a55e126d518c828e502d0a85a6eceaa420e0b3 127.0.0.1:6382@16382 slave 622ff152ca0d0786b09a82615cc8bfb92df8c2ad 0 1647681031553 3 connected
c40dd82542d3d0e1aa6c442f0055646f5deb8e14 127.0.0.1:6384@16384 slave a8bf9e21ea60fdf318913c988bb2019ef0d07c37 0 1647681031247 2 connected
a8bf9e21ea60fdf318913c988bb2019ef0d07c37 127.0.0.1:6380@16380 master - 0 1647681031553 2 connected 5461-10922
622ff152ca0d0786b09a82615cc8bfb92df8c2ad 127.0.0.1:6381@16381 master - 0 1647681030220 3 connected 10923-16383
vars currentEpoch 6 lastVoteEpoch 0
</code></pre><p>查看dump.rdb文件内容 , 因为该文件是二进制, 需要借助命令<code>redis-check-rdb</code></p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ../src/redis-check-rdb dump.rdb</span>
<span class="token punctuation">[</span>offset 0<span class="token punctuation">]</span> Checking RDB <span class="token function">file</span> dump.rdb
<span class="token punctuation">[</span>offset 26<span class="token punctuation">]</span> AUX FIELD redis-ver <span class="token operator">=</span> <span class="token string">'6.2.6'</span>
<span class="token punctuation">[</span>offset 40<span class="token punctuation">]</span> AUX FIELD redis-bits <span class="token operator">=</span> <span class="token string">'64'</span>
<span class="token punctuation">[</span>offset 52<span class="token punctuation">]</span> AUX FIELD ctime <span class="token operator">=</span> <span class="token string">'1647681029'</span>
<span class="token punctuation">[</span>offset 67<span class="token punctuation">]</span> AUX FIELD used-mem <span class="token operator">=</span> <span class="token string">'2716936'</span>
<span class="token punctuation">[</span>offset 85<span class="token punctuation">]</span> AUX FIELD repl-stream-db <span class="token operator">=</span> <span class="token string">'0'</span>
<span class="token punctuation">[</span>offset 135<span class="token punctuation">]</span> AUX FIELD repl-id <span class="token operator">=</span> <span class="token string">'0575a59a98fed22a85ff99b2c0b1a5164b71d57f'</span>
<span class="token punctuation">[</span>offset 150<span class="token punctuation">]</span> AUX FIELD repl-offset <span class="token operator">=</span> <span class="token string">'0'</span>
<span class="token punctuation">[</span>offset 166<span class="token punctuation">]</span> AUX FIELD aof-preamble <span class="token operator">=</span> <span class="token string">'0'</span>
<span class="token punctuation">[</span>offset 175<span class="token punctuation">]</span> Checksum OK
<span class="token punctuation">[</span>offset 175<span class="token punctuation">]</span> \o/ RDB looks OK<span class="token operator">!</span> \o/
<span class="token punctuation">[</span>info<span class="token punctuation">]</span> 0 keys <span class="token function">read</span>
<span class="token punctuation">[</span>info<span class="token punctuation">]</span> 0 expires
<span class="token punctuation">[</span>info<span class="token punctuation">]</span> 0 already expired
</code></pre><p>集群数据共享操作 , 集群下连接客户端 ./src/redis-cli -c -p 端口. 需要注意-c不能少.</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-cli</span>
127.0.0.1:6379<span class="token operator">></span> <span class="token comment" spellcheck="true"># 默认连接上6379客户端</span>
127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name crysw <span class="token comment" spellcheck="true"># set操作失败, 说要去到 6380</span>
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> MOVED 5798 127.0.0.1:6380
127.0.0.1:6379<span class="token operator">></span>
127.0.0.1:6379<span class="token operator">></span> quit
<span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-cli -c -p 6380  # 集群连接到6380客户端</span>
127.0.0.1:6380<span class="token operator">></span> <span class="token keyword">set</span> name crysw <span class="token comment" spellcheck="true"># 设置操作ok</span>
OK
127.0.0.1:6380<span class="token operator">></span> get name
<span class="token string">"crysw"</span>
127.0.0.1:6380<span class="token operator">></span> quit
<span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-cli -c -p 6379  # 再次回到6379客户端</span>
127.0.0.1:6379<span class="token operator">></span> get name  <span class="token comment" spellcheck="true"># get操作, 可以读取到6380的数据, 实现了数据共享.</span>
-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>5798<span class="token punctuation">]</span> located at 127.0.0.1:6380
<span class="token string">"crysw"</span>
127.0.0.1:6380<span class="token operator">></span>
</code></pre><p>查看cluster节点信息</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 redis_cluster2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./src/redis-cli -c -p 6379</span>
127.0.0.1:6379<span class="token operator">></span>
127.0.0.1:6379<span class="token operator">></span> cluster nodes
ac5d557520b285ea526416b09a87f199cf9c134a 127.0.0.1:6379@16379 myself,master - 0 1647682485000 1 connected 0-5460
466bef9cb5cbbd04696fbc11eed96a1de1cc4c58 127.0.0.1:6383@16383 slave ac5d557520b285ea526416b09a87f199cf9c134a 0 1647682486000 1 connected
20a55e126d518c828e502d0a85a6eceaa420e0b3 127.0.0.1:6382@16382 slave 622ff152ca0d0786b09a82615cc8bfb92df8c2ad 0 1647682485000 3 connected
c40dd82542d3d0e1aa6c442f0055646f5deb8e14 127.0.0.1:6384@16384 slave a8bf9e21ea60fdf318913c988bb2019ef0d07c37 0 1647682486865 2 connected
a8bf9e21ea60fdf318913c988bb2019ef0d07c37 127.0.0.1:6380@16380 master - 0 1647682486559 2 connected 5461-10922
622ff152ca0d0786b09a82615cc8bfb92df8c2ad 127.0.0.1:6381@16381 master - 0 1647682486559 3 connected 10923-16383
127.0.0.1:6379<span class="token operator">></span>
</code></pre><h3 id="12-4-cluster节点操作命令"><a href="#12-4-cluster节点操作命令" class="headerlink" title="12.4 cluster节点操作命令"></a>12.4 cluster节点操作命令</h3><p><code>cluster nodes</code> 查看集群节点信息.</p><p><code>cluster replicate &lt;master-id&gt;</code> 进入一个从节点redis, 切换其主节点.</p><p><code>cluster meet ip:port</code> 发现一个新节点, 新增主节点.</p><p><code>cluster forget &lt;id&gt;</code> 忽略一个没有slot的节点.</p><p><code>cluster failover</code> 手动故障转移.</p><h2 id="13-企业级解决方案"><a href="#13-企业级解决方案" class="headerlink" title="13. 企业级解决方案"></a>13. 企业级解决方案</h2><h3 id="13-1-缓存预热"><a href="#13-1-缓存预热" class="headerlink" title="13.1 缓存预热"></a>13.1 缓存预热</h3><p>服务器启动后迅速宕机, 问题排查:</p><ul><li><p>请求数量较高.</p></li><li><p>主从之间的数据吞吐量较大, 数据同步操作频度较高.</p></li></ul><p><strong>解决方案:</strong></p><p><strong>前置准备工作:</strong></p><ul><li>日常例行统计数据访问记录, 统计访问频度较高的热点数据.</li><li>利用LRU数据删除策略, 构建数据留存队列. (storm与kafka配合)</li></ul><p><strong>准备工作:</strong></p><ul><li>将统计结果中的数据分类, 根据级别, redis优先加载级别较高的热点数据.</li><li>利用分布式多服务器同时进行数据读取, 提速数据加载过程.</li></ul><p><strong>实时:</strong></p><ul><li>使用脚本程序固定触发数据预热过程</li><li>如果条件允许, 使用了CDN(内容分发网络), 效果会更好.</li></ul><p><strong>总结:</strong></p><p>缓存预热就是系统启动前, 提前将相关的缓存数据直接加载到缓存系统. 避免在用户请求的时候, 先查询数据库, 然后再将写入缓存的问题. 用户直接查询事先被预热的缓存数据.</p><h3 id="13-2-缓存雪崩"><a href="#13-2-缓存雪崩" class="headerlink" title="13.2 缓存雪崩"></a>13.2 缓存雪崩</h3><p>数据库服务器崩溃, 以下几种:</p><ul><li>系统平稳运行过程中, 忽然数据库连接量激增.</li><li>应用服务器无法及时处理请求.</li><li>大量408, 500错误页面出现</li><li>客户反复刷新页面获取数据</li><li>数据库崩溃</li><li>应用服务器崩溃</li><li>重启应用服务器无效</li><li>Redis服务器崩溃</li><li>Redis集群崩溃</li><li>重启数据库后再次被瞬间流量放倒.</li></ul><p><strong>问题排查</strong></p><ul><li>在一个<code>较短的时间</code>内, 缓存中<code>较多</code>的key<code>集中过期</code>.</li><li>此周期内请求访问过期的数据, redis未命中, redis向数据库获取数据.</li><li>数据库同时接收到大量的请求无法及时处理.</li><li>Redis大量请求被积压, 开始出现超时现象.</li><li>数据库流量激增, 数据库崩溃.</li><li>重启后仍然面对缓存中无数据可用</li><li>Redis服务器资源被严重占用, Redis服务器崩溃</li><li>Redis集群崩塌, 集群瓦解</li><li>应用服务器无法及时得到数据响应请求, 来自客户端的请求数量越来越多, 应用服务器崩溃</li><li>应用服务器, redis, 数据库全部重启, 效果不理想.</li></ul><p><strong>解决方案(道), 设计角度</strong></p><ul><li>更多的页面静态化处理</li><li>构建多级缓存架构 (Nginx缓存 + redis缓存 + ehcache缓存)</li><li>检测MySql严重耗时业务进行优化, 对数据库的瓶颈进行排查.</li><li>灾难预警机制, 监控redis服务器性能指标 (CPU占用, CPU使用率, 内存容量, 查询平均响应时间, 线程数)</li><li>限流, 降级. 短时间范围内牺牲一些客户体验, 限制一部分请求访问, 降低应用服务器压力, 待业务低速运转后再逐步放开访问.</li></ul><p><strong>解决方案(术), 实施角度</strong></p><ul><li>LRU与LFU切换</li><li>数据有效期策略调整<ul><li>根据业务数据有效期进行分类错峰, A类90min, B类80min, C类70min</li><li>过期时间使用固定时间 + 随机值的形式, 稀释集中到期的key的数量.</li></ul></li><li>超热数据使用永久key</li><li>定期维护(自动 + 人工), 对即将过期的数据做访问量分析, 确认是否延时, 配合访问量统计做热点数据的延时.</li><li>加锁 , 慎用.</li></ul><p><strong>总结</strong></p><p>缓存雪崩就是瞬间过期数据量太大, 导致对数据库服务器造成压力, 如果能够有效避免过期时间集中, 可以有效解决雪崩现象的出现(约40%), 配合其他策略一起使用, 并监控服务器的运行数据, 根据运行记录做快速调整.</p><h3 id="13-3-缓存击穿-热点key"><a href="#13-3-缓存击穿-热点key" class="headerlink" title="13.3 缓存击穿(热点key)"></a>13.3 缓存击穿(热点key)</h3><p>系统平稳运行过程中, 数据库连接瞬间激增, Redis服务器无大量key过期, Redis内存平稳, Redis服务器CPU正常, 热点key过期, 数据库服务器压力激增, 导致数据库崩溃.</p><p><strong>问题排查</strong></p><ul><li>Redis中<code>某个key过期</code>, 该key访问量巨大.</li><li>多个数据请求从服务器直接压到Redis后, 均未命中.</li><li>Redis在短时间内发起了大量对数据库中同一数据的访问.</li></ul><p><strong>问题分析:</strong> 单个key高热数据, 短时过期.</p><p><strong>解决方案(术)</strong></p><ul><li>预先设定, 以电商为例, 每个商家根据店铺等级, 指定若干款主打商品, 在购物节期间, 加大此类信息key的过期时长.</li><li>现场调整, 监控访问量, 对自然流量激增的数据延长过期时间或设置为永久key.</li><li>后台刷新数据, 启动定时任务, 高峰期来临之前, 刷新数据有效期, 确保不丢失.</li><li>二级缓存, 设置不同的失效时间, 保障不会被<code>同时淘汰</code>就行.</li><li>加锁, 分布式锁, 防止被击穿, 但是要注意也是性能瓶颈, 慎用.</li></ul><p><strong>总结</strong></p><p>缓存击穿, 就是单个key高热数据过期的瞬间, 数据访问量较大, 未命中Redis后, 发起了大量对统一数据的数据库访问, 导致对数据库服务器造成压力, 应对策略应该在业务数据分析与预防方面进行, 配合运行监控测试与即时调整策略, 毕竟单个key的过期监控难度较高, 配合雪崩处理策略即可.</p><h3 id="13-4-缓存穿透"><a href="#13-4-缓存穿透" class="headerlink" title="13.4 缓存穿透"></a>13.4 缓存穿透</h3><p>系统平稳运行过程中, 应用服务器流量随时间增量较大, Redis服务器命中率随时间逐步降低, Redis内存平稳, CPU占用激增, 数据库服务器压力激增, 导致数据库崩溃.</p><p><strong>问题排查:</strong> Redis中出现大面积未命中, 尤其是<code>非正常URL</code>访问.</p><p><strong>问题分析:</strong></p><ul><li>获取的数据未命中Redis缓存, 在数据库中也不存在.</li><li>Redis获取到null数据未进行持久化, 直接返回.</li><li>下次此类数据到达重复上述过程, 直接返回null.</li><li>出现黑客攻击服务器.</li></ul><p><strong>解决方案(术)</strong></p><ul><li><p>缓存null, 对查询结果为null的数据进行缓存(长期使用, 定期清理), 设定短时限, 例如30-60s, 最高5min.</p></li><li><p>白名单策略</p><ul><li>提前预热各种分类数据id对应的bitmaps, id作为bitmaps的offset, 相当于设置了数据白名单, 当加载正常数据时放行, 加载异常数据时直接拦截. (效率偏低)</li><li>使用布隆过滤器 (有关布隆过滤器的命中问题对当前状况可以忽略)</li></ul></li><li><p>实施监控redis命中率, 业务正常范围时会有一个波动值, null数据的占比.</p><ul><li>非活动时段波动: 通常检测3-5倍, 超过5倍纳入重点排查对象</li><li>活动时间波动: 通常检测10-50倍, 超过50倍纳入重点排查对象.</li></ul><p>根据倍数不同, 启动不同的排查流程. 然后使用黑名单进行防控运营.</p></li><li><p>key加密, 问题出现后临时启动防灾业务key, 对key进行业务层传输加密服务, 设定校验程序, 对请求的key校验.</p></li></ul><h3 id="13-5-性能指标监控"><a href="#13-5-性能指标监控" class="headerlink" title="13.5 性能指标监控"></a>13.5 性能指标监控</h3><ul><li><p>性能指标: Performance</p></li><li><p>内存指标: Memory</p></li><li><p>基本活动指标: Basic activity</p></li><li><p>持久性指标: Persistence<br>准备工作:**</p></li><li><p>日常例行统计数据访问记录, 统计访问频度较高的热点数据.</p></li><li><p>利用LRU数据删除策略, 构建数据留存队列. (storm与kafka配合)</p></li></ul><p><strong>准备工作:</strong></p><ul><li>将统计结果中的数据分类, 根据级别, redis优先加载级别较高的热点数据.</li><li>利用分布式多服务器同时进行数据读取, 提速数据加载过程.</li></ul><p><strong>实时:</strong></p><ul><li>使用脚本程序固定触发数据预热过程</li><li>如果条件允许, 使用了CDN(内容分发网络), 效果会更好.</li></ul><p><strong>总结:</strong></p><p>缓存预热就是系统启动前, 提前将相关的缓存数据直接加载到缓存系统. 避免在用户请求的时候, 先查询数据库, 然后再将写入缓存的问题. 用户直接查询事先被预热的缓存数据.</p><h3 id="13-2-缓存雪崩-1"><a href="#13-2-缓存雪崩-1" class="headerlink" title="13.2 缓存雪崩"></a>13.2 缓存雪崩</h3><p>数据库服务器崩溃, 以下几种:</p><ul><li>系统平稳运行过程中, 忽然数据库连接量激增.</li><li>应用服务器无法及时处理请求.</li><li>大量408, 500错误页面出现</li><li>客户反复刷新页面获取数据</li><li>数据库崩溃</li><li>应用服务器崩溃</li><li>重启应用服务器无效</li><li>Redis服务器崩溃</li><li>Redis集群崩溃</li><li>重启数据库后再次被瞬间流量放倒.</li></ul><p><strong>问题排查</strong></p><ul><li>在一个<code>较短的时间</code>内, 缓存中<code>较多</code>的key<code>集中过期</code>.</li><li>此周期内请求访问过期的数据, redis未命中, redis向数据库获取数据.</li><li>数据库同时接收到大量的请求无法及时处理.</li><li>Redis大量请求被积压, 开始出现超时现象.</li><li>数据库流量激增, 数据库崩溃.</li><li>重启后仍然面对缓存中无数据可用</li><li>Redis服务器资源被严重占用, Redis服务器崩溃</li><li>Redis集群崩塌, 集群瓦解</li><li>应用服务器无法及时得到数据响应请求, 来自客户端的请求数量越来越多, 应用服务器崩溃</li><li>应用服务器, redis, 数据库全部重启, 效果不理想.</li></ul><p><strong>解决方案(道), 设计角度</strong></p><ul><li>更多的页面静态化处理</li><li>构建多级缓存架构 (Nginx缓存 + redis缓存 + ehcache缓存)</li><li>检测MySql严重耗时业务进行优化, 对数据库的瓶颈进行排查.</li><li>灾难预警机制, 监控redis服务器性能指标 (CPU占用, CPU使用率, 内存容量, 查询平均响应时间, 线程数)</li><li>限流, 降级. 短时间范围内牺牲一些客户体验, 限制一部分请求访问, 降低应用服务器压力, 待业务低速运转后再逐步放开访问.</li></ul><p><strong>解决方案(术), 实施角度</strong></p><ul><li>LRU与LFU切换</li><li>数据有效期策略调整<ul><li>根据业务数据有效期进行分类错峰, A类90min, B类80min, C类70min</li><li>过期时间使用固定时间 + 随机值的形式, 稀释集中到期的key的数量.</li></ul></li><li>超热数据使用永久key</li><li>定期维护(自动 + 人工), 对即将过期的数据做访问量分析, 确认是否延时, 配合访问量统计做热点数据的延时.</li><li>加锁 , 慎用.</li></ul><p><strong>总结</strong></p><p>缓存雪崩就是瞬间过期数据量太大, 导致对数据库服务器造成压力, 如果能够有效避免过期时间集中, 可以有效解决雪崩现象的出现(约40%), 配合其他策略一起使用, 并监控服务器的运行数据, 根据运行记录做快速调整.</p><h3 id="13-3-缓存击穿-热点key-1"><a href="#13-3-缓存击穿-热点key-1" class="headerlink" title="13.3 缓存击穿(热点key)"></a>13.3 缓存击穿(热点key)</h3><p>系统平稳运行过程中, 数据库连接瞬间激增, Redis服务器无大量key过期, Redis内存平稳, Redis服务器CPU正常, 热点key过期, 数据库服务器压力激增, 导致数据库崩溃.</p><p><strong>问题排查</strong></p><ul><li>Redis中<code>某个key过期</code>, 该key访问量巨大.</li><li>多个数据请求从服务器直接压到Redis后, 均未命中.</li><li>Redis在短时间内发起了大量对数据库中同一数据的访问.</li></ul><p><strong>问题分析:</strong> 单个key高热数据, 短时过期.</p><p><strong>解决方案(术)</strong></p><ul><li>预先设定, 以电商为例, 每个商家根据店铺等级, 指定若干款主打商品, 在购物节期间, 加大此类信息key的过期时长.</li><li>现场调整, 监控访问量, 对自然流量激增的数据延长过期时间或设置为永久key.</li><li>后台刷新数据, 启动定时任务, 高峰期来临之前, 刷新数据有效期, 确保不丢失.</li><li>二级缓存, 设置不同的失效时间, 保障不会被<code>同时淘汰</code>就行.</li><li>加锁, 分布式锁, 防止被击穿, 但是要注意也是性能瓶颈, 慎用.</li></ul><p><strong>总结</strong></p><p>缓存击穿, 就是单个key高热数据过期的瞬间, 数据访问量较大, 未命中Redis后, 发起了大量对统一数据的数据库访问, 导致对数据库服务器造成压力, 应对策略应该在业务数据分析与预防方面进行, 配合运行监控测试与即时调整策略, 毕竟单个key的过期监控难度较高, 配合雪崩处理策略即可.</p><h3 id="13-4-缓存穿透-1"><a href="#13-4-缓存穿透-1" class="headerlink" title="13.4 缓存穿透"></a>13.4 缓存穿透</h3><p>系统平稳运行过程中, 应用服务器流量随时间增量较大, Redis服务器命中率随时间逐步降低, Redis内存平稳, CPU占用激增, 数据库服务器压力激增, 导致数据库崩溃.</p><p><strong>问题排查:</strong> Redis中出现大面积未命中, 尤其是<code>非正常URL</code>访问.</p><p><strong>问题分析:</strong></p><ul><li>获取的数据未命中Redis缓存, 在数据库中也不存在.</li><li>Redis获取到null数据未进行持久化, 直接返回.</li><li>下次此类数据到达重复上述过程, 直接返回null.</li><li>出现黑客攻击服务器.</li></ul><p><strong>解决方案(术)</strong></p><ul><li><p>缓存null, 对查询结果为null的数据进行缓存(长期使用, 定期清理), 设定短时限, 例如30-60s, 最高5min.</p></li><li><p>白名单策略</p><ul><li>提前预热各种分类数据id对应的bitmaps, id作为bitmaps的offset, 相当于设置了数据白名单, 当加载正常数据时放行, 加载异常数据时直接拦截. (效率偏低)</li><li>使用布隆过滤器 (有关布隆过滤器的命中问题对当前状况可以忽略)</li></ul></li><li><p>实施监控redis命中率, 业务正常范围时会有一个波动值, null数据的占比.</p><ul><li>非活动时段波动: 通常检测3-5倍, 超过5倍纳入重点排查对象</li><li>活动时间波动: 通常检测10-50倍, 超过50倍纳入重点排查对象.</li></ul><p>根据倍数不同, 启动不同的排查流程. 然后使用黑名单进行防控运营.</p></li><li><p>key加密, 问题出现后临时启动防灾业务key, 对key进行业务层传输加密服务, 设定校验程序, 对请求的key校验.</p></li></ul><h3 id="13-5-性能指标监控-1"><a href="#13-5-性能指标监控-1" class="headerlink" title="13.5 性能指标监控"></a>13.5 性能指标监控</h3><ul><li>性能指标: Performance</li><li>内存指标: Memory</li><li>基本活动指标: Basic activity</li><li>持久性指标: Persistence</li><li>错误指标: Error</li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">王子</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://www.crystalblog.xyz/2022032060276.html">https://www.crystalblog.xyz/2022032060276.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">王子</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Redis/"><span class="chip bg-color">Redis</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid="></script><div class="addthis_inline_share_toolbox"></div></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechatPay.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(https://cdn.jsdelivr.net/gh/drew233/cdn/20200409110727.webp) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}.v[data-class="v"] .vwrap .vheader .vinput{width:32%;border-bottom:1px dashed #dedede}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine2/Valine2.min.js"></script><script>let metaPlaceholder={nick:"昵称/QQ号(必填)",mail:"邮箱(必填)",link:"网址(https://)"};new Valine({el:"#vcomments",appId:"NiVMV7aR8ipVDy9EywBYtLwI-MdYXbMMI",appKey:"P7BGA1hMeBAFbHYz3dKY8doJ",notify:!1,verify:!0,visitor:!0,avatar:"monsterid",pageSize:"10",lang:"zh-CN",placeholder:"填写QQ号就能评论，快来一发吧~",meta:["nick","mail","link"],recordIP:!0,enableQQ:"monsterid",requiredFields:["nick","mail","link"],master:["e4de1f6da602d22e423d6dfb24611b6b"],friends:["410739a5ad278251b305dab085768c57","410739a5ad278251b305dab085768c57","410739a5ad278251b305dab085768c57"],tagMeta:["博主","小伙伴","访客"],metaPlaceholder:metaPlaceholder}),document.body.addEventListener("click",function(e){if(e.target.classList.contains("vsubmit")){var a=document.querySelector("input[type=email]"),t=document.querySelector("input[name=nick]");const i=/^[A-Za-z0-9_-\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;if(!a.value||!t.value||!i.test(a.value)){const n=document.querySelector(".vmark");n.innerHTML='<div class="valert txt-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>',n.style.display="block",e.stopPropagation(),setTimeout(function(){n.style.display="none",n.innerHTML=""},2500)}}},!0)</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/2022040548893.html"><div class="card-image"><img src="https://cn.bing.com/th?id=OHR.BeltedGalloway_ZH-CN8570849064_1920x1080.jpg&rf=LaDigue_1920x1080.jpg" class="responsive-img" alt="Redis高级1"> <span class="card-title">Redis高级1</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Redis</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-04-05 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/NoSQL/" class="post-category">NoSQL</a></span></div></div><div class="card-action article-tags"><a href="/tags/Redis/"><span class="chip bg-color">Redis</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2022030714893.html"><div class="card-image"><img src="https://cn.bing.com/th?id=OHR.ZugspitzeGipfelstation_ZH-CN6120971585_1920x1080.jpg&rf=LaDigue_1920x1080.jpg" class="responsive-img" alt="面试题-消息中间件专题"> <span class="card-title">面试题-消息中间件专题</span></div></a><div class="card-content article-content"><div class="summary block-with-text">消息中间件面试题</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-03-07 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/" class="post-category">面试相关</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="chip bg-color">消息中间件</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0!==window.getSelection&&((""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: Crysw&#39;s Blog<br />文章作者: 王子<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)))})</script><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h2, h3, h4"});let t=0,e="toc-heading-";$("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h2, h3, h4").each(function(){$(this).attr("id",e+ ++t)});let n=parseInt(.4*$(window).height()-64),o=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>n?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});const i="expanded";let c=$("#toc-aside"),l=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){c.hasClass(i)?(c.removeClass(i).hide(),l.removeClass("l9")):(c.addClass(i).show(),l.addClass("l9")),function(t,e){let n=$("#"+t);if(0!==n.length){let t=n.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#"+e).width(t)}}("artDetail","prenext-posts")})})</script></main><a onclick="switchNightMode()" id="sma"><i class="fa fa-moon-o" id="nightMode" aria-hidden="true"></i></a><footer class="page-footer bg-color"><link rel="stylesheet" href="/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="tencent" type="playlist" id="7278393642" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2022</span> <i class="fa fa-heart" style="color:#ff71a8"></i> <a href="/about" target="_blank">王子</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span style="margin-left:-20px;display:inline">&nbsp; <i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">255.4k</span> <span><span id="busuanzi_container_site_pv" style="display:inline">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span> </span><span id="busuanzi_container_site_uv" style="display:inline">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),a=e.getMonth()+1,r=e.getDate(),i=e.getHours(),o=e.getMinutes(),s=e.getSeconds(),e=Date.UTC(t,"8","8","8","8","8"),a=Date.UTC(n,a,r,i,o,s)-e,r=Math.floor(a/31536e6),i=Math.floor(a/864e5-365*r),o=Math.floor(a/36e5-365*r*24-24*i),s=Math.floor(a/6e4-365*r*24*60-24*i*60-60*o),e=Math.floor(a/1e3-365*r*24*60*60-24*i*60*60-60*o*60-60*s);t===String(n)?(document.getElementById("year").innerHTML=n,a="This site has been running for "+i+" days",a="本站已运行 "+i+" 天",document.getElementById("sitetime").innerHTML=a):(document.getElementById("year").innerHTML=t+" - "+n,n="This site has been running for "+r+" years and "+i+" days",n="本站已运行 "+r+" 年 "+i+" 天 "+o+" 小时 "+s+" 分钟 "+e+" 秒",document.getElementById("sitetime").innerHTML=n)},timer=setInterval(calcSiteTime)</script>&nbsp;|&nbsp; <span id="icp"><img src="/medias/icp.png" style="vertical-align:text-bottom"> <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备20002108号</a></span></span></div><div class="col s12 m4 l4 social-link social-statis"><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1848276756" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1848276756" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="mailto:wang-qz@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我: wang-qz@foxmail.com" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="https://gitee.com/wang-qz" class="tooltipped" target="_blank" data-tooltip="码云" data-position="top" data-delay="50"><i class="fab fa-github-alt"></i> </a><a href="https://blog.csdn.net/u013044713" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN" data-position="top" data-delay="50"><i class="fab fa-csdn">C</i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script>let _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?147475454185ebcf440a27cc35e793ef";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">$(function(){!function(t,r,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),t=document.getElementById(r),n=document.getElementById(s);t.addEventListener("input",function(){var o='<ul class="search-result-list">',h=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n,e,r,s=!0,i=t.title.trim().toLowerCase(),l=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),a=0===(a=t.url).indexOf("/")?t.url:"/"+a,c=-1,u=-1;""!==i&&""!==l&&h.forEach(function(t,e){n=i.indexOf(t),c=l.indexOf(t),n<0&&c<0?s=!1:(c<0&&(c=0),0===e&&(u=c))}),s&&(o+="<li><a href='"+a+"' class='search-result-title'>"+i+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=u&&(a=u+80,(a=0===(t=(t=u-20)<0?0:t)?100:a)>e.length&&(a=e.length),r=e.substr(t,a),h.forEach(function(t){var e=new RegExp(t,"gi");r=r.replace(e,'<em class="search-keyword">'+t+"</em>")}),o+='<p class="search-result">'+r+"...</p>"),o+="</li>")}),o+="</ul>",n.innerHTML=o)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script src="/js/funnyTitle.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript" color="0,0,255" pointcolor="0,0,255" opacity="0.7" zindex="-1" count="99" src="/libs/background/canvas-nest.js"></script><script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script src="/js/wenzi.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/miku.model.json"},display:{position:"right",width:150,height:190,hOffset:50,vOffset:-5},mobile:{show:!1,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html>