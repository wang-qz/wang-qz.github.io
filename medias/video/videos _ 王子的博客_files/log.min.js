!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self,t.Weblog=e())}(this,function(){"use strict";function t(t){for(var e=(this.document||this.ownerDocument).querySelectorAll(t),n=e.length;--n>=0&&e.item(n)!==this;);return n>-1}function e(t,e,n,r){void 0===r&&(r={});var o=encodeURIComponent(t)+"="+(n?encodeURIComponent(e):e),i=r.expires,a=r.path||"/",s=r.domain||"";return i instanceof Date&&(o+="; expires="+i.toUTCString()),"number"==typeof i&&(o+="; max-age=="+i),""!==a&&(o+="; path="+a),""!==s&&(o+="; domain="+s),!0===r.secure&&(o+="; secure"),o}function n(t,e,n){void 0===n&&(n={});var r={};if(t.length>0)for(var o=!1===e?function(t){return t}:decodeURIComponent,i=t.split(/;\s/g),a=null,s=null,u=null,c=0,f=i.length;c<f;c++){if(null!==(u=i[c].match(/([^=]+)=/i)))try{a=decodeURIComponent(u[1]),s=o(i[c].substring(u[1].length+1))}catch(t){}else a=decodeURIComponent(i[c]),s="";null!==a&&(r[a]=s)}return r}function r(){var t=navigator.userAgent;if(!t||/bot|spider/.test(t))return"UNKNOWN2";var e=t.indexOf("Android")>-1,n=/\(i[^;]+;( U;)? CPU.+Mac OS X/.test(t);return e?"OUTSIDE_ANDROID_H5":n?"OUTSIDE_IOS_H5":"PC_WEB"}function o(t){if(void 0===t&&(t=location.hostname),!t)return"";var e=t.split("."),n=e.length;return n<=2?"":"."+e[n-2]+"."+e[n-1]}function i(t,e){if(void 0===e&&(e={}),!document.cookie)return null;var r=n(document.cookie,!e.raw,e)[t];return void 0===r?null:r}function a(t,n,r){void 0===r&&(r={}),document.cookie=e(t,n,!r.raw,r)}function s(t,e){var n=-1,r=t;return function(){clearTimeout(n);var o=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;o&&(r=function(){o(t)}),n=window.setTimeout(r,e)}}function u(t){return"[object Object]"===W.call(t)}function c(t){return Array.isArray?Array.isArray(t):"[object Array]"===W.call(t)}function f(t){return"[object String]"===W.call(t)}function l(t){return!u(t)&&t.nodeType>0}function d(){for(var t=1e9*Math.random()>>>0,e=[],n=0;n<7;n++)e.push("0123456789ABCDEF".charAt(16*Math.random()));return t+e.join("")}function p(){var t=navigator.userAgent,e=i("_did"),n="web";/Android|iPhone/.test(t)&&(n="H5");var r=new Date;r.setFullYear(r.getFullYear()+1);var s=e||n+"_"+d();return a("_did",s,{expires:r,domain:o(),path:"/"}),s}function h(){var t=d();return a("session_id",t),t}function m(t,e){return t.indexOf(e)>-1}function g(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)}function v(){return!!(window.ActiveXObject||"ActiveXObject"in window)&&(new RegExp("MSIE (\\d+\\.\\d+);").test(navigator.userAgent),parseFloat(RegExp.$1))}function y(t,e,n,r){return window.attachEvent?t.attachEvent("on"+e,n):t.addEventListener(e,n,r)}function w(t,e,n,r){return window.attachEvent?t.detachEvent("on"+e,n):t.removeEventListener(e,n,r)}function b(){var t=document.getElementById("weblog-js");if(t)return t;if(document.currentScript)return document.currentScript;for(var e=document.getElementsByTagName("script"),n=e.length-1;n>=0;n--){var r=e[n];if("interactive"===r.readyState)return r}return e[e.length-1]||null}function _(t){return setTimeout(t,62.5)}function I(t,e){function n(){this.constructor=t}Z(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function O(t){var e={},n=t.split("?");if(n.length<=1)return e;for(var r=(n=n[1].split("&")).length,o=0;o<r;o++){var i=n[o].split("=");e[i[0]]=i[1]}return e}function E(){return tt({},at)}function C(t,e,n){return void 0===n&&(n="CLICK_EVENT"),{type:n,data:{name:t,client_timestamp:(new Date).getTime(),params:e}}}function L(){if(!sessionStorage)return it.fresh;var t=sessionStorage.getItem("pre_url");return t&&t===location.href?it.reload:""===document.referrer||-1===document.referrer.indexOf(location.origin)?it.fresh:0===document.referrer.indexOf(location.origin)?it.inner:it.outer}function S(){var t=L();return t===it.reload||t===it.fresh||t===it.outer}function T(){sessionStorage&&sessionStorage.setItem("pre_url",location.href)}function j(t){return lt.fromOuter()?"_self_"+dt.page_id:"_"+dt.page_id+"_"+t}function A(t){console&&console.warn&&console.warn(t)}function M(){M.init.call(this)}function k(t){return void 0===t._maxListeners?M.defaultMaxListeners:t._maxListeners}function D(t,e,n,r){var o,i,a;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(i=t._events,void 0===i?(i=t._events=Object.create(null),t._eventsCount=0):(void 0!==i.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),i=t._events),a=i[e]),void 0===a)a=i[e]=n,++t._eventsCount;else if("function"==typeof a?a=i[e]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),(o=k(t))>0&&a.length>o&&!a.warned){a.warned=!0;var s=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");s.name="MaxListenersExceededWarning",s.emitter=t,s.type=e,s.count=a.length,A(s)}return t}function x(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,Ot(this.listener,this.target,t))}function N(t,e,n){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},o=x.bind(r);return o.listener=n,r.wrapFn=o,o}function R(t,e,n){var r=t._events;if(void 0===r)return[];var o=r[e];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?U(o):P(o,o.length)}function F(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function P(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}function q(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function U(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function B(){return"CSS1Compat"===document.compatMode}function K(t){return t.currentStyle?t.currentStyle:window.getComputedStyle(t,null)}function V(){var t=B()?document.documentElement:document.body;return{width:t.clientWidth,height:t.clientHeight}}function H(t,e){var n=typeof t.getBoundingClientRect;if("function"!==n&&"object"!==n)return console.error("您的浏览器不支持getBoundingClientRect方法"),!1;var r=K(t),o=/(none|contents|unset|initial|table-column|table-column-group|table-footer-group|table-row|table-row-group)/gi,i=/(hidden|collapse)/gi,a=r.width?r.width:null,s=r.height?r.height:null;if("0px"===a||"0px"===s||o.test(r.display)||i.test(r.visibility)||r&&+r.opacity<=0)return!1;var u=t.getBoundingClientRect();if(e){for(;e!==document;){var c=e.getBoundingClientRect();if(u.bottom<=c.top||u.right<=c.left||u.top>=c.bottom||u.left>=c.right)return!1;e=e.parentNode}return!0}var f=V();return!(u.top>=f.height||u.bottom<=0||u.left>=f.width||u.right<=0)}function z(t,e){if(t.contains&&1===e.nodeType)return t===e||t.contains(e);if(void 0!==t.compareDocumentPosition)return t===e||!!(16&t.compareDocumentPosition(e));for(;e&&t!==e;)e=e.parentNode;return e===t}var W=Object.prototype.toString;Object.freeze||(Object.freeze=function(t){return t}),(window.Element.toString().indexOf("[native code]")>-1||window.Element.toString().indexOf("[object Element]")>-1)&&(Element.prototype._matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||t);var G=clearTimeout,J=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||_,Q=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||G,X=Object.freeze({resolvePlatform:r,resolveTopLevelDomain:o,getCookie:i,setCookie:a,debounce:s,isPlainObject:u,isArray:c,isString:f,isNodeLike:l,nanoId:d,generateDID:p,generateSessionID:h,inArray:m,deleteArray:g,needCompatible:v,addMonitor:y,removeMonitor:w,getCurrentScript:b,raf:J,caf:Q}),Y=v();Y&&Y<=8&&(Object.defineProperty=function(t,e,n){t[e]="[object Object]"===Object.prototype.toString.call(n)&&n.hasOwnProperty("value")?n.value:n}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),n=1;n<arguments.length;n++){var r=arguments[n];if(null!==r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},writable:!0,configurable:!0}),Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice.call(arguments,1),n=this,r=function(){function t(){}return t}(),o=function(){var o=this instanceof r?this:t;return n.apply(o,e.concat(Array.prototype.slice.call(arguments)))};return this.prototype&&(r.prototype=this.prototype),o.prototype=new r,o}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;if(null==this)throw new TypeError('"this" is null or not defined');var r=Object(this),o=r.length>>>0;if(0===o)return-1;var i=+e||0;if(Math.abs(i)===1/0&&(i=0),i>=o)return-1;for(n=Math.max(i>=0?i:o-Math.abs(i),0);n<o;){if(n in r&&r[n]===t)return n;n++}return-1});var $,Z=function(t,e){return(Z=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},tt=function(){return(tt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t}).apply(this,arguments)},et=function(){function t(){this.iframe=null,this.form=null,this.iframeName="",this.createForm()}return t.prototype.createIframe=function(){var t=document.createElement("iframe"),e=v();document.body.appendChild(t),e&&e<7&&(t.src='javascript:""'),this.iframeName="ac_frame_"+d(),t.contentWindow.name=this.iframeName;var n=t.style;n.visibility="hidden",n.width=n.height="10px",n.display="none",n.marginTop=n.marginLeft="10px",this.iframe=t},t.prototype.createForm=function(){var t=document.createElement("form"),e=t.style;e.position="absolute",e.visibility="hidden",e.top=e.left="-10px",e.width=e.height="10px",e.overflow="hidden",document.body.appendChild(t),this.form=t},t.prototype.createInputs=function(t,e){var n=document.createElement("input");n.style.visibility="hidden",n.name="data",n.value=e,t.appendChild(n)},t.prototype.clearIframe=function(){document.body.removeChild(this.iframe),this.iframe=null},t.prototype.clearForm=function(){document.body.removeChild(this.form),this.form=null},t.prototype.open=function(t,e,n){var r=this.form,o=t?t.toUpperCase():"GET";r.method=o,"GET"===o&&this.createInputs(r,O(e)),r.action=String(e)},t.prototype.send=function(t){this.createIframe(),t&&this.createInputs(this.form,t),this.sendForm(),this.clearForm()},t.prototype.sendForm=function(){var t=this.form;t.target=this.iframeName||"";try{t.submit()}catch(t){}},t}(),nt=function(){function t(t,e){this.errLogMap={},this.errTryMap={},this.errLogId=[],this.logQueue=[],this.waitTimer=null,this.isInitBeforeunload=!1,this.baseData={},this.config={url:"",retries:0,maxErrLog:100,timeout:3e4,async:!0,useBeacon:!1,wait:1e3,maxBatchLength:100,lazy:!1,method:"POST"},this.init(t,e),this.initBeforeunload()}return t.prototype.init=function(t,e){return Object.assign(this.config,t),this.config.url?"number"!=typeof this.config.retries||Math.ceil(this.config.retries)!==this.config.retries?void console.error("retries must be a positive integer"):void Object.assign(this.baseData,e):void console.error("url must be set")},t.prototype.unload=function(){this.logQueue.length&&this.sendData({async:!1})},t.prototype.initBeforeunload=function(){var t="onpagehide"in window?"pagehide":"beforeunload";this.unloadHandler=this.unload.bind(this),y(window,t,this.unloadHandler)},t.prototype.removeUnload=function(){var t="onpagehide"in window?"pagehide":"beforeunload";this.unloadHandler=this.unload.bind(this),w(window,t,this.unloadHandler)},t.prototype.send=function(t){var e=this;if(this.config.lazy)return void this.logQueue.push(t);clearTimeout(this.waitTimer),this.logQueue.length<this.config.maxBatchLength?(this.logQueue.push(t),this.waitTimer=setTimeout(function(){e.sendData(),e.logQueue=[]},this.config.wait)):(this.sendData(),this.logQueue=[])},t.prototype.sendData=function(t){var e=this,n=void 0===t?{}:t,r=n.data,o=n.id,i=n.async,a=this.config,s=r||this.logQueue,u=o||d(),c="boolean"==typeof i?i:a.async,f=s.length;if(f)for(var l=0;l<f;l++){var p=s[l];p.data.name=p.data.name.toUpperCase()}var h=JSON.stringify({base:this.baseData,events:s});if(a.useBeacon&&navigator.sendBeacon)navigator.sendBeacon(a.url,h)||(this.errHandler({id:u,data:s}),this.walkErrLog());else{var g=v(),y=g&&(8===g||9===g)?new et:new XMLHttpRequest;y.open("POST",a.url,c),c&&(y.timeout=a.timeout),y.onload=function(){y.status>=200&&y.status<300||304===y.status?m(e.errLogId,u)&&e.removeErrLog():(e.errHandler({id:u,data:s}),e.walkErrLog())},y.ontimeout=y.onerror=function(){e.errHandler({id:u,data:s}),e.walkErrLog()},y.send(h)}},t.prototype.errHandler=function(t){var e=t.data,n=t.id;this.config.retries&&(this.errLogId.length<this.config.maxErrLog?(m(this.errLogId,n)||(this.errLogId.push(n),this.errLogMap[n]=e),this.errTryMap[n]=this.errTryMap[n]?this.errTryMap[n]+1:1):console.error("错误日志溢出"))},t.prototype.removeErrLog=function(t){g(this.errLogId,t),this.errLogMap[t]=null,this.errTryMap[t]=null},t.prototype.walkErrLog=function(){var t=this;if(this.errLogId.length){var e=this.errLogId.shift();if(this.errTryMap[e]){if(this.errTryMap[e]>this.config.retries)return void this.removeErrLog();setTimeout(function(){t.sendData({data:t.errLogMap[e],id:e})})}}},t}(),rt="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},ot=function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t){!function(e){function n(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function r(t,e){return t<<e|t>>>32-e}function o(t,e,o,i,a,s){return n(r(n(n(e,t),n(i,s)),a),o)}function i(t,e,n,r,i,a,s){return o(e&n|~e&r,t,e,i,a,s)}function a(t,e,n,r,i,a,s){return o(e&r|n&~r,t,e,i,a,s)}function s(t,e,n,r,i,a,s){return o(e^n^r,t,e,i,a,s)}function u(t,e,n,r,i,a,s){return o(n^(e|~r),t,e,i,a,s)}function c(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;var r,o,c,f,l,d=1732584193,p=-271733879,h=-1732584194,m=271733878;for(r=0;r<t.length;r+=16)o=d,c=p,f=h,l=m,p=u(p=u(p=u(p=u(p=s(p=s(p=s(p=s(p=a(p=a(p=a(p=a(p=i(p=i(p=i(p=i(p,h=i(h,m=i(m,d=i(d,p,h,m,t[r],7,-680876936),p,h,t[r+1],12,-389564586),d,p,t[r+2],17,606105819),m,d,t[r+3],22,-1044525330),h=i(h,m=i(m,d=i(d,p,h,m,t[r+4],7,-176418897),p,h,t[r+5],12,1200080426),d,p,t[r+6],17,-1473231341),m,d,t[r+7],22,-45705983),h=i(h,m=i(m,d=i(d,p,h,m,t[r+8],7,1770035416),p,h,t[r+9],12,-1958414417),d,p,t[r+10],17,-42063),m,d,t[r+11],22,-1990404162),h=i(h,m=i(m,d=i(d,p,h,m,t[r+12],7,1804603682),p,h,t[r+13],12,-40341101),d,p,t[r+14],17,-1502002290),m,d,t[r+15],22,1236535329),h=a(h,m=a(m,d=a(d,p,h,m,t[r+1],5,-165796510),p,h,t[r+6],9,-1069501632),d,p,t[r+11],14,643717713),m,d,t[r],20,-373897302),h=a(h,m=a(m,d=a(d,p,h,m,t[r+5],5,-701558691),p,h,t[r+10],9,38016083),d,p,t[r+15],14,-660478335),m,d,t[r+4],20,-405537848),h=a(h,m=a(m,d=a(d,p,h,m,t[r+9],5,568446438),p,h,t[r+14],9,-1019803690),d,p,t[r+3],14,-187363961),m,d,t[r+8],20,1163531501),h=a(h,m=a(m,d=a(d,p,h,m,t[r+13],5,-1444681467),p,h,t[r+2],9,-51403784),d,p,t[r+7],14,1735328473),m,d,t[r+12],20,-1926607734),h=s(h,m=s(m,d=s(d,p,h,m,t[r+5],4,-378558),p,h,t[r+8],11,-2022574463),d,p,t[r+11],16,1839030562),m,d,t[r+14],23,-35309556),h=s(h,m=s(m,d=s(d,p,h,m,t[r+1],4,-1530992060),p,h,t[r+4],11,1272893353),d,p,t[r+7],16,-155497632),m,d,t[r+10],23,-1094730640),h=s(h,m=s(m,d=s(d,p,h,m,t[r+13],4,681279174),p,h,t[r],11,-358537222),d,p,t[r+3],16,-722521979),m,d,t[r+6],23,76029189),h=s(h,m=s(m,d=s(d,p,h,m,t[r+9],4,-640364487),p,h,t[r+12],11,-421815835),d,p,t[r+15],16,530742520),m,d,t[r+2],23,-995338651),h=u(h,m=u(m,d=u(d,p,h,m,t[r],6,-198630844),p,h,t[r+7],10,1126891415),d,p,t[r+14],15,-1416354905),m,d,t[r+5],21,-57434055),h=u(h,m=u(m,d=u(d,p,h,m,t[r+12],6,1700485571),p,h,t[r+3],10,-1894986606),d,p,t[r+10],15,-1051523),m,d,t[r+1],21,-2054922799),h=u(h,m=u(m,d=u(d,p,h,m,t[r+8],6,1873313359),p,h,t[r+15],10,-30611744),d,p,t[r+6],15,-1560198380),m,d,t[r+13],21,1309151649),h=u(h,m=u(m,d=u(d,p,h,m,t[r+4],6,-145523070),p,h,t[r+11],10,-1120210379),d,p,t[r+2],15,718787259),m,d,t[r+9],21,-343485551),d=n(d,o),p=n(p,c),h=n(h,f),m=n(m,l);return[d,p,h,m]}function f(t){var e,n="",r=32*t.length;for(e=0;e<r;e+=8)n+=String.fromCharCode(t[e>>5]>>>e%32&255);return n}function l(t){var e,n=[];for(n[(t.length>>2)-1]=void 0,e=0;e<n.length;e+=1)n[e]=0;var r=8*t.length;for(e=0;e<r;e+=8)n[e>>5]|=(255&t.charCodeAt(e/8))<<e%32;return n}function d(t){return f(c(l(t),8*t.length))}function p(t,e){var n,r,o=l(t),i=[],a=[];for(i[15]=a[15]=void 0,o.length>16&&(o=c(o,8*t.length)),n=0;n<16;n+=1)i[n]=909522486^o[n],a[n]=1549556828^o[n];return r=c(i.concat(l(e)),512+8*e.length),f(c(a.concat(r),640))}function h(t){var e,n,r="";for(n=0;n<t.length;n+=1)e=t.charCodeAt(n),r+="0123456789abcdef".charAt(e>>>4&15)+"0123456789abcdef".charAt(15&e);return r}function m(t){return unescape(encodeURIComponent(t))}function g(t){return d(m(t))}function v(t){return h(g(t))}function y(t,e){return p(m(t),m(e))}function w(t,e){return h(y(t,e))}function b(t,e,n){return e?n?y(e,t):w(e,t):n?g(t):v(t)}t.exports?t.exports=b:e.md5=b}(rt)});!function(t){t.none="NOT_CONNECTED",t.wifi="WIFI",t["4g"]="MOBILE_4G",t["3g"]="MOBILE_3G",t["2g"]="MOBILE_2G",t["slow-2g"]="MOBILE_2G"}($||($={}));var it,at={cookie_id:"",session_id:i("session_id")||h(),user_id:i("auth_key")||"",page_id:ot(location.href),refer_page_id:document.referrer?ot(document.referrer):"",refer_show_id:"2.0.6",refer_url:document.referrer,url:location.href,platform:r(),client_id:"19",product:"ACFUN_WEB",log_time:(new Date).getTime(),crid:p(),screen:window.screen.width+"*"+window.screen.height,brower_language:navigator.language,is_embedded:window.top===window?0:1,network:function(){var t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!t)return"UNKNOWN";var e=t.type,n=t.effectiveType;return $[e]||$[n]||"UNKNOWN"}()},st={url:"https://log-sdk.gifshow.com/rest/wd/common/log/collect/acfun",retries:0,lazy:!0},ut={autoPV:!0},ct=function(){function t(t,e){void 0===e&&(e={}),this.logConfig=tt({},st),this.options=tt({},ut),this.plugins=[],Object.assign(this.logConfig,t),Object.assign(this.options,e);var n=tt({},E());Object.assign(n,e.base||{}),this.log=new nt(this.logConfig,n),this.options.autoPV&&this.sendImmediately("pv",{entrance_url:location.href},"pv"),this.base=n}return t.prototype.track=function(t,e){this.collect(t,e)},t.prototype.plug=function(t,e){return"function"!=typeof t.attach&&console.error("web log插件必须提供attach方法"),this.plugins.push(t),t.attach(this,e),this},t.prototype.unplug=function(t){if("function"!=typeof t.detach)return console.error("web log插件必须提供detach方法"),!1;if(this.plugins.length>0){var e=this.plugins.indexOf(t);if(~e){this.plugins.splice(e,1);try{t.detach(this)}catch(t){console.warn(t)}return!0}return!1}return!1},t.prototype.unplugAll=function(){for(var t,e=!0;this.plugins.length&&e;)t=this.plugins[0],e=e&&this.unplug(t);return e},t.prototype.collect=function(t,e,n){void 0===n&&(n="CLICK_EVENT");var r=C(t,e,n);this.log.send(r)},t.prototype.sendImmediately=function(t,e,n,r){void 0===n&&(n="CLICK_EVENT"),void 0===r&&(r=!0);var o=C(t,e,n);this.log.sendData({data:[o],async:r})},t.prototype.flush=function(t){void 0===t&&(t=!0),this.log.logQueue.length&&this.log.sendData({data:null,async:t})},t.prototype.destroy=function(){this.unplugAll(),this.log.removeUnload()},t}();!function(t){t[t.fresh=0]="fresh",t[t.reload=1]="reload",t[t.inner=2]="inner",t[t.outer=3]="outer"}(it||(it={}));var ft,lt={Refer:it,fromOuter:S},dt={},pt="onpagehide"in window?"pagehide":"beforeunload",ht={widgetSelector:"[data-impr-config]",widgetDataAttr:"data-impr-config",widgetItemSelector:"figure",reqIdKey:"cur_req_id",groupIdKey:"cur_group_id"},mt=function(){function t(t){if(void 0===t&&(t={}),this.options=tt({},ht),Object.assign(this.options,t),lt.fromOuter()){var e=d()+j();a(this.reqIdKey,e,{raw:!0}),a(this.groupIdKey,e+"_0",{raw:!0})}this.curReqId=i(this.reqIdKey),this.curGroupId=i(this.groupIdKey),this.bind()}return Object.defineProperty(t.prototype,"reqIdKey",{get:function(){return this.options.reqIdKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"groupIdKey",{get:function(){return this.options.groupIdKey},enumerable:!0,configurable:!0}),t.prototype.bind=function(){this.onClickHandler=this.onClick.bind(this),y(document.body,"click",this.onClickHandler,!1),y(window,pt,T)},t.prototype.onClick=function(t){for(var e,n,r=document.body,o=t.target?t.target:t.srcElement,i=null,a=!1,s=-1,u=[];o&&o!==r;){if(u.push(o),"A"===o.tagName&&(a=!0),o.matches?o.matches(this.options.widgetSelector):o._matches(this.options.widgetSelector)){i=o,void 0===(e=this.resolveWidgetConfig(i)).pullid&&(e.pullid=d(),i.setAttribute(this.options.widgetDataAttr,JSON.stringify(e))),n=e.selector||this.options.widgetItemSelector;for(var c=u.length,f=0;f<c;++f)if(u[f].matches?u[f].matches(n):u[f]._matches(n)){for(var l=i.querySelectorAll(n),p=l.length,h=0;h<p;++h)if(l[h]===u[f]){s=h+1;break}break}if(a&&s>0)if(e.id){var m=e.reqid?e.reqid:e.pullid+"_"+dt.page_id+"_"+e.id;this.beforeLinkJumpOut(m,s)}else console.error("widget没有id"),t.preventDefault();break}o=o.parentElement}},t.prototype.resolveWidgetConfig=function(t){var e=t.getAttribute(this.options.widgetDataAttr);try{return JSON.parse(e)}catch(t){console.error(t)}},t.prototype.beforeLinkJumpOut=function(t,e){var n="number"==typeof e?t+"_"+e:e;a(this.reqIdKey,t,{raw:!0}),a(this.groupIdKey,n,{raw:!0})},t.prototype.generateReqID=function(t){if(t||console.error("生成req_id需要提供widget_id"),"string"==typeof t)return d()+"_"+dt.page_id+"_"+t;if(l(t)){var e=this.resolveWidgetConfig(t);e.id||console.error("生成req_id需要提供widget_id"),e.pullid=d();var n=e.pullid+"_"+dt.page_id+"_"+e.id;return e.reqid=n,t.setAttribute(this.options.widgetDataAttr,JSON.stringify(e)),n}},t.prototype.getCurrentReqID=function(){return this.curReqId||i(this.reqIdKey,{raw:!0})},t.prototype.getCurrentGroupID=function(){return this.curGroupId||i(this.groupIdKey,{raw:!0})},t.prototype.destroy=function(){w(window,pt,T),w(document.body,"click",this.onClickHandler,!1),this.onClickHandler=null},t}(),gt={attach:function(t,e){dt=t.base,t.impr=new mt(e)},detach:function(t){t.impr.destroy(),delete t.impr,dt={}}},vt=null,yt=!1,wt=!1,bt="onpagehide"in window?"pagehide":"beforeunload",_t={attach:function(t,e){void 0===e&&(e={}),t.video={queue:[],lastTS:0,lastParams:null,onUnload:function(){if(t.video.queue.length)(e=t.video.queue.pop()).play_duration=(new Date).getTime()-t.video.lastTS,t.sendImmediately("VIDEO_OVER",e,"CLICK_EVENT",!1);else if(yt&&wt){var e=t.video.lastParams;e.play_duration=0,t.sendImmediately("VIDEO_OVER",e,"CLICK_EVENT",!1)}}},y(window,bt,t.video.onUnload),vt=t.sendImmediately,t.sendImmediately=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e[0].toUpperCase(),o=e[1];return t.video&&r&&(/VIDEO_PLAY|VIDEO_RESUME|VIDEO_BUFFER_OVER/.test(r)?(yt=!0,wt=!1,t.video.queue.push(o),t.video.lastTS=(new Date).getTime()):/VIDEO_PAUSE|VIDEO_OVER|VIDEO_BUFFER_BEGIN|VIDEO_UNUSUAL_OVER/.test(r)&&(wt=/VIDEO_PAUSE/.test(r),t.video.queue=[],t.video.lastTS=0,t.video.lastParams=o)),vt.apply(t,e)}},detach:function(t){w(window,bt,t.video.onUnload),delete t.video,t.sendImmediately=vt,vt=null,wt=!1,yt=!1}},It="object"==typeof Reflect?Reflect:null,Ot=It&&"function"==typeof It.apply?It.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};ft=It&&"function"==typeof It.ownKeys?It.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var Et=Number.isNaN||function(t){return t!==t},Ct=M;M.EventEmitter=M,M.prototype._events=void 0,M.prototype._eventsCount=0,M.prototype._maxListeners=void 0;var Lt=10;Object.defineProperty(M,"defaultMaxListeners",{enumerable:!0,get:function(){return Lt},set:function(t){if("number"!=typeof t||t<0||Et(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");Lt=t}}),M.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},M.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||Et(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},M.prototype.getMaxListeners=function(){return k(this)},M.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var r="error"===t,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var i;if(e.length>0&&(i=e[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var s=o[t];if(void 0===s)return!1;if("function"==typeof s)Ot(s,this,e);else for(var u=s.length,c=P(s,u),n=0;n<u;++n)Ot(c[n],this,e);return!0},M.prototype.addListener=function(t,e){return D(this,t,e,!1)},M.prototype.on=M.prototype.addListener,M.prototype.prependListener=function(t,e){return D(this,t,e,!0)},M.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);return this.on(t,N(this,t,e)),this},M.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);return this.prependListener(t,N(this,t,e)),this},M.prototype.removeListener=function(t,e){var n,r,o,i,a;if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e);if(void 0===(r=this._events))return this;if(void 0===(n=r[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===e||n[i].listener===e){a=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():q(n,o),1===n.length&&(r[t]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",t,a||e)}return this},M.prototype.off=M.prototype.removeListener,M.prototype.removeAllListeners=function(t){var e,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var o,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(r=e.length-1;r>=0;r--)this.removeListener(t,e[r]);return this},M.prototype.listeners=function(t){return R(this,t,!0)},M.prototype.rawListeners=function(t){return R(this,t,!1)},M.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):F.call(t,e)},M.prototype.listenerCount=F,M.prototype.eventNames=function(){return this._eventsCount>0?ft(this._events):[]};var St,Tt,jt={updateInterval:2e4,crashThreshold:1e4},At=function(t){function e(e){void 0===e&&(e={});var n=t.call(this)||this;n.options=tt({},jt),n.monitorId="@ks.monitor.crash",n.historyMoniorInfo=null;try{var r=localStorage.getItem(n.monitorId);n.historyMoniorInfo=JSON.parse(r)||{}}catch(t){}return Object.assign(n.options,e),window.addEventListener("beforeunload",function(){n.stop()}),n}return I(e,t),e.prototype.checkHistoryCrash=function(){var t=Date.now();this.historyMoniorInfo&&t-this.historyMoniorInfo.time>this.options.crashThreshold&&this.emit("crash",this.historyMoniorInfo)},e.prototype.start=function(){var t=this;this.checkHistoryCrash(),this.updateIntervalId=window.setInterval(function(){t.update()},this.options.updateInterval),this.update()},e.prototype.update=function(){var t={time:Date.now(),memory:{limit:0,total:0,used:0}};performance&&performance.memory&&(t.memory={limit:performance.memory.jsHeapSizeLimit/1024,total:performance.memory.totalJSHeapSize/1024,used:performance.memory.usedJSHeapSize/1024});try{localStorage.setItem(this.monitorId,JSON.stringify(t))}catch(t){}},e.prototype.stop=function(){clearInterval(this.updateIntervalId);try{localStorage.removeItem(this.monitorId)}catch(t){}},e}(Ct),Mt={attach:function(t,e){var n=new At(e);n.on("crash",function(e){t.sendImmediately("crash",e,"task")}),n.start(),t.crashMonitor=n},detach:function(t){t.crashMonitor.stop(),t.crashMonitor.off("crash"),delete t.crashMonitor}},kt={interval:5e3,decimals:2},Dt=function(t){function e(e){void 0===e&&(e={});var n=t.call(this)||this;return n.options=tt({},kt),n.count=0,Object.assign(n.options,e),n}return I(e,t),e.prototype.start=function(){this.loop(),this.fpsTick()},e.prototype.fpsTick=function(){var t=this;this.fpsTickId=J(function(){t.count++,t.fpsTick()})},e.prototype.loop=function(){var t=this;this.loopBeginTime=performance.now(),this.loopId=window.setTimeout(function(){t.loopEndTime=performance.now();var e=t.calculate();t.emit("performance",e),t.count=0,t.loop()},this.options.interval)},e.prototype.stop=function(){Q(this.fpsTickId),window.clearTimeout(this.loopId)},e.prototype.calculate=function(){return+(1e3/((this.loopEndTime-this.loopBeginTime)/this.count)).toFixed(this.options.decimals)},e}(Ct),xt={attach:function(t,e){var n=new Dt(e);n.on("performance",function(e){t.sendImmediately("fps",{fps:e},"task")}),n.start(),t.fpsMonitor=n},detach:function(t){t.fpsMonitor.off("performance"),t.fpsMonitor.stop(),delete t.fpsMonitor}},Nt={dnsLookup:{end:"domainLookupEnd",start:"domainLookupStart"},tcpConnection:{end:"connectEnd",start:"connectStart"},resourceLoad:{end:"responseEnd",start:"requestStart"},jsCost:{custom:function(){if("function"!=typeof performance.getEntries)return 0;var t=performance.getEntries(),e=t[0],n=t.filter(function(t){return"script"===t.initiatorType})[0];return n?e.domComplete-n.fetchStart:0}},documentContentLoaded:{end:"domComplete",start:"fetchStart"},load:{end:"loadEventEnd",start:"fetchStart"},pageDuring:{custom:function(){return Date.now()-performance.timing.fetchStart}},firstScreen:{custom:function(){return Date.now()-performance.timing.fetchStart}},whiteScreen:{custom:function(){return Date.now()-performance.timing.fetchStart}}},Rt=function(t){function e(){var e=t.call(this)||this;if(e.inited=!1,!performance||!performance.timing)throw new Error("The Timing Monitor need performance APIs to Support!");return e.inited=!0,e}return I(e,t),e.prototype.calculate=function(t){var e=Nt[t];if(!e)throw new Error("The perf key is not correct!");return"function"==typeof e.custom?e.custom(t):performance.timing[Nt[t].end]-performance.timing[Nt[t].start]},e.prototype.mark=function(t){var e=this.collect(t);this.emit("perf",{key:t,data:e})},e.prototype.collect=function(t){var e,n=this;if(t)return e={},e[t]=this.calculate(t),e;var r={};return Object.keys(Nt).reduce(function(t,e){return t[e]=n.calculate(e),t},r)},e}(Ct),Ft="onpagehide"in window?"pagehide":"beforeunload",Pt={load:"total_download_cost",documentContentLoaded:"operational_cost",dnsLookup:"dns_query_cost",tcpConnection:"tcp_cost",jsCost:"js_cost",whiteScreen:"white_screen_cost",firstScreen:"first_screen_cost"},qt={attach:function(t){var e=new Rt;St=function(){var n=e.collect("pageDuring").pageDuring;t.sendImmediately("page_during",{page_during:n},"perf")},Tt=function(){setTimeout(function(){var n=e.collect();["load","documentContentLoaded","dnsLookup","tcpConnection","jsCost"].forEach(function(e){var r;"jsCost"===e&&0===n[e]||t.collect(Pt[e],(r={},r[Pt[e]]=n[e],r),"perf")})})},y(window,Ft,St),y(window,"load",Tt),e.on("perf",function(e){var n,r=e.key,o=e.data;t.collect(Pt[r],(n={},n[Pt[r]]=o[r],n),"perf")}),t.timingMonitor=e},detach:function(t){w(window,Ft,St),w(window,"load",Tt),t.timingMonitor.off("perf"),delete t.timingMonitor}},Ut=Object.freeze({inViewport:H,contains:z});return Object.defineProperty(ct,"util",{enumerable:!0,writable:!1,configurable:!1,value:X}),Object.defineProperty(ct,"dom",{enumerable:!0,writable:!1,configurable:!1,value:Ut}),Object.defineProperty(ct,"builtIns",{enumerable:!0,writable:!0,value:{video:_t,impr:gt,crashMonitor:Mt,fpsMonitor:xt,timingMonitor:qt}}),ct});
