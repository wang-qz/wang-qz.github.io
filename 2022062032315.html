<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="RocketMQ"><meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="baidu-site-verification" content="code-Fqqme2bKQz"><title>RocketMQ专题01 | Crysw&#39;s Blog</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="/libs/artitalk/artitalk.min.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="Crysw's Blog" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><style>body{background-image:url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);background-repeat:no-repeat;background-size:cover;background-attachment:fixed}</style><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo" style="margin-left:-50px"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">Crysw&#39;s Blog</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu" style="margin-left:100px"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-list" style="zoom:.6"></i> <span>清单</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/musics"><i class="fas fa-music" style="margin-top:-20px;zoom:.6"></i> <span>音乐</span></a></li><li><a href="/movies"><i class="fas fa-film" style="margin-top:-20px;zoom:.6"></i> <span>影集</span></a></li><li><a href="/wallpaper"><i class="fas fa-image" style="margin-top:-20px;zoom:.6"></i> <span>壁纸</span></a></li><li><a href="/galleries"><i class="fas fa-camera" style="margin-top:-20px;zoom:.6"></i> <span>相册</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-rocket" style="zoom:.6"></i> <span>关于</span> <i class="fas fa-chevron-down" aria-hidden="true" style="zoom:.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/about"><i class="fas fa-user-circle" style="margin-top:-20px;zoom:.6"></i> <span>关于我</span></a></li><li><a target="_blank" rel="noopener" href="http://www.itsoku.com/"><i class="fab fa-github-alt" style="margin-top:-20px;zoom:.6"></i> <span>充电社</span></a></li><li><a href="/artitalk"><i class="fas fa-pen-alt" style="margin-top:-20px;zoom:.6"></i> <span>artitalk</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/navigate" class="waves-effect waves-light"><i class="fas fa-location-arrow" style="zoom:.6"></i> <span>快捷导航</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/atom.xml" class="waves-effect waves-light"><i class="fas fa-rss" style="zoom:.6"></i> <span>RSS</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">Crysw&#39;s Blog</div><div class="logo-desc">本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-list"></i> 清单 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/musics" style="margin-left:50px"><i class="fa fas fa-music" style="position:absolute;left:28px"></i> <span>音乐</span></a></li><li><a href="/movies" style="margin-left:50px"><i class="fa fas fa-film" style="position:absolute;left:28px"></i> <span>影集</span></a></li><li><a href="/wallpaper" style="margin-left:50px"><i class="fa fas fa-image" style="position:absolute;left:28px"></i> <span>壁纸</span></a></li><li><a href="/galleries" style="margin-left:50px"><i class="fa fas fa-camera" style="position:absolute;left:28px"></i> <span>相册</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fas fa-rocket"></i> 关于 <span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/about" style="margin-left:50px"><i class="fa fas fa-user-circle" style="position:absolute;left:28px"></i> <span>关于我</span></a></li><li><a target="_blank" rel="noopener" href="http://www.itsoku.com/" style="margin-left:50px"><i class="fa fab fa-github-alt" style="position:absolute;left:28px"></i> <span>充电社</span></a></li><li><a href="/artitalk" style="margin-left:50px"><i class="fa fas fa-pen-alt" style="position:absolute;left:28px"></i> <span>artitalk</span></a></li></ul></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li class="m-nav-item"><a href="/navigate" class="waves-effect waves-light"><i class="fa-fw fas fa-location-arrow"></i> 快捷导航</a></li><li class="m-nav-item"><a href="/atom.xml" class="waves-effect waves-light"><i class="fa-fw fas fa-rss"></i> RSS</a></li><li><div class="divider"></div></li><li><a href="https://gitee.com/wang-qz/hexo-blog-crystal" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://gitee.com/wang-qz/hexo-blog-crystal" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="/libs/cryptojs/crypto-js.min.js"></script><script></script><div class="bg-cover pd-header post-cover" style="background-image:url(https://s.cn.bing.net/th?id=OHR.SwallowtailFlower_ZH-CN5950463168_1920x1080.jpg&rf=LaDigue_1920x1080.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">RocketMQ专题01</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">消息中间件</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2022-06-20</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2022-06-20</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 18k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 81 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="1-MQ介绍"><a href="#1-MQ介绍" class="headerlink" title="1. MQ介绍"></a>1. MQ介绍</h2><p>B站视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1L4411y7mn?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click"><strong>黑马程序员RocketMQ系统精讲 P1 - P34</strong></a></p><h3 id="1-1-为什么要用MQ"><a href="#1-1-为什么要用MQ" class="headerlink" title="1.1 为什么要用MQ"></a>1.1 为什么要用MQ</h3><p>消息队列是一种”先进先出”的数据结构. Message Queue<br><img src="https://img-blog.csdnimg.cn/1ce9be24ea4e42a9a832f24c2c01dd9a.png#pic_center" alt="在这里插入图片描述"><br>其应用场景主要包含以下3个方面</p><ul><li><p><strong>应用解耦</strong></p><p>系统的耦合性越高， 容错性就越低。 以电商应用为例,，用户创建订单后，如果耦合调用库存系统,、物流系统,、支付系统， 任何一个子系统出现了故障或者因为升级等原因暂时不可用， 都会造成下单操作异常， 影响用户使用体验。<br><img src="https://img-blog.csdnimg.cn/16893099f05b4befafe81e5fc8dda080.png#pic_center" alt="在这里插入图片描述"><br>使用消息队列解耦， 系统的耦合性就降低了。比如物流系统发生故障， 需要几分钟才能修复， 在这段时间内， 物流系统要处理的数据被缓存到消息队列中， 用户下单操作正常完成。 当物流系统恢复后， 补充处理存储在消息队列中的订单消息即可， 终端系统感知不到物流系统发生过几分钟的故障。<br><img src="https://img-blog.csdnimg.cn/2be7517bc66245e09ee24d9acae69231.png#pic_center" alt="在这里插入图片描述"></p></li><li><p><strong>流量削峰</strong><br><img src="https://img-blog.csdnimg.cn/b12bc089b7494179b402ea7bc507e302.png#pic_center" alt="在这里插入图片描述"><br>应用系统如果遇到系统请求流量的瞬间猛增， 有可能将系统压垮。 有了消息队列可以将大量请求缓存起来， 分散到很长时间处理， 这样可以大大提高系统的稳定性和用户体验。<br><img src="https://img-blog.csdnimg.cn/503b1a56893b44ec9b9cabbde5b83793.png#pic_center" alt="在这里插入图片描述"></p></li></ul><p>一般情况， 为了保证系统的稳定性， 如果系统负载超过阈值， 就会阻止用户请求， 这会影响用户体验， 而如果使用消息队列将请求缓存起来， 等待系统处理完毕后通知用户下单完毕， 用户下单体验要好。</p><p>处于经济考虑的目的：</p><p>业务系统正常时间段的QPS如果是1000， 流量最高峰是10000， 为了应对流程高峰配置高性能的服务器不划算， 可以使用消息队列对峰值流量削峰。</p><ul><li><p><strong>数据分发</strong><br><img src="https://img-blog.csdnimg.cn/3d25362961f448b4a89f2e46b8fea833.png#pic_center" alt="在这里插入图片描述"></p><p>通过消息队列可以让数据在多个系统之间进行流通， 数据的产生方不需要关心谁来使用这个数据， 只需要将数据发送到消息队列， 数据使用方直接在消息队列中直接获取数据即可。（发布，订阅）<br><img src="https://img-blog.csdnimg.cn/02e011133afb42c59ece9070cf76a1e4.png#pic_center" alt="在这里插入图片描述"></p></li></ul><h3 id="1-2-MQ的优点和缺点"><a href="#1-2-MQ的优点和缺点" class="headerlink" title="1.2 MQ的优点和缺点"></a>1.2 MQ的优点和缺点</h3><p>优点： 解耦， 削峰， 数据分发</p><p>缺点包含以下几点：</p><ul><li><p>系统可用性降低</p><p>系统引入的外部依赖越多， 系统稳定性越差。 一旦MQ宕机， 就会对业务造成影响。如何保证MQ高可用呢？</p></li><li><p>系统复杂度提高</p><p>MQ的加入大大增加了系统的复杂度， 以前系统之间是同步的远程调用（RPC调用）， 现在是通过MQ进行异步调用。</p><p>如何保证消息没有被重复消费？怎么处理消息丢失情况？ 怎么保证消息传递的顺序性？</p></li><li><p>一致性问题</p><p>A系统处理完业务， 通过MQ给B，C，D三个系统发消息数据，如果B系统，C系统处理成功，D系统处理失败。 如果保证消息数据处理的一致性？</p></li></ul><h3 id="1-3-各种MQ产品的比较"><a href="#1-3-各种MQ产品的比较" class="headerlink" title="1.3 各种MQ产品的比较"></a>1.3 各种MQ产品的比较</h3><p>常见的MQ产品包括Kafka，ActiveMQ，RabbitMQ，RocketMQ。</p><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>单机吞吐量</td><td><strong>万级</strong>，吞吐量比RocketMQ和Kafka要低了一个数量级</td><td><strong>万级</strong>，吞吐量比RocketMQ和Kafka要低了一个数量级</td><td><strong>10万级</strong>，RocketMQ也是可以支撑高吞吐的一种MQ</td><td><strong>10万级别</strong>，这是kafka最大的优点，就是吞吐量高。 一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td></tr><tr><td>topic数量对吞吐量的影响</td><td></td><td></td><td>topic可以达到几百，几千个的级别，吞吐量会有较小幅度的下降 这是RocketMQ的一大优势，在同等机器下，可以支撑大量的topic</td><td>topic从几十个到几百个的时候，吞吐量会大幅度下降 所以在同等机器下，kafka尽量保证topic数量不要过多。如果要支撑大规模topic，需要增加更多的机器资源</td></tr><tr><td>时效性</td><td>ms级</td><td>微秒级，这是rabbitmq的一大特点，延迟是最低的</td><td>ms级</td><td>延迟在ms级以内</td></tr><tr><td>可用性</td><td>高，基于主从架构实现高可用性</td><td>高，基于主从架构实现高可用性</td><td>非常高，分布式架构</td><td>非常高，kafka是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td></tr><tr><td>消息可靠性</td><td>有较低的概率丢失数据</td><td></td><td>经过参数优化配置，可以做到0丢失</td><td>经过参数优化配置，消息可以做到0丢失</td></tr><tr><td>功能支持</td><td>MQ领域的功能极其完备</td><td>基于erlang开发，所以并发能力很强，性能极其好，延时很低</td><td>MQ功能较为完善，还是分布式的，扩展性好</td><td>功能较为简单，主要支持简单的MQ功能，在大数据领域的实时计算以及日志采集被大规模使用，是事实上的标准</td></tr><tr><td>优劣势总结</td><td>非常成熟，功能强大，在业内大量的公司以及项目中都有应用 偶尔会有较低概率丢失消息 而且现在社区以及国内应用都越来越少，官方社区现在对ActiveMQ 5.x维护越来越少，几个月才发布一个版本 而且确实主要是基于解耦和异步来用的，较少在大规模吞吐的场景中使用</td><td><strong>erlang语言</strong>开发，性能极其好，延时很低； 吞吐量到万级，MQ功能比较完备 而且开源提供的管理界面非常棒，用起来很好用 社区相对比较活跃，几乎每个月都发布几个版本分 在国内一些互联网公司近几年用rabbitmq也比较多一些 但是问题也是显而易见的，RabbitMQ确实吞吐量会低一些，这是因为他做的实现机制比较重。 而且erlang开发，国内有几个公司有实力做erlang源码级别的研究和定制？如果说你没这个实力的话，确实偶尔会有一些问题，你很难去看懂源码，你公司对这个东西的掌控很弱，基本职能依赖于开源社区的快速维护和修复bug。 而且rabbitmq集群动态扩展会很麻烦，不过这个我觉得还好。其实主要是erlang语言本身带来的问题。很难读源码，很难定制和掌控。</td><td>接口简单易用，而且毕竟在阿里大规模应用过，有阿里品牌保障 日处理消息上百亿之多，可以做到大规模吞吐，性能也非常好，分布式扩展也很方便，社区维护还可以，可靠性和可用性都是ok的，还可以支撑大规模的topic数量，支持复杂MQ业务场景 而且一个很大的优势在于，阿里出品都是<strong>java</strong>系的，我们可以自己阅读源码，定制自己公司的MQ，可以掌控 社区活跃度相对较为一般，不过也还可以，文档相对来说简单一些，然后接口这块不是按照标准JMS规范走的有些系统要迁移需要修改大量代码 还有就是阿里出台的技术，你得做好这个技术万一被抛弃，社区黄掉的风险，那如果你们公司有技术实力我觉得用RocketMQ挺好的</td><td>kafka的特点其实很明显，就是仅仅提供较少的核心功能，但是提供超高的吞吐量，ms级的延迟，极高的可用性以及可靠性，而且分布式可以任意扩展 同时kafka最好是支撑较少的topic数量即可，保证其超高吞吐量 而且kafka唯一的一点劣势是有可能消息重复消费，那么对数据准确性会造成极其轻微的影响，在大数据领域中以及日志采集中，这点轻微影响可以忽略 这个特性天然适合大数据实时计算以及日志收集</td></tr></tbody></table><h2 id="2-RocketMQ快速入门"><a href="#2-RocketMQ快速入门" class="headerlink" title="2. RocketMQ快速入门"></a>2. RocketMQ快速入门</h2><p>RocketMQ是阿里巴巴2016年开源的MQ中间件， 使用JAVA语言开发， 在阿里内部RocketMQ承受了例如“双11”等高并发场景的消息流转， 能够处理万亿级别的消息。</p><h3 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h3><h4 id="2-1-1-下载RocketMQ"><a href="#2-1-1-下载RocketMQ" class="headerlink" title="2.1.1 下载RocketMQ"></a>2.1.1 下载RocketMQ</h4><p>RocketMQ最新版本： <a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.9.3/rocketmq-all-4.9.3-source-release.zip">rocketmq-all-4.9.3-source-release.zip</a></p><h4 id="2-1-2-环境要求"><a href="#2-1-2-环境要求" class="headerlink" title="2.1.2 环境要求"></a>2.1.2 环境要求</h4><p>LInux64位系统</p><p>JDK8 （64位）</p><p>源码安装需要安装Maven 3.2.x, 下面是编译源码步骤:</p><pre class="language-java"><code class="language-java"><span class="token operator">></span> unzip rocketmq<span class="token operator">-</span>all<span class="token operator">-</span><span class="token number">4.9</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token operator">-</span>source<span class="token operator">-</span>release<span class="token punctuation">.</span>zip
<span class="token operator">></span> cd rocketmq<span class="token operator">-</span>all<span class="token operator">-</span><span class="token number">4.9</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token operator">/</span>
<span class="token operator">></span> mvn <span class="token operator">-</span>Prelease<span class="token operator">-</span>all <span class="token operator">-</span>DskipTests clean install <span class="token operator">-</span>U
<span class="token operator">></span> cd distribution<span class="token operator">/</span>target<span class="token operator">/</span>rocketmq<span class="token operator">-</span><span class="token number">4.9</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token operator">/</span>rocketmq<span class="token operator">-</span><span class="token number">4.9</span><span class="token punctuation">.</span><span class="token number">3</span>
</code></pre><p>推荐直接下载编译后的bin包<a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.9.3/rocketmq-all-4.9.3-bin-release.zip">rocketmq-all-4.9.3-bin-release.zip</a></p><h3 id="2-2-安装RocketMQ"><a href="#2-2-安装RocketMQ" class="headerlink" title="2.2 安装RocketMQ"></a>2.2 安装RocketMQ</h3><h4 id="2-2-1-安装目录"><a href="#2-2-1-安装目录" class="headerlink" title="2.2.1 安装目录"></a>2.2.1 安装目录</h4><p>推荐使用二进制包进行安装。</p><p>1） 解压安装包</p><pre class="language-bash"><code class="language-bash">unzip rocketmq-all-4.9.3-bin-release.zip /usr/local/
</code></pre><p>2）进入安装目录即可。</p><h4 id="2-2-2-目录介绍"><a href="#2-2-2-目录介绍" class="headerlink" title="2.2.2 目录介绍"></a>2.2.2 目录介绍</h4><ul><li>bin：启动脚本， 包括shell脚本和cmd脚本</li><li>conf：实例配置文件，包括broker配置文件，logback配置文件等。</li><li>lib：依赖jar包，包括Netty，commons-lang，fastJson等。</li></ul><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 rocketmq-4.9.3<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>
total 48
drwxr-xr-x. 3 root root    21 May  1 21:39 ~
drwxr-xr-x. 2 root root   126 Feb 22 01:25 benchmark
drwxr-xr-x. 3 root root  4096 May  1 20:26 bin
drwxr-xr-x. 7 root root   201 May 19 22:59 conf
drwxr-xr-x. 2 root root  4096 Feb 22 01:25 lib
-rw-r--r--. 1 root root 17327 Feb 22 00:25 LICENSE
-rw-------. 1 root root  5735 May 19 23:04 nohup.out
-rw-r--r--. 1 root root  1338 Feb 22 00:25 NOTICE
-rw-r--r--. 1 root root  6069 Feb 22 00:25 README.md
</code></pre><h3 id="2-3-启动RocketMQ"><a href="#2-3-启动RocketMQ" class="headerlink" title="2.3 启动RocketMQ"></a>2.3 启动RocketMQ</h3><ol><li>启动NameServer</li></ol><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 启动NameServer</span>
<span class="token function">nohup</span> sh bin/mqnamesrv <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># 查看启动日志</span>
<span class="token function">tail</span> -f ~/logs/rocketmqlogs/namesrv.log
</code></pre><p>2）启动broker</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 启动broker</span>
<span class="token function">nohup</span> sh bin/mqbroker -n localhost:9876 <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># 查看启动日志</span>
<span class="token function">tail</span> -f ~/logs/rocketmqlogs/broker.log
</code></pre><p>问题描述：</p><p>RocketMQ默认的虚拟机内存较大， 启动Broker如果因为内存不足失败， 需要编辑如下两个配置文件， 修改JVM初始化内存大小。</p><pre class="language-bash"><code class="language-bash">JAVA_OPT<span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms256m -Xmx256m -Xmn128m"</span>
</code></pre><p>修改 runserver.sh</p><img src="https://img-blog.csdnimg.cn/1aec906431c544a793665aedce56648c.png#pic_center" style="zoom:150%"><p>修改 runbroker.sh<br><img src="https://img-blog.csdnimg.cn/f701d12710314c5486abbc9a3ffcca07.png#pic_center" alt="在这里插入图片描述"></p><p>修改完初始化内存大小后，重启namesrv，broker。使用 jps 查看。</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 bin<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># jps</span>
2498 BrokerStartup
9923 Jps
2410 NamesrvStartup
</code></pre><h3 id="2-4-测试RocketMQ"><a href="#2-4-测试RocketMQ" class="headerlink" title="2.4 测试RocketMQ"></a>2.4 测试RocketMQ</h3><p>发送消息</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 设置环境变量</span>
<span class="token function">export</span> NAMESRV_ADDR<span class="token operator">=</span>localhost:9876
<span class="token comment" spellcheck="true"># 使用安装包的demo发送消息</span>
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre><p>接收消息</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 设置环境变量</span>
<span class="token function">export</span> NAMESRV_ADDR<span class="token operator">=</span>localhost:9876
<span class="token comment" spellcheck="true"># 使用安装包的demo进行消费</span>
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer
</code></pre><h3 id="2-5-关闭RocketMQ"><a href="#2-5-关闭RocketMQ" class="headerlink" title="2.5 关闭RocketMQ"></a>2.5 关闭RocketMQ</h3><p>关闭RocketMQ , 先停止broker,再停止namesrv</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 关闭broker</span>
sh bin/mqshutdown broker
<span class="token comment" spellcheck="true"># 关闭namesrv</span>
sh bin/mqshutdown namesrv
</code></pre><h2 id="3-RocketMQ集群搭建"><a href="#3-RocketMQ集群搭建" class="headerlink" title="3. RocketMQ集群搭建"></a>3. RocketMQ集群搭建</h2><h3 id="3-1-各角色介绍"><a href="#3-1-各角色介绍" class="headerlink" title="3.1 各角色介绍"></a>3.1 各角色介绍</h3><ul><li>producer：消息的发送者；比如：发信者</li><li>consumer：消息接收者；比如：收信者</li><li>broker：暂存和传输消息；比如：邮局</li><li>NameServer：管理broker；比如：各个邮局的管理机构</li><li>topic：区分消息的种类；一个发送者发送消息给一个或多个topic；一个消息的接收者可以订阅一个或多个topic消息。</li><li>Message Queue：相当于topic的分区， 用于并行发送和接收消息。</li></ul><p><img src="https://img-blog.csdnimg.cn/0bcc1d891a8f4ecd9d2ff809290a93f2.png#pic_center" alt="在这里插入图片描述"></p><h3 id="3-2-集群搭建方式"><a href="#3-2-集群搭建方式" class="headerlink" title="3.2 集群搭建方式"></a>3.2 集群搭建方式</h3><h4 id="3-2-1-集群特点"><a href="#3-2-1-集群特点" class="headerlink" title="3.2.1 集群特点"></a>3.2.1 集群特点</h4><ul><li>NameServer是一个几乎无状态节点, 可集群部署, 节点之间无任何信息同步.</li><li>Broker部署相对复杂, Broker分为Master与Slave, 一个Master可以对应多个Slave, 但是一个Slave只能应对一个Master, Master与Slave的对应关系通过指定相同的BrokerName, 不同的brokerId来定义, BrokerId为0表示Master, 非0表示Slave。Master也可以部署多个， <strong>每个Broker与NameServer集群中的所有节点建立长连接</strong>， 定时注册Topic信息到所有NameServer。</li><li>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息， 并向提供Topic服务的Master建立长连接， 且定时向Master发送心跳。Producer完全无状态，可集群部署。</li><li>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接， 定期从NameServer取Topic路由信息， 并向提供Topic服务的Master，Slave建立长连接， 且定时向Master，Slave发送心跳。 Consumer既可以从Master订阅消息， 也可以从Slave订阅消息， 订阅规则由Broker配置决定。</li></ul><h4 id="3-2-2-集群模式"><a href="#3-2-2-集群模式" class="headerlink" title="3.2.2 集群模式"></a>3.2.2 集群模式</h4><h5 id="1）单Master模式"><a href="#1）单Master模式" class="headerlink" title="1）单Master模式"></a>1）单Master模式</h5><p>这种方式的风险较大， 一旦Broker重启或者宕机， 会导致整个服务不可用。不建议线上环境使用， 可以用于本地测试。</p><h5 id="2-多Master模式"><a href="#2-多Master模式" class="headerlink" title="2) 多Master模式"></a>2) 多Master模式</h5><p>一个集群无Slave，全是Master，例如2个Master或3个Master，这种模式的优缺点如下：</p><ul><li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢失（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li><li>缺点：单台机器宕机期间， 这台机器上未被消费的消息在机器恢复之前不可订阅， 消息实时性会受到影响。</li></ul><h5 id="3）-多Master多Slave模式（异步）"><a href="#3）-多Master多Slave模式（异步）" class="headerlink" title="3） 多Master多Slave模式（异步）"></a>3） 多Master多Slave模式（异步）</h5><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p><ul><li>优点：即使磁盘损坏，消息丢失的非常少， 且消息实时性不会受到影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样。</li><li>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</li></ul><h5 id="4）多Master多Slave模式（同步）"><a href="#4）多Master多Slave模式（同步）" class="headerlink" title="4）多Master多Slave模式（同步）"></a>4）多Master多Slave模式（同步）</h5><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p><ul><li>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；</li><li>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT（<strong>实时时间</strong>）会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</li></ul><h3 id="3-3-双主双从集群搭建"><a href="#3-3-双主双从集群搭建" class="headerlink" title="3.3 双主双从集群搭建"></a>3.3 双主双从集群搭建</h3><h4 id="3-3-1-总体架构"><a href="#3-3-1-总体架构" class="headerlink" title="3.3.1 总体架构"></a>3.3.1 总体架构</h4><p>消息高可用采用2M-2S（同步双写）方式<br><img src="https://img-blog.csdnimg.cn/33490bed7571436588f3ba7230f5f35e.png#pic_center" alt="在这里插入图片描述"></p><h4 id="3-3-2-集群工作流程"><a href="#3-3-2-集群工作流程" class="headerlink" title="3.3.2 集群工作流程"></a>3.3.2 集群工作流程</h4><p>1）启动NameServer， NameServer启起来后监听端口， 等待Broker，Producer，Consumer连上来，相当于一个路由控制中心。</p><p>2）Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息（IP+端口等）以及存储所有Topic信息。 注册成功后，NameServer集群中就有Topic和Broker的映射关系。</p><p>3）收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</p><p>4）Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存储在哪些Broker上，轮询从队列列表中选择一个队列， 然后与队列所在的Broker建立长连接，从而向Broker发送消息。</p><p>5）Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存储在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</p><h4 id="3-3-3-服务器环境"><a href="#3-3-3-服务器环境" class="headerlink" title="3.3.3 服务器环境"></a>3.3.3 服务器环境</h4><table><thead><tr><th>序号</th><th>IP</th><th>角色</th><th>架构模式</th></tr></thead><tbody><tr><td>1</td><td>192.168.65.129</td><td>NameServer, brokerServer</td><td>Master1, Slave2</td></tr><tr><td>2</td><td>192.168.65.130</td><td>NameServer, brokerServer</td><td>Master2, Slave1</td></tr></tbody></table><h4 id="3-3-4-Host添加信息"><a href="#3-3-4-Host添加信息" class="headerlink" title="3.3.4 Host添加信息"></a>3.3.4 Host添加信息</h4><pre class="language-bash"><code class="language-bash">vim /etc/hosts
</code></pre><p>配置如下：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># nameserver</span>
192.168.65.129 rocketmq-nameserver1
192.168.65.130 rocketmq-nameserver2
<span class="token comment" spellcheck="true"># broker</span>
192.168.65.129 rocketmq-master1
192.168.65.129 rocketmq-slave2
192.168.65.130 rocketmq-master2
192.168.65.130 rocketmq-slave1
</code></pre><p>配置完成后，重启网卡</p><pre class="language-bash"><code class="language-bash">systemctl restart network
</code></pre><h4 id="3-3-5-防火墙配置"><a href="#3-3-5-防火墙配置" class="headerlink" title="3.3.5 防火墙配置"></a>3.3.5 防火墙配置</h4><p>宿主机需要远程访问虚拟机的rocketmq服务和web服务, 需要开放相关的端口号, 简单粗暴的方式是直接关闭防火墙.</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 关闭防火墙</span>
systemctl stop firewalld.service
<span class="token comment" spellcheck="true"># 查看防火墙的状态</span>
firewall-cmd --state
<span class="token comment" spellcheck="true"># 禁止firewall开机启动</span>
systemctl disable firewalld.service
</code></pre><p>或为了安全, 只开放特定的端口号, RocketMQ默认使用的3个端口: <code>9876、10911、11011</code>。如果防火墙没有关闭， 那么防火墙就必须开放这些端口：</p><ul><li>nameserver默认使用9876端口</li><li>master默认使用10911端口</li><li>slave默认使用11011端口</li></ul><p>执行以下命令：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 开放nameserver默认端口</span>
firewall-cmd --permanent --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>9876/tcp
<span class="token comment" spellcheck="true"># 移除端口访问权限</span>
firewall-cmd --permanent --remove-port<span class="token operator">=</span>9876/tcp  
<span class="token comment" spellcheck="true"># 开放master默认端口</span>
firewall-cmd --permanent --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>10911/tcp
<span class="token comment" spellcheck="true"># 开放slave默认端口（当前集群模式下可以不开启）</span>
firewall-cmd --permanent --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>11011/tcp
<span class="token comment" spellcheck="true"># 重启防火墙</span>
firewall-cmd --reload
<span class="token comment" spellcheck="true"># 查看端口开放情况</span>
firewall-cmd --permanent --list-ports
</code></pre><h4 id="3-3-6-环境变量配置"><a href="#3-3-6-环境变量配置" class="headerlink" title="3.3.6 环境变量配置"></a>3.3.6 环境变量配置</h4><pre class="language-bash"><code class="language-bash">vim /etc/profile
</code></pre><p>在profile文件的末尾加入如下命令：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># set rocketmq</span>
ROCKETMQ_HOME<span class="token operator">=</span>/usr/local/rocketmq-4.9.3
PATH<span class="token operator">=</span><span class="token variable">$PATH</span><span class="token keyword">:</span><span class="token variable">$ROCKETMQ_HOME</span>/bin
<span class="token function">export</span> ROCKETMQ_HOME PATH
</code></pre><p>输入:wq!保存退出， 并生效修改的配置：</p><pre class="language-bash"><code class="language-bash"><span class="token function">source</span> /etc/profile
</code></pre><h4 id="3-3-7-创建消息存储路径"><a href="#3-3-7-创建消息存储路径" class="headerlink" title="3.3.7 创建消息存储路径"></a>3.3.7 创建消息存储路径</h4><p>如果没有创建消息的存储路径， 会默认在当前用户的home目录下生成store目录。</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 store<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pwd</span>
/root/store
<span class="token punctuation">[</span>root@centos7-01 store<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>
total 8
-rw-r--r--.  1 root root    0 May 19 23:04 abort
-rw-r--r--.  1 root root 4096 May 29 22:53 checkpoint
drwxr-xr-x.  2 root root   34 May  1 20:36 commitlog
drwxr-xr-x.  2 root root  280 May 29 22:54 config
drwxr-xr-x. 12 root root  210 May 17 21:24 consumequeue
drwxr-xr-x.  2 root root   31 May 19 20:49 index
-rw-r--r--.  1 root root    4 May 19 23:04 lock
</code></pre><p>也可以手动创建消息存储路径，指定到该目录下。</p><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /usr/local/rocketmq-4.9.3/store
<span class="token function">mkdir</span> -p /usr/local/rocketmq-4.9.3/store/commitlog
<span class="token function">mkdir</span> -p /usr/local/rocketmq-4.9.3/store/consumequeue
<span class="token function">mkdir</span> -p /usr/local/rocketmq-4.9.3/store/index
</code></pre><h4 id="3-3-8-broker配置文件"><a href="#3-3-8-broker配置文件" class="headerlink" title="3.3.8 broker配置文件"></a>3.3.8 broker配置文件</h4><h5 id="3-3-8-1-Master1"><a href="#3-3-8-1-Master1" class="headerlink" title="3.3.8.1 Master1"></a>3.3.8.1 Master1</h5><p>服务器： 192.168.65.129</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 2m-2s-sync是同步双写  2m-2s-async是异步复制 2m-noslave 双Master无Slave</span>
<span class="token function">vi</span> /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties
</code></pre><p>broker-a.properties 修改配置如下：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true"># broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-a
<span class="token comment" spellcheck="true"># 0 表示Master，>0表示Slave</span>
brokerId<span class="token operator">=</span>0
<span class="token comment" spellcheck="true"># nameServer地址，分号分隔</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># Broker对外服务的监听端口，即Broker与producer与consumer通信的端口</span>
listenPort<span class="token operator">=</span>10911
<span class="token comment" spellcheck="true"># 删除文件时间点，默认凌晨4点</span>
deleteservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true"># commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true"># ConsumeQueue每个文件默认存30w条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true"># 检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true"># 存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store
<span class="token comment" spellcheck="true"># commitLog存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/commitlog
<span class="token comment" spellcheck="true"># 消息队列存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/consumequeue
<span class="token comment" spellcheck="true"># 消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/index
<span class="token comment" spellcheck="true"># checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/checkpoint
<span class="token comment" spellcheck="true"># abort文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/abort
<span class="token comment" spellcheck="true"># 限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true"># flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true"># flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true"># Broker的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SYNC_MASTER
<span class="token comment" spellcheck="true"># 刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>SYNC_FLUSH
<span class="token comment" spellcheck="true"># checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true"># 发送消息线程池</span>
<span class="token comment" spellcheck="true"># sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true"># 拉消息线程池数量</span>
<span class="token comment" spellcheck="true"># pullMessageThreadPoolNums=128</span>
</code></pre><h5 id="3-3-8-2-Slave2"><a href="#3-3-8-2-Slave2" class="headerlink" title="3.3.8.2 Slave2"></a>3.3.8.2 Slave2</h5><p>服务器： 192.168.65.129</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 2m-2s-sync是同步双写  2m-2s-async是异步复制 2m-noslave 双Master无Slave</span>
<span class="token function">vi</span> /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties
</code></pre><p>broker-b-s.properties 配置文件内容如下：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true"># broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-b
<span class="token comment" spellcheck="true"># 0 表示Master，>0表示Slave</span>
brokerId<span class="token operator">=</span>1
<span class="token comment" spellcheck="true"># nameServer地址，分号分隔</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># Broker对外服务的监听端口，即Broker与producer与consumer通信的端口</span>
listenPort<span class="token operator">=</span>11011
<span class="token comment" spellcheck="true"># 删除文件时间点，默认凌晨4点</span>
deleteservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true"># commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true"># ConsumeQueue每个文件默认存30w条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true"># 检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true"># 存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store
<span class="token comment" spellcheck="true"># commitLog存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/commitlog
<span class="token comment" spellcheck="true"># 消息队列存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/consumequeue
<span class="token comment" spellcheck="true"># 消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/index
<span class="token comment" spellcheck="true"># checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/checkpoint
<span class="token comment" spellcheck="true"># abort文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/abort
<span class="token comment" spellcheck="true"># 限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true"># flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true"># flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true"># Broker的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SLAVE
<span class="token comment" spellcheck="true"># 刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>ASYNC_FLUSH
<span class="token comment" spellcheck="true"># checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true"># 发送消息线程池</span>
<span class="token comment" spellcheck="true"># sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true"># 拉消息线程池数量</span>
<span class="token comment" spellcheck="true"># pullMessageThreadPoolNums=128</span>
</code></pre><h5 id="3-3-8-3-Master2"><a href="#3-3-8-3-Master2" class="headerlink" title="3.3.8.3 Master2"></a>3.3.8.3 Master2</h5><p>服务器: 192.168.65.130</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 2m-2s-sync是同步双写  2m-2s-async是异步复制 2m-noslave 双Master无Slave</span>
<span class="token function">vi</span> /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b.properties
</code></pre><p>broker-b.properties 配置内容如下:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true"># broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-b
<span class="token comment" spellcheck="true"># 0 表示Master，>0表示Slave</span>
brokerId<span class="token operator">=</span>0
<span class="token comment" spellcheck="true"># nameServer地址，分号分隔</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># Broker对外服务的监听端口，即Broker与producer与consumer通信的端口</span>
listenPort<span class="token operator">=</span>10911
<span class="token comment" spellcheck="true"># 删除文件时间点，默认凌晨4点</span>
deleteservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true"># commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true"># ConsumeQueue每个文件默认存30w条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true"># 检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true"># 存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq/store
<span class="token comment" spellcheck="true"># commitLog存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/commitlog
<span class="token comment" spellcheck="true"># 消息队列存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/consumequeue
<span class="token comment" spellcheck="true"># 消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/index
<span class="token comment" spellcheck="true"># checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/checkpoint
<span class="token comment" spellcheck="true"># abort文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/abort
<span class="token comment" spellcheck="true"># 限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true"># flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true"># flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true"># Broker的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SYNC_MASTER
<span class="token comment" spellcheck="true"># 刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>SYNC_FLUSH
<span class="token comment" spellcheck="true"># checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true"># 发送消息线程池</span>
<span class="token comment" spellcheck="true"># sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true"># 拉消息线程池数量</span>
<span class="token comment" spellcheck="true"># pullMessageThreadPoolNums=128</span>
</code></pre><h5 id="3-3-8-4-Slave1"><a href="#3-3-8-4-Slave1" class="headerlink" title="3.3.8.4 Slave1"></a>3.3.8.4 Slave1</h5><p>服务器: 192.168.65.130</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 2m-2s-sync是同步双写  2m-2s-async是异步复制 2m-noslave 双Master无Slave</span>
<span class="token function">vi</span> /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a-s.properties
</code></pre><p>broker-a-s.properties 配置内容如下:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true"># broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-a
<span class="token comment" spellcheck="true"># 0 表示Master，>0表示Slave</span>
brokerId<span class="token operator">=</span>1
<span class="token comment" spellcheck="true"># nameServer地址，分号分隔</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true"># 在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># 是否允许Broker自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true"># Broker对外服务的监听端口，即Broker与producer与consumer通信的端口</span>
listenPort<span class="token operator">=</span>11011
<span class="token comment" spellcheck="true"># 删除文件时间点，默认凌晨4点</span>
deleteservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true"># commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true"># ConsumeQueue每个文件默认存30w条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true"># 检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true"># 存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store
<span class="token comment" spellcheck="true"># commitLog存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/commitlog
<span class="token comment" spellcheck="true"># 消息队列存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/consumequeue
<span class="token comment" spellcheck="true"># 消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/index
<span class="token comment" spellcheck="true"># checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/checkpoint
<span class="token comment" spellcheck="true"># abort文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq-4.9.3/store/abort
<span class="token comment" spellcheck="true"># 限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true"># flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true"># flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true"># flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true"># Broker的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SLAVE
<span class="token comment" spellcheck="true"># 刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>ASYNC_FLUSH
<span class="token comment" spellcheck="true"># checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true"># 发送消息线程池</span>
<span class="token comment" spellcheck="true"># sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true"># 拉消息线程池数量</span>
<span class="token comment" spellcheck="true"># pullMessageThreadPoolNums=128</span>
</code></pre><h4 id="3-3-9-修改启动脚本文件"><a href="#3-3-9-修改启动脚本文件" class="headerlink" title="3.3.9 修改启动脚本文件"></a>3.3.9 修改启动脚本文件</h4><p><strong>runbroker.sh</strong></p><pre class="language-bash"><code class="language-bash"><span class="token function">vi</span> /usr/local/rocketmq-4.9.3/bin/runbroker.sh
</code></pre><p>需要根据内存大小对JVM参数进行进行适当的调整:</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 开发环境配置 JVM Configuration</span>
JAVA_OPT<span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms256m -Xmx256m -Xmn128m"</span>
</code></pre><p><strong>runserver.sh</strong></p><pre class="language-bash"><code class="language-bash"><span class="token function">vi</span> /usr/local/rocketmq-4.9.3/bin/runserver.sh
</code></pre><p>配置内容:</p><pre class="language-bash"><code class="language-bash">JAVA_OPT<span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
</code></pre><h4 id="3-3-10-服务启动"><a href="#3-3-10-服务启动" class="headerlink" title="3.3.10 服务启动"></a>3.3.10 服务启动</h4><h5 id="3-3-10-1-启动NameServer集群"><a href="#3-3-10-1-启动NameServer集群" class="headerlink" title="3.3.10.1 启动NameServer集群"></a>3.3.10.1 启动NameServer集群</h5><p>分别在192.168.65.129和192.168.65.130上启动NameServer</p><pre class="language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq-4.9.3/bin
<span class="token function">nohup</span> sh mqnamesrv <span class="token operator">&amp;</span>
</code></pre><h5 id="3-3-10-2-启动Broker集群"><a href="#3-3-10-2-启动Broker集群" class="headerlink" title="3.3.10.2 启动Broker集群"></a>3.3.10.2 启动Broker集群</h5><ul><li>在192.168.65.129上启动Master1和Slave2.</li></ul><p>Master1:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq-4.9.3/bin
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties <span class="token operator">&amp;</span>
</code></pre><p>Slave2:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq-4.9.3/bin
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties <span class="token operator">&amp;</span>
</code></pre><ul><li>在192.168.65.130上启动Master2和Slave1.</li></ul><p>Master2:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq-4.9.3/bin
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b.properties <span class="token operator">&amp;</span>
</code></pre><p>Slave1:</p><pre class="language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq-4.9.3/bin
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a-s.properties <span class="token operator">&amp;</span>
</code></pre><h4 id="3-3-11-查看进程状态"><a href="#3-3-11-查看进程状态" class="headerlink" title="3.3.11 查看进程状态"></a>3.3.11 查看进程状态</h4><p>启动后通过<code>jps</code>查看启动进程</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-02 2m-2s-sync<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># jps</span>
2117 NamesrvStartup
2261 BrokerStartup
2375 BrokerStartup
2398 Jps
</code></pre><h4 id="3-3-12-查看日志"><a href="#3-3-12-查看日志" class="headerlink" title="3.3.12 查看日志"></a>3.3.12 查看日志</h4><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看nameserver日志</span>
<span class="token function">tail</span> -500f ~/logs/rocketmqlogs/namesrv.log
<span class="token comment" spellcheck="true"># 查看broker日志</span>
<span class="token function">tail</span> -500f ~/logs/rocketmqlogs/broker.log
</code></pre><p>挑选130机器, 查看broker的启动日志</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># broker成功注册到nameserver1,nameserver2</span>
2022-05-31 22:24:58 INFO brokerOutApi_thread_2 - register broker<span class="token punctuation">[</span>1<span class="token punctuation">]</span>to name server rocketmq-nameserver1:9876 OK
2022-05-31 22:24:58 INFO brokerOutApi_thread_1 - register broker<span class="token punctuation">[</span>1<span class="token punctuation">]</span>to name server rocketmq-nameserver2:9876 OK
2022-05-31 22:24:58 INFO main - The broker<span class="token punctuation">[</span>broker-a, 192.168.65.130:11011<span class="token punctuation">]</span> boot success. serializeType<span class="token operator">=</span>JSON and name server is rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true"># 从Master同步主题配置到slave</span>
2022-05-31 22:25:01 INFO BrokerControllerScheduledThread1 - Update slave topic config from master, 192.168.65.129:10911
2022-05-31 22:25:01 INFO BrokerControllerScheduledThread1 - Update slave consumer offset from master, 192.168.65.129:10911
2022-05-31 22:25:01 INFO BrokerControllerScheduledThread1 - Update slave delay offset from master, 192.168.65.129:10911
2022-05-31 22:25:01 INFO BrokerControllerScheduledThread1 - Update slave Subscription Group from master, 192.168.65.129:10911

2022-05-31 22:25:08 INFO BrokerControllerScheduledThread1 - dispatch behind commit log 0 bytes
2022-05-31 22:25:08 INFO brokerOutApi_thread_3 - register broker<span class="token punctuation">[</span>1<span class="token punctuation">]</span>to name server rocketmq-nameserver2:9876 OK
2022-05-31 22:25:08 INFO brokerOutApi_thread_4 - register broker<span class="token punctuation">[</span>1<span class="token punctuation">]</span>to name server rocketmq-nameserver1:9876 OK
2022-05-31 22:25:11 INFO BrokerControllerScheduledThread1 - Update slave consumer offset from master, 192.168.65.129:10911
2022-05-31 22:25:11 INFO BrokerControllerScheduledThread1 - Update slave delay offset from master, 192.168.65.129:10911
2022-05-31 22:25:18 INFO brokerOutApi_thread_1 - register broker<span class="token punctuation">[</span>0<span class="token punctuation">]</span>to name server rocketmq-nameserver2:9876 OK
2022-05-31 22:25:18 INFO brokerOutApi_thread_2 - register broker<span class="token punctuation">[</span>0<span class="token punctuation">]</span>to name server rocketmq-nameserver1:9876 OK
2022-05-31 22:25:21 INFO BrokerControllerScheduledThread1 - Update slave consumer offset from master, 192.168.65.129:10911
2022-05-31 22:25:21 INFO BrokerControllerScheduledThread1 - Update slave delay offset from master, 192.168.65.129:10911
2022-05-31 22:25:31 INFO BrokerControllerScheduledThread1 - Update slave consumer offset from master, 192.168.65.129:10911
2022-05-31 22:25:31 INFO BrokerControllerScheduledThread1 - Update slave delay offset from master, 192.168.65.129:10911
2022-05-31 22:25:38 INFO TransactionalMessageCheckService - create new topic TopicConfig <span class="token punctuation">[</span>topicName<span class="token operator">=</span>RMQ_SYS_TRANS_HALF_TOPIC, readQueueNums<span class="token operator">=</span>1, writeQueueNums<span class="token operator">=</span>1, perm<span class="token operator">=</span>RW-, topicFilterType<span class="token operator">=</span>SINGLE_TAG, topicSysFlag<span class="token operator">=</span>0, order<span class="token operator">=</span>false<span class="token punctuation">]</span>
</code></pre><h3 id="3-4-mqadmin管理工具"><a href="#3-4-mqadmin管理工具" class="headerlink" title="3.4 mqadmin管理工具"></a>3.4 mqadmin管理工具</h3><h4 id="3-4-1-使用方式"><a href="#3-4-1-使用方式" class="headerlink" title="3.4.1 使用方式"></a>3.4.1 使用方式</h4><p>进入RocketMQ安装位置, 在bin目录下执行<code>./mqadmin {command} {args}</code></p><h4 id="3-4-2-命令介绍"><a href="#3-4-2-命令介绍" class="headerlink" title="3.4.2 命令介绍"></a>3.4.2 命令介绍</h4><h5 id="3-4-2-1-Topic相关"><a href="#3-4-2-1-Topic相关" class="headerlink" title="3.4.2.1 Topic相关"></a>3.4.2.1 Topic相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr><tr></tr><tr><td rowspan="8">updateTopic</td><td rowspan="8">创建新Topic配置</td><td>-b</td><td>Broker地址，表示topic所在Broker，只支持单台Broker，地址为ip:port</td></tr><tr><td>-c</td><td>cluster名称，表示topic所在集群（集群可通过clusterList查询）</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip：port</td></tr><tr><td>-p</td><td>指定新topic的读写权限(W=2|R=4|WR=6)</td></tr><tr><td>-r</td><td>可读队列数（默认为8）</td></tr><tr><td>-w</td><td>可写队列数（默认为8）</td></tr><tr><td>-t</td><td>topic名称（名称只能使用字符^[a-zA-Z0-9_-]+$)</td></tr><tr><td rowspan="4">deleteTopic</td><td rowspan="4">删除Topic</td><td>-c</td><td>cluster名称，表示删除某集群下的某个topic(集群可通过clusterList查询)</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-t</td><td>topic名称（名称只能使用字符^[a-zA-Z0-9_-]+$)</td></tr><tr><td rowspan="3">topicList</td><td rowspan="3">查看Topic列表信息</td><td>-h</td><td>打印帮助</td></tr><tr><td>-c</td><td>不配置-c，只返回topic列表，增加-c返回clusterName，topic，consumerGroup信息，即topic的所属集群和订阅关系，没有参数</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td rowspan="3">topicRoute</td><td rowspan="3">查看Topic路由信息</td><td>-t</td><td>topic名称</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td rowspan="3">topicStatus</td><td rowspan="3">查看topic消息队列offset</td><td>-t</td><td>topic名称</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td rowspan="3">topicClusterList</td><td rowspan="3">查看Topic所在集群列表</td><td>-t</td><td>topic名称</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td rowspan="6">updateTopicPerm</td><td rowspan="6">更新Topic读写权限</td><td>-t</td><td>topic名称</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-b</td><td>Broker地址，表示topic所在Broker，只支持单台Broker，地址为ip:port</td></tr><tr><td>-p</td><td>指定新topic的读写权限(W=2|R=4|WR=6)</td></tr><tr><td>-c</td><td>cluster名称，表示topic所在集群（集群可通过clusterList查询），-b优先，如果没有-b，则对集群中所有Broker执行命令</td></tr><tr><td rowspan="5">updateOrderConf</td><td rowspan="5">从NameServer上创建，删除，获取特定命名空间的kv配置，目前还未启用</td><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-t</td><td>topic, 键</td></tr><tr><td>-v</td><td>orderConf，值</td></tr><tr><td>-m</td><td>method, 可选get，put，delete</td></tr><tr><td rowspan="3">allocateMQ</td><td rowspan="3">以平均负载算法计算消费者列表负载消息队列的负载结果</td><td>-t</td><td>topic名称</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr></tbody></table><h5 id="3-4-2-2-集群相关"><a href="#3-4-2-2-集群相关" class="headerlink" title="3.4.2.2 集群相关"></a>3.4.2.2 集群相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr><tr><td rowspan="4">clusterList</td><td rowspan="4">查看集群信息，集群，BrokerName，BrokerId，TPS等信息</td><td>-m</td><td>打印更多信息（增加打印出如下信息#InotalYest,#OutTotalYest,#InTotalToday,#OutTotalToday</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-i</td><td>打印间隔，单位秒</td></tr><tr><td rowspan="9">culsterRT</td><td rowspan="9">发送消息检测集群各BrokerRT. 消息发往$(BrokerName) Topic</td><td>-a</td><td>amountj, 每次探测的总数，RT=总时间/amount</td></tr><tr><td>-s</td><td>消息大小，单位B</td></tr><tr><td>-c</td><td>探测哪个集群</td></tr><tr><td>-p</td><td>是否打印格式化日志，以|分割，默认不打印</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td>-m</td><td>所属机房，打印使用</td></tr><tr><td>-i</td><td>发送间隔，单位秒</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr></tbody></table><h5 id="3-4-2-3-Broker相关"><a href="#3-4-2-3-Broker相关" class="headerlink" title="3.4.2.3 Broker相关"></a>3.4.2.3 Broker相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr></tbody></table><h5 id="3-4-2-4-消息相关"><a href="#3-4-2-4-消息相关" class="headerlink" title="3.4.2.4 消息相关"></a>3.4.2.4 消息相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr></tbody></table><h5 id="3-4-2-5-消费者，消费组相关"><a href="#3-4-2-5-消费者，消费组相关" class="headerlink" title="3.4.2.5 消费者，消费组相关"></a>3.4.2.5 消费者，消费组相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr></tbody></table><h5 id="3-4-2-6-连接相关"><a href="#3-4-2-6-连接相关" class="headerlink" title="3.4.2.6 连接相关"></a>3.4.2.6 连接相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr><tr><td rowspan="3">consumerConnection</td><td rowspan="3">查询Consumer的网络连接</td><td>-g</td><td>消费者所属组名</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td rowspan="4">producerConnection</td><td rowspan="4">查询Producer的网络连接</td><td>-g</td><td>生产者所属组名</td></tr><tr><td>-t</td><td>主题名称</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr></tbody></table><h5 id="3-4-2-7-NameServer相关"><a href="#3-4-2-7-NameServer相关" class="headerlink" title="3.4.2.7 NameServer相关"></a>3.4.2.7 NameServer相关</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr><tr><td rowspan="5">updateKvConfig</td><td rowspan="5">更新NameServer的kv配置，目前还未使用</td><td>-s</td><td>命名空间</td></tr><tr><td>-k</td><td>key</td></tr><tr><td>-v</td><td>value</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td rowspan="4">deleteKvConfig</td><td rowspan="4">删除Nameserver的kv配置</td><td>-s</td><td>命名空间</td></tr><tr><td>-k</td><td>key</td></tr><tr><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td rowspan="2">getNameSrvConfig</td><td rowspan="2">获取NameServer配置</td><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td rowspan="4">updateKvConfig</td><td rowspan="4">修改Nameserver的kv配置</td><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-k</td><td>key</td></tr><tr><td>-v</td><td>value</td></tr><tr><td>-h</td><td>打印帮助</td></tr><tr><td rowspan="2">getNameSrvConfig</td><td rowspan="2">获取NameServer配置</td><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr></tbody></table><h5 id="3-4-2-8-其他"><a href="#3-4-2-8-其他" class="headerlink" title="3.4.2.8 其他"></a>3.4.2.8 其他</h5><table><tbody><tr><td>名称</td><td>含义</td><td>命令选项</td><td>说明</td></tr><tr><td rowspan="2">startMonitoring</td><td rowspan="2">开启监控进程，监控消息误删，重试队列消息数等</td><td>-n</td><td>NameServer服务地址，格式ip:port</td></tr><tr><td>-h</td><td>打印帮助</td></tr></tbody></table><h4 id="3-4-3-注意事项"><a href="#3-4-3-注意事项" class="headerlink" title="3.4.3 注意事项"></a>3.4.3 注意事项</h4><ul><li>几乎所有命令都需要配置-n表示NameServer地址，格式为ip:port</li><li>几乎所有命令都可以通过-h获取帮助</li><li>如果既有Broker地址(-b)配置项，又有clusterName(-c)配置项，则优先以Broker地址执行命令；如果不配置Broker地址，则对集群中所有主机执行命令。</li></ul><h3 id="3-5-集群监控平台搭建"><a href="#3-5-集群监控平台搭建" class="headerlink" title="3.5 集群监控平台搭建"></a>3.5 集群监控平台搭建</h3><h4 id="3-5-1-概述"><a href="#3-5-1-概述" class="headerlink" title="3.5.1 概述"></a>3.5.1 概述</h4><p><code>RocketMQ</code>有一个对其扩展的开源项目<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals/releases">incubactor-rocketmq-externals</a>, 这个项目中有一个子模块叫<code>rocketmq-console</code>, 这个便是管理控制台项目，先将<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals/releases">incubactor-rocketmq-externals</a>拉到本地，因为我们需要自己对<code>rocketmq-console</code>进行编译打包运行。</p><h4 id="3-5-2-下载并编译打包"><a href="#3-5-2-下载并编译打包" class="headerlink" title="3.5.2 下载并编译打包"></a>3.5.2 下载并编译打包</h4><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/apache/rocketmq-externals
<span class="token function">cd</span> rocketmq-console
mvn clean package -Dmaven.test.skip<span class="token operator">=</span>true
</code></pre><p>注意：打包前在<code>rocketmq-console</code>的<code>application.properties</code>中配置<code>namesrv</code>集群地址：</p><pre class="language-bash"><code class="language-bash">rocketmq.config.namesrvAddr<span class="token operator">=</span>92.168.65.129:9876<span class="token punctuation">;</span>92.168.65.130:9876
</code></pre><p>启动rocketmq-console:</p><pre class="language-bash"><code class="language-bash">java -jar rocketmq-console-ng-2.0.0.jar
</code></pre><p>启动成功后, 我们就可以通过浏览器访问<code>http://localhost:8080</code>进入控制台界面了, 如下图：<br><img src="https://img-blog.csdnimg.cn/3c81fc637e9345d2b64044d32878dc93.png#pic_center" alt="在这里插入图片描述"></p><h2 id="4-RocketMQ消息案例"><a href="#4-RocketMQ消息案例" class="headerlink" title="4. RocketMQ消息案例"></a>4. RocketMQ消息案例</h2><h3 id="4-1-消息生产-消费分析"><a href="#4-1-消息生产-消费分析" class="headerlink" title="4.1 消息生产/消费分析"></a>4.1 消息生产/消费分析</h3><p>导入MQ客户端依赖</p><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.9.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre><p>消息生产者步骤：</p><ul><li>创建消息生产者producer，并指定生产者组名</li><li>指定nameserver地址</li><li>启动producer</li><li>创建消息对象，指定主题Topic，Tag和消息体</li><li>发送消息</li><li>关闭生产者producer</li></ul><p>消息消费者步骤：</p><ul><li>创建消费者Consumer， 指定消费者组名</li><li>指定NameServer地址</li><li>订阅主题Topic和Tag</li><li>设置回调函数，处理消息</li><li>启动消费者Consumer</li></ul><h3 id="4-2-消息发送"><a href="#4-2-消息发送" class="headerlink" title="4.2 消息发送"></a>4.2 消息发送</h3><h4 id="4-2-1-发送同步消息"><a href="#4-2-1-发送同步消息" class="headerlink" title="4.2.1 发送同步消息"></a>4.2.1 发送同步消息</h4><p>这种同步的发送方式使用比较广泛，比如： 重要的消息通知，短信通知。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>base<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQBrokerException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：发送同步消息
 * @author crysw
 * @date 2022/6/4 19:46
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> MQBrokerException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实例化消息生产者Producer</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"producerGroupNm1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置NameServer地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动Producer</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建消息,并指定topic,tag和消息体</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ +"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"Tag1"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送消息到一个Broker</span>
            SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 通过sendResult返回消息判断是否成功送达</span>
<span class="token comment" spellcheck="true">//            System.out.printf("%s%n", sendResult);</span>
            <span class="token comment" spellcheck="true">// 发送状态</span>
            SendStatus status <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息ID</span>
            String msgId <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息接收队列ID</span>
            <span class="token keyword">int</span> queueId <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送状态: %s, 消息ID: %s , 队列: %s %n"</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 关闭Producer</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>测试结果：</p><pre class="language-bash"><code class="language-bash">发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6DFF00000 , 队列: 0 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0080001 , 队列: 1 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0100002 , 队列: 2 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0190003 , 队列: 3 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0210004 , 队列: 0 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E02E0005 , 队列: 1 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0340006 , 队列: 2 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E03C0007 , 队列: 3 
发送状态: SLAVE_NOT_AVAILABLE, 消息ID: 7F000001559C18B4AAC213C6E0420008 , 队列: 0 
</code></pre><h4 id="4-2-2-发送异步消息"><a href="#4-2-2-发送异步消息" class="headerlink" title="4.2.2 发送异步消息"></a>4.2.2 发送异步消息</h4><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间的等待Broker的响应。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>base<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendCallback<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：发送异步消息
 * @author crysw
 * @date 2022/6/4 20:18
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//- 创建消息生产者producer，并指定生产者组名</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"producerGroupNm1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 指定nameserver地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 启动producer</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置失败后的重试次数</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 创建消息对象，指定主题Topic，Tag和消息体</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"Hello World "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"Tag2"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//- 发送异步消息,SendCallback接收异步返回结果的回调</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>SendResult sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 发送成功后的回调结果</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span>Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 发送失败的回调结果</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送失败: "</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//- 关闭生产者producer</span>
        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>测试结果：</p><pre class="language-bash"><code class="language-bash">SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000152E418B4AAC213DFE34B0000, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000007122, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>base, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>26<span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000152E418B4AAC213DFE34E0005, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F0000000000006FA0, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>base, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>24<span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000152E418B4AAC213DFE35C0006, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000007402, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>base, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>25<span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000152E418B4AAC213DFE34D0002, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000734A, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>base, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>27<span class="token punctuation">]</span>
// <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
</code></pre><h4 id="4-2-3-发送单向消息"><a href="#4-2-3-发送单向消息" class="headerlink" title="4.2.3 发送单向消息"></a>4.2.3 发送单向消息</h4><p>主要用在不特别关心发送结果的场景，例如日志发送。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>base<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：发送单向消息
 * @author crysw
 * @date 2022/6/4 20:40
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OneWayProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>

        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"producerGroupNm1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//- 创建消息对象，指定主题Topic，Tag和消息体</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"one way msg"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"Tag3"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送单向消息</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="4-3-消息消费"><a href="#4-3-消息消费" class="headerlink" title="4.3 消息消费"></a>4.3 消息消费</h3><p>两种消费模式</p><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> MessageModel <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// 广播模式</span>
    <span class="token function">BROADCASTING</span><span class="token punctuation">(</span><span class="token string">"BROADCASTING"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment" spellcheck="true">// 负载均衡模式（集群）</span>
    <span class="token function">CLUSTERING</span><span class="token punctuation">(</span><span class="token string">"CLUSTERING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="4-3-1-负载均衡模式"><a href="#4-3-1-负载均衡模式" class="headerlink" title="4.3.1 负载均衡模式"></a>4.3.1 负载均衡模式</h4><p>消费者采用负载均衡方式进行消费消息， 多个消费者共同消费队列消息， 每个消费者处理的消息不同。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>base<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>heartbeat<span class="token punctuation">.</span>MessageModel<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：消费者
 * @author crysw
 * @date 2022/6/4 20:50
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//- 创建消费者Consumer， 指定消费者组名</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"consumerGroupNm1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 指定NameServer地址</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 订阅主题Topic和Tag</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"Tag1 || Tag2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置负载均衡模式消费， 默认也是负载均衡模式</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 注册监听器, 设置回调函数，处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> messageExts<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            messageExts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//- 启动消费者Consumer</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>测试结果：</p><pre class="language-bash"><code class="language-bash">MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>1, storeSize<span class="token operator">=</span>189, queueOffset<span class="token operator">=</span>2, sysFlag<span class="token operator">=</span>0, bornTimestamp<span class="token operator">=</span>1654344600741, bornHost<span class="token operator">=</span>/192.168.65.1:55630, storeTimestamp<span class="token operator">=</span>1654344600836, storeHost<span class="token operator">=</span>/192.168.65.130:10911, msgId<span class="token operator">=</span>C0A8418200002A9F0000000000002C81, commitLogOffset<span class="token operator">=</span>11393, bodyCRC<span class="token operator">=</span>1417976316, reconsumeTimes<span class="token operator">=</span>0, preparedTransactionOffset<span class="token operator">=</span>0, toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span>Message<span class="token punctuation">{</span>topic<span class="token operator">=</span><span class="token string">'base'</span>, flag<span class="token operator">=</span>0, properties<span class="token operator">=</span><span class="token punctuation">{</span>MIN_OFFSET<span class="token operator">=</span>0, MAX_OFFSET<span class="token operator">=</span>26, CONSUME_START_TIME<span class="token operator">=</span>1654347508837, UNIQ_KEY<span class="token operator">=</span>7F000001559C18B4AAC213C6E0A50015, CLUSTER<span class="token operator">=</span>rocketmq-cluster, TAGS<span class="token operator">=</span>Tag1<span class="token punctuation">}</span>, body<span class="token operator">=</span><span class="token punctuation">[</span>72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 43, 50, 49<span class="token punctuation">]</span>, transactionId<span class="token operator">=</span><span class="token string">'null'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
// <span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><h4 id="4-3-2-广播模式"><a href="#4-3-2-广播模式" class="headerlink" title="4.3.2 广播模式"></a>4.3.2 广播模式</h4><p>消费者采用广播模式进行消费消息，每个消费者消费的消息都是相同的。</p><pre class="language-java"><code class="language-java">consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="4-4-顺序消息"><a href="#4-4-顺序消息" class="headerlink" title="4.4 顺序消息"></a>4.4 顺序消息</h3><p>消息有序指的是可以按照消息的发送顺序来消费（FIFO)，RocketMQ可以严格的保证消息有序，可以分为<code>分区有序</code>和<code>全局有序</code>。</p><p>顺序消费的原理解析， 在默认的情况下消息发送会采取Round Robin轮询方式把消息发送到不同的queue（分区队列）；而消费消息的时候从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个queue中，消费的时候只从这个queue上依次拉取消息， 则就保证了顺序。</p><p>当发送和消费参与的queue只有一个，则是全局有序。</p><p>如果多个queue参与，则为分区有序，即相对每个queue，消息都是有序的。</p><p>下面用订单进行分区有序的示例。一个订单的顺序流程是：创建，付款，推送，完成。 订单号相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列。<br><img src="https://img-blog.csdnimg.cn/82f50ee29b394a678c63f5cbc170e472.png#pic_center" alt="在这里插入图片描述"></p><h4 id="4-4-1-顺序消息生产"><a href="#4-4-1-顺序消息生产" class="headerlink" title="4.4.1 顺序消息生产"></a>4.4.1 顺序消息生产</h4><p>首先构建订单信息类</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>order<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>AllArgsConstructor<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Builder<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>NoArgsConstructor<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：订单
 * @author crysw
 * @date 2022/6/4 21:42
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStep</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 订单ID
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> orderId<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * desc
     */</span>
    <span class="token keyword">private</span> String desc<span class="token punctuation">;</span>

   <span class="token comment" spellcheck="true">// 模拟订单信息</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> <span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> orderStepList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 1039L</span>
        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1039L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1039L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1039L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1039L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 1065L</span>
        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1065L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1065L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1065L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>1065L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 7235L</span>
        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>7235L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>7235L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>7235L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        orderStepList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>OrderStep<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>7235L<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderStepList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>编写订单生产者</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>order<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQBrokerException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageQueue<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：订单生产者
 * @author crysw
 * @date 2022/6/4 21:50
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> MQBrokerException <span class="token punctuation">{</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"producerGroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 构建消息集合</span>
        List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> orderSteps <span class="token operator">=</span> OrderStep<span class="token punctuation">.</span><span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> orderSteps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> orderSteps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"OrderTopic"</span><span class="token punctuation">,</span> <span class="token string">"Order"</span><span class="token punctuation">,</span> <span class="token string">"key"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/**
             * 参数一:消息对象
             * 参数二:消息队列的选择器
             * 参数三:选择队列的业务标识(订单ID)
             */</span>
            SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqs<span class="token punctuation">,</span> Message message<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">/**
                         * lambda表达式
                         * 参数一: 消息队列集合
                         * 参数二: 消息对象
                         * 参数三:业务标识的参数
                         */</span>
                        <span class="token keyword">long</span> orderId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                           <span class="token comment" spellcheck="true">// 相同的订单ID对消息队列取模后，会将相同订单周期中的不同节点由同一个消息队列进行发送，保证消息顺序性</span>
                        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> orderId <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// 将业务唯一标识订单ID传递给arg, 后面通过订单ID和消息队列集合大小取模决定生产者消息推送的队列</span>
                    orderSteps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送结果:"</span> <span class="token operator">+</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>生产者测试日志：</p><pre class="language-bash"><code class="language-bash">// 1039L
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1450000, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F0000000000007F4C, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>13<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD19D0001, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F000000000000802C, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>14<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1A30002, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F000000000000810C, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>15<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1A90003, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F00000000000081EC, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>16<span class="token punctuation">]</span>
// 1065L
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1B40004, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000009082, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>13<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1BA0005, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000009162, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>14<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1C10006, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000009242, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>15<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1CA0007, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000009322, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>16<span class="token punctuation">]</span>
// 7235L
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1D00008, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F0000000000009402, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>13<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1D80009, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F00000000000094E2, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>14<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1E2000A, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F00000000000095C2, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>15<span class="token punctuation">]</span>
发送结果:SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000013A4818B4AAC22E3BD1E9000B, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F00000000000096A3, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>OrderTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>16<span class="token punctuation">]</span>
</code></pre><h4 id="4-4-2-顺序消息消费"><a href="#4-4-2-顺序消息消费" class="headerlink" title="4.4.2 顺序消息消费"></a>4.4.2 顺序消息消费</h4><p>编写订单消费者，顺序消费订单消息</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>order<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：订单消费者
 * @author crysw
 * @date 2022/6/9 22:46
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"consumerGroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 订阅主题和tag</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"OrderTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册消息监听器</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            msgs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>msg <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"queueId: ["</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]: "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 启动消费者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"启动消费者....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>查看订单消费的日志, 可以看到每个订单的创建，付款，推送，完成过程都是由从同一个队列进行消费的，保证了消息的顺序性。</p><pre class="language-bash"><code class="language-bash">启动消费者<span class="token punctuation">..</span><span class="token punctuation">..</span>.
// 1039
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1039, desc<span class="token operator">=</span>付款<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1039, desc<span class="token operator">=</span>创建<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1039, desc<span class="token operator">=</span>推送<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1039, desc<span class="token operator">=</span>完成<span class="token punctuation">)</span>
// 1065
queueId: <span class="token punctuation">[</span>1<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1065, desc<span class="token operator">=</span>创建<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>1<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1065, desc<span class="token operator">=</span>付款<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>1<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1065, desc<span class="token operator">=</span>推送<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>1<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>1065, desc<span class="token operator">=</span>完成<span class="token punctuation">)</span>
// 7235
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>7235, desc<span class="token operator">=</span>创建<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>7235, desc<span class="token operator">=</span>付款<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>7235, desc<span class="token operator">=</span>推送<span class="token punctuation">)</span>
queueId: <span class="token punctuation">[</span>3<span class="token punctuation">]</span>: OrderStep<span class="token punctuation">(</span>orderId<span class="token operator">=</span>7235, desc<span class="token operator">=</span>完成<span class="token punctuation">)</span>
</code></pre><h3 id="4-5-延时消息"><a href="#4-5-延时消息" class="headerlink" title="4.5 延时消息"></a>4.5 延时消息</h3><p>比如电商，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p><h4 id="4-5-1-延时消息生产者"><a href="#4-5-1-延时消息生产者" class="headerlink" title="4.5.1 延时消息生产者"></a>4.5.1 延时消息生产者</h4><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQBrokerException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：延时消息的生产者
 * @author crysw
 * @date 2022/6/11 11:13
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> MQBrokerException <span class="token punctuation">{</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"pgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 构建消息 topic, tag, body</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"delayTopic"</span><span class="token punctuation">,</span> <span class="token string">"Tag1"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello World "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 设定延迟时间 等级2=5s   messageDelayLevel = 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h 1d</span>
            message<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送消息</span>
            SendResult result <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送结果: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 线程休眠1s</span>
            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="4-5-2-延时消息消费者"><a href="#4-5-2-延时消息消费者" class="headerlink" title="4.5.2 延时消息消费者"></a>4.5.2 延时消息消费者</h4><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>heartbeat<span class="token punctuation">.</span>MessageModel<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述: 延迟消息的消费者
 * @author crysw
 * @date 2022/6/11 11:13
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"cgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"delayTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置消费模式: 负载均衡, 广播模式;  默认是负载均衡模式</span>
        consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册消息监听器, 回调函数处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> messageExts<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>

            messageExts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>messageExt <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"QueueId:"</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", messageID: "</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                         <span class="token operator">+</span> <span class="token string">", 延时时间: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> messageExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", body: "</span> 
                         <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者启动, ......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="4-5-3-验证"><a href="#4-5-3-验证" class="headerlink" title="4.5.3 验证"></a>4.5.3 验证</h4><p>启动生产者延时发送消息.</p><pre class="language-bash"><code class="language-bash">发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC0F910000, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000AE88, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>0<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>12<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC11960001, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000AF82, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>13<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC13970002, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000B07C, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>2<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>14<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC15900003, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000B176, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>15<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC178B0004, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F0000000000009224, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>0<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>8<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC19860005, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F000000000000931E, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>9<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC1B7E0006, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F0000000000009418, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>2<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>10<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC1D770007, offsetMsgId<span class="token operator">=</span>C0A8418200002A9F0000000000009512, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-b, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>11<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC1F700008, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000B270, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>0<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>16<span class="token punctuation">]</span>
发送结果: SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F0000012A5818B4AAC235FC216A0009, offsetMsgId<span class="token operator">=</span>C0A8418100002A9F000000000000B36A, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>delayTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>1<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>17<span class="token punctuation">]</span>
11:35:16.651 <span class="token punctuation">[</span>NettyClientSelector_1<span class="token punctuation">]</span> INFO RocketmqRemoting - closeChannel: close the connection to remote address<span class="token punctuation">[</span>192.168.65.129:9876<span class="token punctuation">]</span> result: <span class="token boolean">true</span>
11:35:16.660 <span class="token punctuation">[</span>NettyClientSelector_1<span class="token punctuation">]</span> INFO RocketmqRemoting - closeChannel: close the connection to remote address<span class="token punctuation">[</span>192.168.65.129:9876<span class="token punctuation">]</span> result: <span class="token boolean">true</span>
11:35:16.660 <span class="token punctuation">[</span>NettyClientSelector_1<span class="token punctuation">]</span> INFO RocketmqRemoting - closeChannel: close the connection to remote address<span class="token punctuation">[</span>192.168.65.129:10911<span class="token punctuation">]</span> result: <span class="token boolean">true</span>
11:35:16.661 <span class="token punctuation">[</span>NettyClientSelector_1<span class="token punctuation">]</span> INFO RocketmqRemoting - closeChannel: close the connection to remote address<span class="token punctuation">[</span>192.168.65.130:10911<span class="token punctuation">]</span> result: <span class="token boolean">true</span>
11:35:16.661 <span class="token punctuation">[</span>NettyClientSelector_1<span class="token punctuation">]</span> INFO RocketmqRemoting - closeChannel: close the connection to remote address<span class="token punctuation">[</span>192.168.65.130:11011<span class="token punctuation">]</span> result: <span class="token boolean">true</span>
</code></pre><p>启动消费者, 会看到消息的消费比存储时间晚(延时)10s左右.</p><pre class="language-bash"><code class="language-bash">消费者启动, <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
QueueId:1, messageID: 7F0000012A5818B4AAC235FC19860005, 延时时间: 8441, body: Hello World 5
QueueId:1, messageID: 7F0000012A5818B4AAC235FC216A0009, 延时时间: 6435, body: Hello World 9
QueueId:0, messageID: 7F0000012A5818B4AAC235FC1F700008, 延时时间: 6939, body: Hello World 8
QueueId:1, messageID: 7F0000012A5818B4AAC235FC11960001, 延时时间: 10493, body: Hello World 1
QueueId:0, messageID: 7F0000012A5818B4AAC235FC0F910000, 延时时间: 11000, body: Hello World 0
QueueId:2, messageID: 7F0000012A5818B4AAC235FC13970002, 延时时间: 9975, body: Hello World 2
QueueId:3, messageID: 7F0000012A5818B4AAC235FC15900003, 延时时间: 9466, body: Hello World 3
QueueId:2, messageID: 7F0000012A5818B4AAC235FC1B7E0006, 延时时间: 7933, body: Hello World 6
QueueId:3, messageID: 7F0000012A5818B4AAC235FC1D770007, 延时时间: 7428, body: Hello World 7
QueueId:0, messageID: 7F0000012A5818B4AAC235FC178B0004, 延时时间: 8844, body: Hello World 4
</code></pre><h4 id="4-5-4-使用限制"><a href="#4-5-4-使用限制" class="headerlink" title="4.5.4 使用限制"></a>4.5.4 使用限制</h4><p>现在RocketMQ并不支持任意时间的延时, 需要设置几个固定的延时等级, 从1s到1d分别对应着等级1到19. 延时等级定义在RocketMQ服务端的<code>MessageStoreConfig</code>类中的如下变量中：</p><pre class="language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org/apache/rocketmq/store/config/MessageStoreConfig.java</span>
messageDelayLevel <span class="token operator">=</span> 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h <span class="token number">1d</span>
</code></pre><h3 id="4-6批量消息"><a href="#4-6批量消息" class="headerlink" title="4.6批量消息"></a>4.6批量消息</h3><p>批量发送消息能显著提高传递消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK， 而且不能是延时消息。 此外，这一批消息的总大小不应超过4MB。</p><h4 id="4-6-1-发送批量消息"><a href="#4-6-1-发送批量消息" class="headerlink" title="4.6.1 发送批量消息"></a>4.6.1 发送批量消息</h4><p>如果每次只发送不超过4MB的消息， 则很容易使用批处理， 如下：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>batch<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQBrokerException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：批量消息生产者
 * @author crysw
 * @date 2022/6/11 11:53
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> MQBrokerException <span class="token punctuation">{</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"pgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String topic <span class="token operator">=</span> <span class="token string">"batchTopic"</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 当每条消息不超过4MB,可以直接使用批量发送</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 构建消息 topic, tag, body</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"Tag1"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello World"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 发送消息</span>
        SendResult result <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送结果: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>如果消息的总长度大于4MB，这时候需要将消息进行分割，如下：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>batch<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：定义消息列表分割器
 * 消息列表分割器：其只会处理每条消息的大小不超4M的情况。若存在某条消息，其本身大小大于4M，这个分割器无法处理，其直接将这条消息构成一个子列表返回。并没有再进行分割
 * @author crysw
 * @date 2022/5/19 20:59
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageListSplitter</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Message<span class="token operator">>></span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// 指定极限值为4M</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIZE_LIMIT <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 存放所有要发送的消息</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 要进行批量发送消息的小集合起始索引</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currIndex<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MessageListSplitter</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> messages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 判断当前开始遍历的消息索引要小于消息总数</span>
        <span class="token keyword">return</span> currIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 生产者通过send()方法发送的Message，并不是直接将Message序列化后发送到网络上的，而是通过这个Message生成了一个字符串发送出去的。
     * 这个字符串由四部分构成：Topic、消息Body、消息日志（占 20 字节），及用于描述消息的一堆属性key-value。
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Message<span class="token operator">></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> currIndex<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 记录当前要发送的这一小批次消息列表的大小</span>
        <span class="token keyword">int</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nextIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nextIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取当前遍历的消息</span>
            Message message <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 统计当前遍历的message的大小</span>
            <span class="token keyword">int</span> tempSize <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tempSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tempSize <span class="token operator">+=</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 判断当前消息本身是否大于4M</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tempSize <span class="token operator">></span> SIZE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">==</span> currIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>tempSize <span class="token operator">+</span> totalSize <span class="token operator">></span> SIZE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                totalSize <span class="token operator">+=</span> tempSize<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// end for</span>
        <span class="token comment" spellcheck="true">// 获取当前messages列表的子集合[currIndex, nextIndex)</span>
        List<span class="token operator">&lt;</span>Message<span class="token operator">></span> subList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>currIndex<span class="token punctuation">,</span> nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 下次遍历的开始索引</span>
        currIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
        <span class="token keyword">return</span> subList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>如果消息超过4MB， 将消息列表分割后再批量发送。</p><pre class="language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 发送消息</span>
MessageSpliter messageSpliter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageSpliter</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>messageSpliter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>Message<span class="token operator">></span> subMsgList <span class="token operator">=</span> messageSpliter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SendResult result <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送结果: "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="4-7-过滤消息"><a href="#4-7-过滤消息" class="headerlink" title="4.7 过滤消息"></a>4.7 过滤消息</h3><p>在大多数情况下，Tag可以用来过滤你想要的消息。通过consumer的subscribe()方法指定要订阅消息的Tag。如果订阅多个Tag的消息，Tag间使用<code>或运算符</code>(双竖线||)连接。例如：</p><pre class="language-java"><code class="language-java">DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"cgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//consumer.subscribe("batchTopic", "*");</span>
<span class="token comment" spellcheck="true">// Tag过滤</span>
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"batchTopic"</span><span class="token punctuation">,</span> <span class="token string">"Tag1 || Tag2 || Tag3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>消费者将接收包含Tag1，Tag2或Tag3的消息，但是限制一个消息只能有一个标签，这对于复杂的场景可能不起作用， 在这种情况下， 可以使用SQL表达式筛选消息。 SQL特性可以通过发送消息时的属性来进行计算。 在RocketMQ定义的语法下，可以实现一些简单的逻辑。 下面是一个例子：</p><pre class="language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-------------</span>
<span class="token operator">|</span>  message  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment" spellcheck="true">-----------|    a > 5 AND b = 'abc'</span>
<span class="token operator">|</span>     <span class="token number">a</span> <span class="token operator">=</span> <span class="token number">10</span>    <span class="token operator">|</span><span class="token comment" spellcheck="true">--------------------->> Gotten</span>
<span class="token operator">|</span>     <span class="token number">b</span> <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">c</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token operator">|</span>
<span class="token comment" spellcheck="true">-------------</span>
<span class="token comment" spellcheck="true">-------------</span>
<span class="token operator">|</span>  message  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment" spellcheck="true">-----------|    a > 5 AND b = 'abc'</span>
<span class="token operator">|</span>     <span class="token number">a</span> <span class="token operator">=</span> <span class="token number">1</span>        <span class="token operator">|</span><span class="token comment" spellcheck="true">--------------------->> Missed</span>
<span class="token operator">|</span>     <span class="token number">b</span> <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">c</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token operator">|</span>
<span class="token comment" spellcheck="true">-------------</span>
</code></pre><h4 id="4-7-1-SQL基本语法"><a href="#4-7-1-SQL基本语法" class="headerlink" title="4.7.1 SQL基本语法"></a>4.7.1 SQL基本语法</h4><p>RocketMQ只定义了一些基本语法来支持这个特性， 可以很容易扩展。</p><ul><li>数值比较，比如： &gt; , &gt;=, &lt;=, BETWEEN, = ;</li><li>字符比较，比如：= , &lt;&gt;, IN;</li><li>IS NULL 或者 IS NOT NULL;</li><li>逻辑符号 AND, OR ,NOT;</li></ul><p>常量支持类型为：</p><ul><li>数值： 比如 123， 3.1415；</li><li>字符： 比如 ‘abc’, 必须用单引号括起来；</li><li>NULL， 特殊的常量；</li><li>布尔值， TRUE或FALSE</li></ul><p>只有使用push模式的消费者才能使用SQL92标准的sql语句，接口如下：</p><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> MessageSelector messageSelector<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><h4 id="4-7-2-消息生产者"><a href="#4-7-2-消息生产者" class="headerlink" title="4.7.2 消息生产者"></a>4.7.2 消息生产者</h4><p>发送消息时，你能通过<code>putUserProperty</code>来设置消息的属性。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>filter<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQBrokerException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>DefaultMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>SendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RemotingHelper<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>RemotingException<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>UnsupportedEncodingException<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：SQL过滤的生产者
 * @author crysw
 * @date 2022/6/11 14:03
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> UnsupportedEncodingException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> MQBrokerException <span class="token punctuation">{</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"pgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"filterTopic"</span><span class="token punctuation">,</span> <span class="token string">"tag1"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 设置一些属性</span>
            message<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="4-7-3-消息消费者"><a href="#4-7-3-消息消费者" class="headerlink" title="4.7.3 消息消费者"></a>4.7.3 消息消费者</h4><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>filter<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>MessageSelector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RemotingHelper<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>UnsupportedEncodingException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：SQL过滤的消费者
 * @author crysw
 * @date 2022/6/11 14:09
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlFilterConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"cgroup1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 订阅消息主题</span>
        <span class="token comment" spellcheck="true">// tag过滤</span>
<span class="token comment" spellcheck="true">//        consumer.subscribe("filterTopic", "Tag1 || Tag2 || Tag3");</span>
        <span class="token comment" spellcheck="true">// SQL过滤条件</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"filterTopic"</span><span class="token punctuation">,</span> MessageSelector<span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"a>5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册监听</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> messageExts<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            messageExts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>messageExt <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token string">"QueueID: "</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", MessageID: "</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", body: "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者启动了,....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="4-7-4-测试效果"><a href="#4-7-4-测试效果" class="headerlink" title="4.7.4 测试效果"></a>4.7.4 测试效果</h4><p>发送消息成功后，启动消费者发现报错。</p><pre class="language-bash"><code class="language-bash">Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> org.apache.rocketmq.client.exception.MQClientException: CODE: 1  DESC: The broker does not support consumer to filter message by SQL92
For <span class="token function">more</span> information, please visit the url, http://rocketmq.apache.org/docs/faq/
    at org.apache.rocketmq.client.impl.MQClientAPIImpl.checkClientInBroker<span class="token punctuation">(</span>MQClientAPIImpl.java:2280<span class="token punctuation">)</span>
    at org.apache.rocketmq.client.impl.factory.MQClientInstance.checkClientInBroker<span class="token punctuation">(</span>MQClientInstance.java:450<span class="token punctuation">)</span>
    at org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl.start<span class="token punctuation">(</span>DefaultMQPushConsumerImpl.java:655<span class="token punctuation">)</span>
    at org.apache.rocketmq.client.consumer.DefaultMQPushConsumer.start<span class="token punctuation">(</span>DefaultMQPushConsumer.java:707<span class="token punctuation">)</span>
    at com.crysw.bootrocketmq.filter.SqlFilterConsumer.main<span class="token punctuation">(</span>SqlFilterConsumer.java:43<span class="token punctuation">)</span>
</code></pre><p><strong>报错原因：</strong></p><p>从console控制台可以看到集群中的broker配置， <code>enablePropertyFilter=false</code> , 默认情况下Broker没有开启消息的SQL过滤功能。<br><img src="https://img-blog.csdnimg.cn/8a6b0ae6b0c0454a9b2c7bfbb7610947.png#pic_center" alt="在这里插入图片描述"></p><p><strong>解决方案：</strong></p><p>需要在Broker加载的配置文件中添加如下属性，以开启该功能：</p><pre class="language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 开启SQL过滤支持</span>
<span class="token attr-name">enablePropertyFilter</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre><p>在启动Broker时需要指定这个修改过的配置文件。例如对于集群Broker的启动，其修改的配置文件是conf/2m-2s-sync/broker-*.conf，启动时使用如下命令：</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 先停掉broker，NameServer</span>
sh mqshutdown broker
sh mqshutdown namesrv
<span class="token comment" spellcheck="true"># NameServer1 &amp; NameServer2</span>
<span class="token function">nohup</span> sh mqnamesrv <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># Master1</span>
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># Slave2</span>
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># Master2</span>
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b.properties <span class="token operator">&amp;</span>
<span class="token comment" spellcheck="true"># Slave1</span>
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a-s.properties <span class="token operator">&amp;</span>
</code></pre><p>查看console控制台的集群配置，已经开启SQL过滤支持。<br><img src="https://img-blog.csdnimg.cn/87dd54bf885441db8dc190ab45e5cc2f.png#pic_center" alt="在这里插入图片描述"></p><p>重启后重新测试，消费正常。可以看到日志打印的结果只有a&gt;5的消息被消费了。</p><pre class="language-bash"><code class="language-bash">消费者启动了,<span class="token punctuation">..</span><span class="token punctuation">..</span>.
QueueID: 0, MessageID: 7F0000016D7018B4AAC238388EEC0006, body: Hello RocketMQ 6
QueueID: 1, MessageID: 7F0000016D7018B4AAC238388EFB0007, body: Hello RocketMQ 7
QueueID: 2, MessageID: 7F0000016D7018B4AAC238388F010008, body: Hello RocketMQ 8
QueueID: 3, MessageID: 7F0000016D7018B4AAC238388F0B0009, body: Hello RocketMQ 9
</code></pre><h3 id="4-8-事务消息"><a href="#4-8-事务消息" class="headerlink" title="4.8 事务消息"></a>4.8 事务消息</h3><h4 id="4-8-1-流程分析"><a href="#4-8-1-流程分析" class="headerlink" title="4.8.1 流程分析"></a>4.8.1 流程分析</h4><p>下图说明了事务消息的大致方案， 其中分为两个流程： 正常事务消息的发送及提交， 事务消息的补偿流程。<br><img src="https://img-blog.csdnimg.cn/bf9c654a02554afd9f7a0213c160452d.png#pic_center" alt="在这里插入图片描述"></p><p><strong>1）事务消息发送及提交</strong></p><ul><li>发送消息（半消息）；</li><li>服务端响应消息写入结果；</li><li>根据发送结果执行本地事务，如果写入失败，此时半消息对业务不可见，本地逻辑不执行；</li><li>根据本地事务状态执行commit或rollback， commit操作生成消息索引， 消息对消费者可见。</li></ul><p><strong>2）事务补偿</strong></p><ul><li>对没有commit或rollback的事务消息（pending状态的消息），从服务端发起一次<code>回查</code>；</li><li>producer收到回查消息， 检查回查消息对应的本地事务的状态；</li><li>根据本地事务状态， 重新commit或rollback。</li></ul><p>其中， 补偿阶段用于解决消息commit或rollback发生超时或失败的情况, 此时本地事务执行状态未知, 所以需要通过<code>回查</code>来确认。</p><p><strong>3）事务消息状态</strong></p><p>事务消息共有三种状态： 提交状态，回滚状态，中间状态。</p><ul><li>TransactionStatus.CommitTransaction: 提交事务， 它允许消费者消费此消息。</li><li>TransactionStatus.RollbackTransaction: 回滚事务，它代表该消息将被删除， 不允许被消费。</li><li>TransactionStatus.Unknown: 中间状态， 它代表需要检查（回查）消息队列来确定状态。</li></ul><h4 id="4-8-2-发送事务消息"><a href="#4-8-2-发送事务消息" class="headerlink" title="4.8.2 发送事务消息"></a>4.8.2 发送事务消息</h4><p><strong>1）创建事务消息生产者</strong></p><p>使用<code>TransactionMQProducer</code>类创建生产者， 并指定唯一的ProducerGroup， 就可以设置自定义线程池来处理这些检查请求，执行本地事务后，需要根据执行结果对消息队列进行回复。回传的事务状态请参考上面介绍。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>tx<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionMQProducer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionSendResult<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ArrayBlockingQueue<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：事务消息的生产者
 * @author crysw
 * @date 2022/6/12 12:40
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 创建消息生产者</span>
        TransactionMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"txGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 定义一个线程池</span>
        ThreadPoolExecutor threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                runnable <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">"client-transaction-msg-check-thread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 生产者设置线程池,用来执行是事务请求</span>
        producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// 创建事务监听器</span>
        TransactionListener transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 生产者设置事务监听器</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动消息生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 构建事务消息</span>
            Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"txTopic"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"key"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ Tx"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送事务消息</span>
            TransactionSendResult transactionSendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> transactionSendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//        producer.shutdown();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>从console控制台可以看出，只有TagA和TagC的事务消息发送成功了，TagB的事务消息被回滚了。<br><img src="https://img-blog.csdnimg.cn/5f653ad6149745068847d1f871612e01.png#pic_center" alt="在这里插入图片描述"></p><p><strong>2）实现事务的监听接口</strong></p><p>当发送半消息成功时，使用<code>executeLocalTransaction</code>方法来执行本地事务， 它返回提交状态，回滚状态或中间状态之一。</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>tx<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>LocalTransactionState<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>TransactionListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：事务监听器
 * @author crysw
 * @date 2022/6/12 13:16
 * @version 1.0
 * @see TransactionListener#executeLocalTransaction(Message, Object) 执行本地事务并返回事务执行状态
 * @see TransactionListener#checkLocalTransaction(MessageExt) 上面方法本地事务执行状态返回未知时, 执行该方法进行本地事务状态回查
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 回调操作方法, 消息预提交就会触发该方法的执行, 用于完成本地事务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"预提交消息成功: "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 假设接收到TagA的消息就表示提交成功, TagB的消息表示提交失败, TagC表示提交状态未知, 需要执行消息回查</span>
        String tag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"TagA"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"TagB"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"TagC"</span><span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 消息事务状态回查方法, 引发消息回查的原因最常见的有两个: 1) 回调操作返回UNKNOW 2) TC没有接收到TM的最终全局事务确认命令</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>MessageExt messageExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 模拟回查事务状态成功, 返回提交事务</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息Tag: "</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>3) 创建事务消息消费者</strong></p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>crysw<span class="token punctuation">.</span>bootrocketmq<span class="token punctuation">.</span>tx<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>DefaultMQPushConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>ConsumeConcurrentlyStatus<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>MQClientException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span>MessageExt<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述：事务消息的消费者
 * @author crysw
 * @date 2022/6/12 13:00
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"txGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"rocketmq-nameserver1:9876;rocketmq-nameserver2:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 订阅主题</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"txTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册监听器, 回调函数处理消息</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> messageExts<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            messageExts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>messageExt <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"MsgID: "</span> <span class="token operator">+</span> messageExt<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", body: "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动消费者</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者启动了...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>从消费者的消费日志看出， 只有TagA和TagC的事务消息被成功消费。</p><pre class="language-bash"><code class="language-bash">消费者启动了<span class="token punctuation">..</span><span class="token punctuation">..</span>
MsgID: 7F0000014FF818B4AAC23DC9D08C0002, body: Hello RocketMQ Tx2 <span class="token comment" spellcheck="true"># Tx2 -》 TagC</span>
MsgID: 7F0000014FF818B4AAC23DC9C8920000, body: Hello RocketMQ Tx0 <span class="token comment" spellcheck="true"># Tx0 -》 TagA</span>
</code></pre><h4 id="4-8-3-使用限制"><a href="#4-8-3-使用限制" class="headerlink" title="4.8.3 使用限制"></a>4.8.3 使用限制</h4><ul><li>事务消息不支持延时消息和批量消息；</li><li>为了避免单个消息被检查太多次而导致半队列消息累积， 我们默认将单个消息的检查次数限制为15次， 但是用户可以通过Broker配置文件的<code>transactionCheckMax</code>参数来修改此限制。 如果检查某条消息已经超过transactionCheckMax次，那么Broker将丢弃此消息， 并在默认情况下同时打印错误日志，用户可以通过重写<code>AbstractTransactionCheckListener</code>类来修改这个行为。</li><li>事务消息将在Broker配置文件中的参数<code>transactionMsgTimeout</code>这个特定时间之后被检查， 当发送事务消息时，用户还可以通过设置用户属性<code>CHECK_IMMUNITY_TIME_IN_SECONDS</code>来修改这个限制， 该参数优先于<code>transactionMsgTimeout</code>参数。</li><li>事务性消息可能不止一次被检查或消费（因为存在回滚后再提交的情况），对于事务消息要做好幂等性检查。</li><li>提交给用户的目标主题消息可能会失败，目前需要依据日志的记录而定。 它的高可用性通过RocketMQ本身的高可用性机制来保证， 如果希望确保事务消息不丢失， 并且事务完整性得到保证， 建议使用同步的双写机制。</li><li>事务消息的生产者ID不能与其他类型消息的生产者ID共享，与其他类型的消息不同， 事务消息允许反向查询，MQ服务器能通过它们的生产者ID查询到消费者。</li></ul><h2 id="5-遇到的问题"><a href="#5-遇到的问题" class="headerlink" title="5. 遇到的问题"></a>5. 遇到的问题</h2><h3 id="5-1-broker集群启动失败"><a href="#5-1-broker集群启动失败" class="headerlink" title="5.1 broker集群启动失败"></a>5.1 broker集群启动失败</h3><h4 id="5-1-1-问题现象"><a href="#5-1-1-问题现象" class="headerlink" title="5.1.1 问题现象"></a>5.1.1 问题现象</h4><p>在启动broker集群时， 发现只能成功启动一台。 比如启动了Master1，但是Slave2每次启动都会报错，<code>broker.log</code> 报错信息如下：</p><pre class="language-bash"><code class="language-bash">2022-06-12 23:13:45 WARN ShutdownHook - unregisterBroker Exception, rocketmq-nameserver2:9876
org.apache.rocketmq.remoting.exception.RemotingConnectException: connect to rocketmq-nameserver2:9876 failed <span class="token comment" spellcheck="true"># 异常</span>
        at org.apache.rocketmq.remoting.netty.NettyRemotingClient.invokeSync<span class="token punctuation">(</span>NettyRemotingClient.java:407<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.out.BrokerOuterAPI.unregisterBroker<span class="token punctuation">(</span>BrokerOuterAPI.java:247<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.out.BrokerOuterAPI.unregisterBrokerAll<span class="token punctuation">(</span>BrokerOuterAPI.java:224<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.unregisterBrokerAll<span class="token punctuation">(</span>BrokerController.java:861<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.shutdown<span class="token punctuation">(</span>BrokerController.java:796<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup<span class="token variable">$1</span>.run<span class="token punctuation">(</span>BrokerStartup.java:237<span class="token punctuation">)</span>
        at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span>
2022-06-12 23:13:45 WARN ShutdownHook - unregisterBroker Exception, rocketmq-nameserver1:9876 <span class="token comment" spellcheck="true"># 异常</span>
org.apache.rocketmq.remoting.exception.RemotingConnectException: connect to rocketmq-nameserver1:9876 failed
        at org.apache.rocketmq.remoting.netty.NettyRemotingClient.invokeSync<span class="token punctuation">(</span>NettyRemotingClient.java:407<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.out.BrokerOuterAPI.unregisterBroker<span class="token punctuation">(</span>BrokerOuterAPI.java:247<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.out.BrokerOuterAPI.unregisterBrokerAll<span class="token punctuation">(</span>BrokerOuterAPI.java:224<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.unregisterBrokerAll<span class="token punctuation">(</span>BrokerController.java:861<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.shutdown<span class="token punctuation">(</span>BrokerController.java:796<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup<span class="token variable">$1</span>.run<span class="token punctuation">(</span>BrokerStartup.java:237<span class="token punctuation">)</span>
        at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span>
</code></pre><p>这个报错比较坑，会让我们抓住<code>connect to rocketmq-nameserver2:9876 failed</code>异常信息去找解决方案，网上关于这个问题的解决方案没有什么意义，因为造成这个问题的本质原因不在这个日志中，而是在执行启动命令目录下的<code>nohup.out</code>日志文件中，<code>connect to rocketmq-nameserver2:9876 failed</code>对应的问题日志如下！ 查看nohup.out文件的报错信息：</p><pre class="language-bash"><code class="language-bash">The broker<span class="token punctuation">[</span>broker-a, 192.168.65.129:10911<span class="token punctuation">]</span> boot success. serializeType<span class="token operator">=</span>JSON and name server is rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
java.lang.RuntimeException: Lock failed,MQ already started
        at org.apache.rocketmq.store.DefaultMessageStore.start<span class="token punctuation">(</span>DefaultMessageStore.java:239<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.start<span class="token punctuation">(</span>BrokerController.java:874<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup.start<span class="token punctuation">(</span>BrokerStartup.java:63<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup.main<span class="token punctuation">(</span>BrokerStartup.java:57<span class="token punctuation">)</span>
java.lang.RuntimeException: Lock failed,MQ already started
        at org.apache.rocketmq.store.DefaultMessageStore.start<span class="token punctuation">(</span>DefaultMessageStore.java:239<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerController.start<span class="token punctuation">(</span>BrokerController.java:874<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup.start<span class="token punctuation">(</span>BrokerStartup.java:63<span class="token punctuation">)</span>
        at org.apache.rocketmq.broker.BrokerStartup.main<span class="token punctuation">(</span>BrokerStartup.java:57<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> 64-Bit Server VM warning: Using the DefNew young collector with the CMS collector is deprecated and will likely be removed <span class="token keyword">in</span> a future release
</code></pre><h4 id="5-1-2-问题原因"><a href="#5-1-2-问题原因" class="headerlink" title="5.1.2 问题原因"></a>5.1.2 问题原因</h4><p>根据<code>java.lang.RuntimeException: Lock failed,MQ already started</code>报错就会找到storePath的配置问题，这个也就是消息存储路径的问题，一台机器中部署master和salve的时候使用的是同一个消息存储文件，Master启动时导致文件被锁住，Slave再启动的时候去写这个存储文件就报错了，导致启动失败。</p><h4 id="5-1-3-解决方案"><a href="#5-1-3-解决方案" class="headerlink" title="5.1.3 解决方案"></a>5.1.3 解决方案</h4><p>给slave的配置文件<code>broker-b-s.properties</code>中重新配置一套消息存储路径。</p><pre class="language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 存储路径</span>
<span class="token attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1</span>
<span class="token comment" spellcheck="true"># commitLog存储路径</span>
<span class="token attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1/commitLog</span>
<span class="token comment" spellcheck="true"># 消息队列存储路径</span>
<span class="token attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1/consumequeue</span>
<span class="token comment" spellcheck="true"># 消息索引存储路径</span>
<span class="token attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1/index</span>
<span class="token comment" spellcheck="true"># checkpoint 文件存储路径</span>
<span class="token attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1/checkpoint</span>
<span class="token comment" spellcheck="true"># abort文件存储路径</span>
<span class="token attr-name">abortFile</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/rocketmq-4.9.3/store1/abort</span>
</code></pre><p>重新启动namesrv, broker（Master，Slave）正常。</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 2m-2s-sync<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep broker</span>
root       5232   5170  0 23:07 pts/1    00:00:00 <span class="token function">tail</span> -f broker.log
root       6030   3911  0 23:20 pts/0    00:00:00 sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties
root       6031   6030  0 23:20 pts/0    00:00:00 sh /usr/local/rocketmq-4.9.3/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties <span class="token comment" spellcheck="true"># Master1</span>
root       6055   6031 38 23:20 pts/0    00:05:24 /usr/local/jdk1.8.0_141/bin/java -server -Xms256m -Xmx256m -XX:+UseG1GC -XX:G1HeapRegionSize<span class="token operator">=</span>16m -XX:G1ReservePercent<span class="token operator">=</span>25 -XX:InitiatingHeapOccupancyPercent<span class="token operator">=</span>30 -XX:SoftRefLRUPolicyMSPerMB<span class="token operator">=</span>0 -verbose:gc -Xloggc:/dev/shm/rmq_srv_gc_%p_%t.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles<span class="token operator">=</span>5 -XX:GCLogFileSize<span class="token operator">=</span>30m -XX:-OmitStackTraceInFastThrow -XX:+AlwaysPreTouch -XX:MaxDirectMemorySize<span class="token operator">=</span>15g -XX:-UseLargePages -XX:-UseBiasedLocking -cp .:/usr/local/rocketmq-4.9.3/bin/<span class="token punctuation">..</span>/conf:/usr/local/rocketmq-4.9.3/bin/<span class="token punctuation">..</span>/lib/*:.:/usr/local/jdk1.8.0_141/jre/lib/rt.jar:/usr/local/jdk1.8.0_141/lib/dt.jar:/usr/local/jdk1.8.0_141/lib/tools.jar:/usr/local/jdk1.8.0_141/jre/lib org.apache.rocketmq.broker.BrokerStartup -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-a.properties
root       6144   3911  0 23:21 pts/0    00:00:00 sh mqbroker -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties
root       6145   6144  0 23:21 pts/0    00:00:00 sh /usr/local/rocketmq-4.9.3/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties <span class="token comment" spellcheck="true"># Slave2</span>
root       6169   6145 25 23:21 pts/0    00:03:37 /usr/local/jdk1.8.0_141/bin/java -server -Xms256m -Xmx256m -XX:+UseG1GC -XX:G1HeapRegionSize<span class="token operator">=</span>16m -XX:G1ReservePercent<span class="token operator">=</span>25 -XX:InitiatingHeapOccupancyPercent<span class="token operator">=</span>30 -XX:SoftRefLRUPolicyMSPerMB<span class="token operator">=</span>0 -verbose:gc -Xloggc:/dev/shm/rmq_srv_gc_%p_%t.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles<span class="token operator">=</span>5 -XX:GCLogFileSize<span class="token operator">=</span>30m -XX:-OmitStackTraceInFastThrow -XX:+AlwaysPreTouch -XX:MaxDirectMemorySize<span class="token operator">=</span>15g -XX:-UseLargePages -XX:-UseBiasedLocking -cp .:/usr/local/rocketmq-4.9.3/bin/<span class="token punctuation">..</span>/conf:/usr/local/rocketmq-4.9.3/bin/<span class="token punctuation">..</span>/lib/*:.:/usr/local/jdk1.8.0_141/jre/lib/rt.jar:/usr/local/jdk1.8.0_141/lib/dt.jar:/usr/local/jdk1.8.0_141/lib/tools.jar:/usr/local/jdk1.8.0_141/jre/lib org.apache.rocketmq.broker.BrokerStartup -c /usr/local/rocketmq-4.9.3/conf/2m-2s-sync/broker-b-s.properties
</code></pre><p>console控制台也可以看到成功启动了Master1，Slave2，Master2和Slave1四台Broker集群服务。<br><img src="https://img-blog.csdnimg.cn/cf90df717fd24611ad62bbda7251aaec.png#pic_center" alt="在这里插入图片描述"></p><h3 id="5-2-发送消息失败"><a href="#5-2-发送消息失败" class="headerlink" title="5.2 发送消息失败"></a>5.2 发送消息失败</h3><h4 id="5-2-1-问题现象"><a href="#5-2-1-问题现象" class="headerlink" title="5.2.1 问题现象"></a>5.2.1 问题现象</h4><p>双主双从集群，在使用同步模式下，在向 master 发送消息时，返回的消息状态码为 <code>SLAVE_NOT_AVAILABLE</code>.</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># sendStatus=SLAVE_NOT_AVAILABLE</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000120C418B4AAC242AB05670000, offsetMsgId<span class="token operator">=</span>null, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>txTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>2<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>34<span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000120C418B4AAC242AB09630001, offsetMsgId<span class="token operator">=</span>null, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>txTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>3<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>35<span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SLAVE_NOT_AVAILABLE, msgId<span class="token operator">=</span>7F00000120C418B4AAC242AB0D560002, offsetMsgId<span class="token operator">=</span>null, messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>txTopic, brokerName<span class="token operator">=</span>broker-a, queueId<span class="token operator">=</span>0<span class="token punctuation">]</span>, queueOffset<span class="token operator">=</span>36<span class="token punctuation">]</span>
</code></pre><h4 id="5-2-2-原因分析及解决方案"><a href="#5-2-2-原因分析及解决方案" class="headerlink" title="5.2.2 原因分析及解决方案"></a>5.2.2 原因分析及解决方案</h4><p><strong>原因分析：</strong></p><p>检查了双主双从的broker集群，都已经正常启动。查阅相关资料发现了可能导致失败的问题。没有开放Master到Slave同步消息的端口，导致消息发送失败。</p><p>使用 <code>netstat -ntpl</code>命令查看使用到的端口，可以看到java相关的进程端口<code>10909、10911、10912、11009、11011、11012、9876</code>。</p><pre class="language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7-01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -ntpl</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      596/rpcbind
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      955/sshd
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1235/master
tcp6       0      0 :::10909                :::*                    LISTEN      1622/java
tcp6       0      0 :::10911                :::*                    LISTEN      1622/java
tcp6       0      0 :::10912                :::*                    LISTEN      1622/java
tcp6       0      0 :::11009                :::*                    LISTEN      1748/java
tcp6       0      0 :::11011                :::*                    LISTEN      1748/java
tcp6       0      0 :::11012                :::*                    LISTEN      1748/java
tcp6       0      0 :::111                  :::*                    LISTEN      596/rpcbind
tcp6       0      0 :::9876                 :::*                    LISTEN      1555/java
</code></pre><p>在配置文件 <code>broker-a.properties</code> 中找到 <code>Master1</code> 配置的监听端口：</p><pre class="language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># Broker对外服务的监听端口</span>
<span class="token attr-name">listenPort</span><span class="token punctuation">=</span><span class="token attr-value">10911</span>
</code></pre><p>Master1的vip 通道端口为：<code>ListenPort - 2 = 10909</code></p><p>Master1的HA 通道端口为： <code>ListenPort + 1 = 10912</code></p><p>端口对应描述：</p><table><thead><tr><th>端口号</th><th>作用</th></tr></thead><tbody><tr><td>9876</td><td>NameServer 对外暴露的端口，允许消费者和生产者连接</td></tr><tr><td>10909</td><td>fastListen 端口, 在消费者或生产者中配置 isVipChannel 为 false 即可</td></tr><tr><td>10911</td><td>Broker对外服务的监听端口, 用于broker与producer或consumer进行通信</td></tr><tr><td>10912</td><td>HA 高可用端口，用于主从同步，为 Master 常见的 socket 连接; 若没有开放，则无法连接到 Slave</td></tr></tbody></table><p><strong>解决方案：</strong></p><p>需要检查 Master 是否打开了<code>10909、10912</code>这两个端口， 使用下面的命令查看， 我的机器确实没有开放这两个端口，开放端口权限即可。</p><pre class="language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看端口开放情况</span>
firewall-cmd --permanent --list-ports 
<span class="token comment" spellcheck="true"># 查看单个端口开放情况</span>
firewall-cmd --permanent --query-port<span class="token operator">=</span>10912/tcp
<span class="token comment" spellcheck="true"># 开放端口</span>
firewall-cmd --permanent --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span>11012/tcp
<span class="token comment" spellcheck="true"># 重启防火墙</span>
firewall-cmd --reload
</code></pre><p>同理， 查看配置文件<code>broker-b-s.properties</code>，找到<code>Slave2</code>配置的监听端口：</p><pre class="language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># Broker对外服务的监听端口</span>
<span class="token attr-name">listenPort</span><span class="token punctuation">=</span><span class="token attr-value">11011</span>
</code></pre><p>Slave2 的vip 通道端口为：<code>ListenPort - 2 = 11009</code></p><p>Slave2 的HA 通道端口为： <code>ListenPort + 1 = 11012</code></p><p>和上面一样的操作，开放<code>11009、11012</code>这两个端口。</p><p>参考博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34416331/article/details/106977960">【RocketMQ】 双主双从同步集群配置，发送消息返回状态码：SLAVE_NOT_AVAILABLE</a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">王子</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://www.crystalblog.xyz/2022062032315.html">https://www.crystalblog.xyz/2022062032315.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">王子</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid="></script><div class="addthis_inline_share_toolbox"></div></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechatPay.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(https://cdn.jsdelivr.net/gh/drew233/cdn/20200409110727.webp) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}.v[data-class="v"] .vwrap .vheader .vinput{width:32%;border-bottom:1px dashed #dedede}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine2/Valine2.min.js"></script><script>let metaPlaceholder={nick:"昵称/QQ号(必填)",mail:"邮箱(必填)",link:"网址(https://)"};new Valine({el:"#vcomments",appId:"NiVMV7aR8ipVDy9EywBYtLwI-MdYXbMMI",appKey:"P7BGA1hMeBAFbHYz3dKY8doJ",notify:!1,verify:!0,visitor:!0,avatar:"monsterid",pageSize:"10",lang:"zh-CN",placeholder:"填写QQ号就能评论，快来一发吧~",meta:["nick","mail","link"],recordIP:!0,enableQQ:"monsterid",requiredFields:["nick","mail","link"],master:["e4de1f6da602d22e423d6dfb24611b6b"],friends:["410739a5ad278251b305dab085768c57","410739a5ad278251b305dab085768c57","410739a5ad278251b305dab085768c57"],tagMeta:["博主","小伙伴","访客"],metaPlaceholder:metaPlaceholder}),document.body.addEventListener("click",function(e){if(e.target.classList.contains("vsubmit")){var a=document.querySelector("input[type=email]"),t=document.querySelector("input[name=nick]");const i=/^[A-Za-z0-9_-\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;if(!a.value||!t.value||!i.test(a.value)){const n=document.querySelector(".vmark");n.innerHTML='<div class="valert txt-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>',n.style.display="block",e.stopPropagation(),setTimeout(function(){n.style.display="none",n.innerHTML=""},2500)}}},!0)</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="far fa-dot-circle"></i>&nbsp;本篇</div><div class="card"><a href="/2022062032315.html"><div class="card-image"><img src="https://s.cn.bing.net/th?id=OHR.SwallowtailFlower_ZH-CN5950463168_1920x1080.jpg&rf=LaDigue_1920x1080.jpg" class="responsive-img" alt="RocketMQ专题01"> <span class="card-title">RocketMQ专题01</span></div></a><div class="card-content article-content"><div class="summary block-with-text">RocketMQ专题01</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-06-20 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">消息中间件</a></span></div></div><div class="card-action article-tags"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2022052432114.html"><div class="card-image"><img src="https://cn.bing.com/th?id=OHR.RedBellied_ZH-CN8667089924_1920x1080.jpg&rf=LaDigue_1920x1080.jpg" class="responsive-img" alt="深入RocketMQ原理"> <span class="card-title">深入RocketMQ原理</span></div></a><div class="card-content article-content"><div class="summary block-with-text">RocketMQ原理</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-05-24 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">消息中间件</a></span></div></div><div class="card-action article-tags"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0!==window.getSelection&&((""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: Crysw&#39;s Blog<br />文章作者: 王子<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)))})</script><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h2, h3, h4"});let t=0,e="toc-heading-";$("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h2, h3, h4").each(function(){$(this).attr("id",e+ ++t)});let n=parseInt(.4*$(window).height()-64),o=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>n?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});const i="expanded";let c=$("#toc-aside"),l=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){c.hasClass(i)?(c.removeClass(i).hide(),l.removeClass("l9")):(c.addClass(i).show(),l.addClass("l9")),function(t,e){let n=$("#"+t);if(0!==n.length){let t=n.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#"+e).width(t)}}("artDetail","prenext-posts")})})</script></main><a onclick="switchNightMode()" id="sma"><i class="fa fa-moon-o" id="nightMode" aria-hidden="true"></i></a><footer class="page-footer bg-color"><link rel="stylesheet" href="/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="tencent" type="playlist" id="7278393642" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2022</span> <i class="fa fa-heart" style="color:#ff71a8"></i> <a href="/about" target="_blank">王子</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span style="margin-left:-20px;display:inline">&nbsp; <i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">344.2k</span> <span><span id="busuanzi_container_site_pv" style="display:inline">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span> </span><span id="busuanzi_container_site_uv" style="display:inline">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),a=e.getMonth()+1,r=e.getDate(),i=e.getHours(),o=e.getMinutes(),s=e.getSeconds(),e=Date.UTC(t,"8","8","8","8","8"),a=Date.UTC(n,a,r,i,o,s)-e,r=Math.floor(a/31536e6),i=Math.floor(a/864e5-365*r),o=Math.floor(a/36e5-365*r*24-24*i),s=Math.floor(a/6e4-365*r*24*60-24*i*60-60*o),e=Math.floor(a/1e3-365*r*24*60*60-24*i*60*60-60*o*60-60*s);t===String(n)?(document.getElementById("year").innerHTML=n,a="This site has been running for "+i+" days",a="本站已运行 "+i+" 天",document.getElementById("sitetime").innerHTML=a):(document.getElementById("year").innerHTML=t+" - "+n,n="This site has been running for "+r+" years and "+i+" days",n="本站已运行 "+r+" 年 "+i+" 天 "+o+" 小时 "+s+" 分钟 "+e+" 秒",document.getElementById("sitetime").innerHTML=n)},timer=setInterval(calcSiteTime)</script>&nbsp;|&nbsp; <span id="icp"><img src="/medias/icp.png" style="vertical-align:text-bottom"> <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备20002108号</a></span></span></div><div class="col s12 m4 l4 social-link social-statis"><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1848276756" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1848276756" data-position="top" data-delay="50"><i class="fab fa-qq"></i> </a><a href="mailto:wang-qz@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我: wang-qz@foxmail.com" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="https://gitee.com/wang-qz" class="tooltipped" target="_blank" data-tooltip="码云" data-position="top" data-delay="50"><i class="fab fa-github-alt"></i> </a><a href="https://blog.csdn.net/u013044713" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN" data-position="top" data-delay="50"><i class="fab fa-csdn">C</i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script>let _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?147475454185ebcf440a27cc35e793ef";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">$(function(){!function(t,r,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),t=document.getElementById(r),n=document.getElementById(s);t.addEventListener("input",function(){var o='<ul class="search-result-list">',h=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n,e,r,s=!0,i=t.title.trim().toLowerCase(),l=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),a=0===(a=t.url).indexOf("/")?t.url:"/"+a,c=-1,u=-1;""!==i&&""!==l&&h.forEach(function(t,e){n=i.indexOf(t),c=l.indexOf(t),n<0&&c<0?s=!1:(c<0&&(c=0),0===e&&(u=c))}),s&&(o+="<li><a href='"+a+"' class='search-result-title'>"+i+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=u&&(a=u+80,(a=0===(t=(t=u-20)<0?0:t)?100:a)>e.length&&(a=e.length),r=e.substr(t,a),h.forEach(function(t){var e=new RegExp(t,"gi");r=r.replace(e,'<em class="search-keyword">'+t+"</em>")}),o+='<p class="search-result">'+r+"...</p>"),o+="</li>")}),o+="</ul>",n.innerHTML=o)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script src="/js/funnyTitle.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript" color="0,0,255" pointcolor="0,0,255" opacity="0.7" zindex="-1" count="99" src="/libs/background/canvas-nest.js"></script><script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script src="/js/wenzi.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/miku.model.json"},display:{position:"right",width:150,height:190,hOffset:50,vOffset:-5},mobile:{show:!1,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html>